C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE HAL_USB
OBJECT MODULE PLACED IN .\hal_usb.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\..\hal\nrf24lu1p\hal_usb.c LARGE BROWSE INCDIR(..\usb_rx;..\..\compiler\
                    -c51;..\..\hal\nrf24lu1p;..\..\hal\nrf24l01p) DEFINE(MCU_NRF24LU1P) DEBUG OBJECTEXTEND CODE LISTINCLUDE SYMBOLS PRINT(.\h
                    -al_usb.lst) PREPRINT(.\hal_usb.i) OBJECT(.\hal_usb.obj)

line level    source

   1          /* Copyright (c) 2009 Nordic Semiconductor. All Rights Reserved.
   2           *
   3           * The information contained herein is confidential property of Nordic 
   4           * Semiconductor ASA.Terms and conditions of usage are described in detail 
   5           * in NORDIC SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT. 
   6           *
   7           * Licensees are granted free, non-transferable use of the information. NO
   8           * WARRENTY of ANY KIND is provided. This heading must NOT be removed from
   9           * the file.
  10           *              
  11           * $LastChangedRevision: 5717 $
  12           */
  13          
  14          /** @file
  15          * @brief Implementaion of the USB HAL
  16           */
  17          #include <Nordic\reg24lu1.h>
   1      =1  /*--------------------------------------------------------------------------
   2      =1   * reg24lu1.h
   3      =1   *
   4      =1   * Keil C51 header file for the Nordic Semiconductor nRF24LU1 2.4GHz RF
   5      =1   * transceiver with embedded 8051 compatible microcontroller and USB.
   6      =1   *
   7      =1   *
   8      =1   *------------------------------------------------------------------------*/
   9      =1  #ifndef __REG24LU1_H__
  10      =1  #define __REG24LU1_H__
  11      =1  
  12      =1  //-----------------------------------------------------------------------------
  13      =1  // Byte Registers
  14      =1  //-----------------------------------------------------------------------------
  15      =1  
  16      =1  sfr   P0           = 0x80;
  17      =1  sfr   SP           = 0x81;
  18      =1  sfr   DPL          = 0x82;
  19      =1  sfr   DPH          = 0x83;
  20      =1  sfr   DPL1         = 0x84;
  21      =1  sfr   DPH1         = 0x85;
  22      =1  sfr   PCON         = 0x87;
  23      =1  sfr   TCON         = 0x88;
  24      =1  sfr   TMOD         = 0x89;
  25      =1  sfr   TL0          = 0x8A;
  26      =1  sfr   TL1          = 0x8B;
  27      =1  sfr   TH0          = 0x8C;
  28      =1  sfr   TH1          = 0x8D;
  29      =1  sfr   CKCON        = 0x8E;
  30      =1  sfr   RFCON        = 0x90;
  31      =1  sfr   DPS          = 0x92;
  32      =1  sfr   P0DIR        = 0x94;
  33      =1  sfr   P0ALT        = 0x95;
  34      =1  sfr   S0CON        = 0x98;
  35      =1  sfr   S0BUF        = 0x99;
  36      =1  sfr   IEN2         = 0x9A;
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 2   

  37      =1  sfr   USBCON       = 0xA0;
  38      =1  sfr   CLKCTL       = 0xA3;
  39      =1  sfr   PWRDWN       = 0xA4;
  40      =1  sfr   WUCONF       = 0xA5;
  41      =1  sfr   INTEXP       = 0xA6;
  42      =1  sfr   IEN0         = 0xA8;
  43      =1  sfr   IP0          = 0xA9;
  44      =1  sfr   S0RELL       = 0xAA;
  45      =1  sfr   REGXH        = 0xAB;
  46      =1  sfr   REGXL        = 0xAC;
  47      =1  sfr   REGXC        = 0xAD;
  48      =1  sfr   RSTRES       = 0xB1;
  49      =1  sfr   SMDAT        = 0xB2;
  50      =1  sfr   SMCTL        = 0xB3;
  51      =1  sfr   TICKDV       = 0xB5;
  52      =1  sfr   IEN1         = 0xB8;
  53      =1  sfr   IP1          = 0xB9;
  54      =1  sfr   S0RELH       = 0xBA;
  55      =1  sfr   SSCONF       = 0xBC;
  56      =1  sfr   SSDATA       = 0xBD;
  57      =1  sfr   SSSTAT       = 0xBE;
  58      =1  sfr   IRCON        = 0xC0;
  59      =1  sfr   CCEN         = 0xC1;
  60      =1  sfr   CCL1         = 0xC2;
  61      =1  sfr   CCH1         = 0xC3;
  62      =1  sfr   CCL2         = 0xC4;
  63      =1  sfr   CCH2         = 0xC5;
  64      =1  sfr   CCL3         = 0xC6;
  65      =1  sfr   CCH3         = 0xC7;
  66      =1  sfr   T2CON        = 0xC8;
  67      =1  sfr   P0EXP        = 0xC9;
  68      =1  sfr   CRCL         = 0xCA;
  69      =1  sfr   CRCH         = 0xCB;
  70      =1  sfr   TL2          = 0xCC;
  71      =1  sfr   TH2          = 0xCD;
  72      =1  sfr   PSW          = 0xD0;
  73      =1  sfr   WDCON        = 0xD8;
  74      =1  sfr   USBSLP       = 0xD9;
  75      =1  sfr   ACC          = 0xE0;
  76      =1  sfr   RFDAT        = 0xE5;
  77      =1  sfr   RFCTL        = 0xE6;
  78      =1  sfr   AESCS        = 0xE8;
  79      =1  sfr   MD0          = 0xE9;
  80      =1  sfr   MD1          = 0xEA;
  81      =1  sfr   MD2          = 0xEB;
  82      =1  sfr   MD3          = 0xEC;
  83      =1  sfr   MD4          = 0xED;
  84      =1  sfr   MD5          = 0xEE;
  85      =1  sfr   ARCON        = 0xEF;
  86      =1  sfr   B            = 0xF0;
  87      =1  sfr   AESKIN       = 0xF1;
  88      =1  sfr   AESIV        = 0xF2;
  89      =1  sfr   AESD         = 0xF3;
  90      =1  sfr   AESIA1       = 0xF5;
  91      =1  sfr   AESIA2       = 0xF6;
  92      =1  sfr   FSR          = 0xF8;
  93      =1  sfr   FPCR         = 0xF9;
  94      =1  sfr   FCR          = 0xFA;
  95      =1  
  96      =1  //-----------------------------------------------------------------------------
  97      =1  // Word Registers
  98      =1  //-----------------------------------------------------------------------------
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 3   

  99      =1  
 100      =1  sfr16 CC1          = 0xC2;
 101      =1  sfr16 CC2          = 0xC4;
 102      =1  sfr16 CC3          = 0xC6;
 103      =1  sfr16 CRC          = 0xCA;
 104      =1  sfr16 T2           = 0xCC;
 105      =1  
 106      =1  //-----------------------------------------------------------------------------
 107      =1  /* Lint uses a trick (see co-kc51.lnt) where sbit gets treated like (expanded to) a bool.
 108      =1     This causes errors due to the strong type checking of _Bool (and thereby bool) that
 109      =1     is turned on in our implementation of stdbool.h.
 110      =1     Therefore, we suppress Lint warning 18 ("Redeclaration") for the sbit-s declared in this file.
 111      =1  */
 112      =1  
 113      =1  /*lint -e18 */
 114      =1  //-----------------------------------------------------------------------------
 115      =1  
 116      =1  //-----------------------------------------------------------------------------
 117      =1  // Bit Definitions
 118      =1  //-----------------------------------------------------------------------------
 119      =1  
 120      =1  /*  FSR  */
 121      =1  sbit  MCDIS        = FSR^7;
 122      =1  sbit  STP          = FSR^6;
 123      =1  sbit  WEN          = FSR^5;
 124      =1  sbit  RDYN         = FSR^4;
 125      =1  sbit  INFEN        = FSR^3;
 126      =1  sbit  RDIS         = FSR^2;
 127      =1  sbit  RDEND        = FSR^1;
 128      =1  sbit  WPEN         = FSR^0;
 129      =1  
 130      =1  /*  PSW   */
 131      =1  sbit  CY           = PSW^7;
 132      =1  sbit  AC           = PSW^6;
 133      =1  sbit  F0           = PSW^5;
 134      =1  sbit  RS1          = PSW^4;
 135      =1  sbit  RS0          = PSW^3;
 136      =1  sbit  OV           = PSW^2;
 137      =1  sbit  F1           = PSW^1;
 138      =1  sbit  P            = PSW^0;
 139      =1  
 140      =1  /*  TCON  */
 141      =1  sbit  TF1          = TCON^7;
 142      =1  sbit  TR1          = TCON^6;
 143      =1  sbit  TF0          = TCON^5;
 144      =1  sbit  TR0          = TCON^4;
 145      =1  sbit  IE1          = TCON^3;
 146      =1  sbit  IT1          = TCON^2;
 147      =1  sbit  IE0          = TCON^1;
 148      =1  sbit  IT0          = TCON^0;
 149      =1  
 150      =1  /*  S0CON  */
 151      =1  sbit  SM0          = S0CON^7;
 152      =1  sbit  SM1          = S0CON^6;
 153      =1  sbit  SM20         = S0CON^5;
 154      =1  sbit  REN0         = S0CON^4;
 155      =1  sbit  TB80         = S0CON^3;
 156      =1  sbit  RB80         = S0CON^2;
 157      =1  sbit  TI0          = S0CON^1;
 158      =1  sbit  RI0          = S0CON^0;
 159      =1  
 160      =1  /*  T2CON  */
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 4   

 161      =1  sbit  T2PS         = T2CON^7;
 162      =1  sbit  I3FR         = T2CON^6;
 163      =1  sbit  I2FR         = T2CON^5;
 164      =1  sbit  T2R1         = T2CON^4;
 165      =1  sbit  T2R0         = T2CON^3;
 166      =1  sbit  T2CM         = T2CON^2;
 167      =1  sbit  T2I1         = T2CON^1;
 168      =1  sbit  T2I0         = T2CON^0;
 169      =1  
 170      =1  /*  IEN0  */
 171      =1  sbit  EA           = IEN0^7;
 172      =1  
 173      =1  sbit  ET2          = IEN0^5;
 174      =1  sbit  ES0          = IEN0^4;
 175      =1  sbit  ET1          = IEN0^3;
 176      =1  sbit  EX1          = IEN0^2;
 177      =1  sbit  ET0          = IEN0^1;
 178      =1  sbit  EX0          = IEN0^0;
 179      =1  
 180      =1  /* IEN1  */
 181      =1  sbit  EXEN2        = IEN1^7;
 182      =1  
 183      =1  sbit  WUIRQ        = IEN1^5;
 184      =1  sbit  USB          = IEN1^4;
 185      =1  sbit  USBWU        = IEN1^3;
 186      =1  sbit  SPI          = IEN1^2;
 187      =1  sbit  RF           = IEN1^1;
 188      =1  sbit  RFSPI        = IEN1^0;
 189      =1  
 190      =1  /* IRCON */
 191      =1  sbit  EXF2         = IRCON^7;
 192      =1  sbit  TF2          = IRCON^6;
 193      =1  sbit  WUF          = IRCON^5;
 194      =1  sbit  USBF         = IRCON^4;
 195      =1  sbit  USBWUF       = IRCON^3;
 196      =1  sbit  SPIF         = IRCON^2;
 197      =1  sbit  RFF          = IRCON^1;
 198      =1  sbit  RFSPIF       = IRCON^0;
 199      =1  
 200      =1  /* USBCON */
 201      =1  sbit  SWRST        = USBCON^7;
 202      =1  sbit  WU           = USBCON^6;
 203      =1  sbit  SUSPEND      = USBCON^5;
 204      =1  sbit  IV4          = USBCON^4;
 205      =1  sbit  IV3          = USBCON^3;
 206      =1  sbit  IV2          = USBCON^2;
 207      =1  sbit  IV1          = USBCON^1;
 208      =1  sbit  IV0          = USBCON^0;
 209      =1  
 210      =1  /* PORT0 */
 211      =1  sbit  P00          = P0^0;
 212      =1  sbit  P01          = P0^1;
 213      =1  sbit  P02          = P0^2;
 214      =1  sbit  P03          = P0^3;
 215      =1  sbit  MCSN         = P0^3;
 216      =1  sbit  SCSN         = P0^3;
 217      =1  sbit  P04          = P0^4;
 218      =1  sbit  P05          = P0^5;
 219      =1  
 220      =1  /* RFCON */
 221      =1  sbit  RFCE         = RFCON^0;
 222      =1  sbit  RFCSN        = RFCON^1;
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 5   

 223      =1  sbit  RFCKEN       = RFCON^2;
 224      =1  
 225      =1  /* WDCON */
 226      =1  sbit  BD           = WDCON^7;
 227      =1  
 228      =1  /* AESCS */
 229      =1  sbit  GO           = AESCS^0;
 230      =1  sbit  DECR         = AESCS^1;
 231      =1  
 232      =1  /*lint +e18 */  /* Re-enable Lint warning 18 */
 233      =1  
 234      =1  
 235      =1  /* REGX commands */
 236      =1  #define RWD         0x00
 237      =1  #define WWD         0x08
 238      =1  #define RGTIMER     0x01
 239      =1  #define WGTIMER     0x09
 240      =1  #define RRTCLAT     0x02
 241      =1  #define WRTCLAT     0x0A
 242      =1  #define RRTC        0x03
 243      =1  #define WRTCDIS     0x0B
 244      =1  #define RWSTA0      0x04
 245      =1  #define WWCON0      0x0C
 246      =1  #define RWSTA1      0x05
 247      =1  #define WWCON1      0x0D
 248      =1  
 249      =1  //-----------------------------------------------------------------------------
 250      =1  // Interrupt Vector Definitions
 251      =1  //-----------------------------------------------------------------------------
 252      =1  
 253      =1  #define INTERRUPT_EXT_INT0     0   // External Interrupt0 (P0.3)
 254      =1  #define INTERRUPT_T0           1   // Timer0 Overflow
 255      =1  #define INTERRUPT_AES_RDY      2   // AES ready interrupt
 256      =1  #define INTERRUPT_T1           3   // Timer1 Overflow
 257      =1  #define INTERRUPT_UART0        4   // UART0, Receive & Transmitt interrupt
 258      =1  #define INTERRUPT_T2           5   // Timer2 Overflow
 259      =1  #define INTERRUPT_RF_RDY       8   // RF SPI ready interrupt
 260      =1  #define INTERRUPT_RFIRQ        9   // RF interrupt
 261      =1  #define INTERRUPT_SPI          10  // SPI interrupt
 262      =1  #define INTERRUPT_USB_WU       11  // USB wakeup interrupt
 263      =1  #define INTERRUPT_USB_INT      12  // USB interrupt
 264      =1  #define INTERRUPT_WU           13  // Internal wakeup interrupt
 265      =1  
 266      =1  //-----------------------------------------------------------------------------
 267      =1  // Header File Preprocessor Directive
 268      =1  //-----------------------------------------------------------------------------
 269      =1  
 270      =1  #endif
  18          #include <intrins.h>
   1      =1  /*--------------------------------------------------------------------------
   2      =1  INTRINS.H
   3      =1  
   4      =1  Intrinsic functions for C51.
   5      =1  Copyright (c) 1988-2010 Keil Elektronik GmbH and ARM Germany GmbH
   6      =1  All rights reserved.
   7      =1  --------------------------------------------------------------------------*/
   8      =1  
   9      =1  #ifndef __INTRINS_H__
  10      =1  #define __INTRINS_H__
  11      =1  
  12      =1  extern void          _nop_     (void);
  13      =1  extern bit           _testbit_ (bit);
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 6   

  14      =1  extern unsigned char _cror_    (unsigned char, unsigned char);
  15      =1  extern unsigned int  _iror_    (unsigned int,  unsigned char);
  16      =1  extern unsigned long _lror_    (unsigned long, unsigned char);
  17      =1  extern unsigned char _crol_    (unsigned char, unsigned char);
  18      =1  extern unsigned int  _irol_    (unsigned int,  unsigned char);
  19      =1  extern unsigned long _lrol_    (unsigned long, unsigned char);
  20      =1  extern unsigned char _chkfloat_(float);
  21      =1  #if !defined (__CX2__)
  22      =1  extern void          _push_    (unsigned char _sfr);
  23      =1  extern void          _pop_     (unsigned char _sfr);
  24      =1  #endif
  25      =1  
  26      =1  #endif
  27      =1  
  19          #include <stdint.h>
   1      =1  /* Copyright (c) 2007 Nordic Semiconductor. All Rights Reserved.
   2      =1   *
   3      =1   * The information contained herein is property of Nordic Semiconductor ASA.
   4      =1   * Terms and conditions of usage are described in detail in NORDIC
   5      =1   * SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT. 
   6      =1   *
   7      =1   * Licensees are granted free, non-transferable use of the information. NO
   8      =1   * WARRENTY of ANY KIND is provided. This heading must NOT be removed from
   9      =1   * the file.
  10      =1   *
  11      =1   * $LastChangedRevision: 4726 $
  12      =1   */
  13      =1  
  14      =1  /** @file
  15      =1   * Type definitions for firmware projects developed at Nordic semiconductor.
  16      =1   *
  17      =1   * Standard storage classes in C, such as @c char, @c int, and @c long, ar not always
  18      =1   * interpreted in the same way by the compiler. The types here are defined by their
  19      =1   * bit length and signed/unsigned property, as their name indicate. The correlation
  20      =1   * between the name and properties of the storage class should be true, regardless of
  21      =1   * the compiler being used.
  22      =1   */
  23      =1  
  24      =1  #ifndef __STDINT_H__
  25      =1  #define __STDINT_H__
  26      =1  
  27      =1  #ifdef __C51__
  28      =1  
  29      =1  typedef unsigned char uint8_t;        ///< 8 bit unsigned int
  30      =1  
  31      =1  typedef signed char int8_t;          ///< 8 bit signed int
  32      =1  
  33      =1  typedef unsigned int uint16_t;        ///< 16 bit unsigned int
  34      =1  
  35      =1  typedef signed int int16_t;          ///< 16 bit signed int
  36      =1  
  37      =1  typedef unsigned long uint32_t;       ///< 32 bit unsigned int
  38      =1  
  39      =1  typedef signed long int32_t;         ///< 32 bit signed int
  40      =1  
  41      =1  #endif // __C51__
  42      =1  
  43      =1  #ifndef NULL
  44      =1  #define NULL (void*)0
  45      =1  #endif
  46      =1  
  47      =1  #endif // __STDINT_H__
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 7   

  20          
  21          #include "nordic_common.h"
   1      =1  /* Copyright (c) 2009 Nordic Semiconductor. All Rights Reserved.
   2      =1   *
   3      =1   * The information contained herein is confidential property of Nordic 
   4      =1   * Semiconductor ASA.Terms and conditions of usage are described in detail 
   5      =1   * in NORDIC SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT. 
   6      =1   *
   7      =1   * Licensees are granted free, non-transferable use of the information. NO
   8      =1   * WARRENTY of ANY KIND is provided. This heading must NOT be removed from
   9      =1   * the file.
  10      =1   *              
  11      =1   * $LastChangedRevision: 5756 $
  12      =1   */
  13      =1  
  14      =1  /** @file
  15      =1   * @brief Common defines and macros for firmware developed by Nordic Semiconductor.
  16      =1   *
  17      =1   */
  18      =1  
  19      =1  #ifndef NORDIC_COMMON_H__
  20      =1  #define NORDIC_COMMON_H__
  21      =1  
  22      =1  /** Swaps the upper byte with the lower byte in a 16 bit variable */
  23      =1  //lint -emacro((572),SWAP) // Suppress warning 572 "Excessive shift value"
  24      =1  #define SWAP(x) ((((x)&0xFF)<<8)|(((x)>>8)&0xFF))
  25      =1  
  26      =1  /** The upper 8 bits of a 16 bit value */
  27      =1  #define MSB(a) ((a & 0xFF00) >> 8)
  28      =1  /** The lower 8 bits (of a 16 bit value) */
  29      =1  #define LSB(a) ((a & 0xFF))
  30      =1  
  31      =1  /** Leaves the minimum of the two arguments */
  32      =1  #define MIN(a, b) ((a) < (b) ? (a) : (b))
  33      =1  /** Leaves the maximum of the two arguments */
  34      =1  #define MAX(a, b) ((a) < (b) ? (b) : (a))
  35      =1  
  36      =1  #define BIT_0 0x01 /**< The value of bit 0 */
  37      =1  #define BIT_1 0x02 /**< The value of bit 1 */
  38      =1  #define BIT_2 0x04 /**< The value of bit 2 */
  39      =1  #define BIT_3 0x08 /**< The value of bit 3 */
  40      =1  #define BIT_4 0x10 /**< The value of bit 4 */
  41      =1  #define BIT_5 0x20 /**< The value of bit 5 */
  42      =1  #define BIT_6 0x40 /**< The value of bit 6 */
  43      =1  #define BIT_7 0x80 /**< The value of bit 7 */
  44      =1  #define BIT_8 0x0100 /**< The value of bit 8 */
  45      =1  #define BIT_9 0x0200 /**< The value of bit 9 */
  46      =1  #define BIT_10 0x0400 /**< The value of bit 10 */
  47      =1  #define BIT_11 0x0800 /**< The value of bit 11 */
  48      =1  #define BIT_12 0x1000 /**< The value of bit 12 */
  49      =1  #define BIT_13 0x2000 /**< The value of bit 13 */
  50      =1  #define BIT_14 0x4000 /**< The value of bit 14 */
  51      =1  #define BIT_15 0x8000 /**< The value of bit 15 */
  52      =1  
  53      =1  
  54      =1  #endif // NORDIC_COMMON_H__
  22          #include "usb.h"
   1      =1  /* Copyright (c) 2009 Nordic Semiconductor. All Rights Reserved.
   2      =1   *
   3      =1   * The information contained herein is confidential property of Nordic 
   4      =1   * Semiconductor ASA.Terms and conditions of usage are described in detail 
   5      =1   * in NORDIC SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT. 
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 8   

   6      =1   *
   7      =1   * Licensees are granted free, non-transferable use of the information. NO
   8      =1   * WARRENTY of ANY KIND is provided. This heading must NOT be removed from
   9      =1   * the file.
  10      =1   *              
  11      =1   * $LastChangedRevision: 5717 $
  12      =1   */ 
  13      =1  
  14      =1  /** @file
  15      =1   * @brief This file contain definitions related to the USB-controller and internal structures
  16      =1   */
  17      =1  
  18      =1  #ifndef USB_H__
  19      =1  #define USB_H__
  20      =1  
  21      =1  #include <stdint.h>
   1      =2  /* Copyright (c) 2007 Nordic Semiconductor. All Rights Reserved.
   2      =2   *
   3      =2   * The information contained herein is property of Nordic Semiconductor ASA.
   4      =2   * Terms and conditions of usage are described in detail in NORDIC
   5      =2   * SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT. 
   6      =2   *
   7      =2   * Licensees are granted free, non-transferable use of the information. NO
   8      =2   * WARRENTY of ANY KIND is provided. This heading must NOT be removed from
   9      =2   * the file.
  10      =2   *
  11      =2   * $LastChangedRevision: 4726 $
  12      =2   */
  13      =2  
  14      =2  /** @file
  15      =2   * Type definitions for firmware projects developed at Nordic semiconductor.
  16      =2   *
  17      =2   * Standard storage classes in C, such as @c char, @c int, and @c long, ar not always
  18      =2   * interpreted in the same way by the compiler. The types here are defined by their
  19      =2   * bit length and signed/unsigned property, as their name indicate. The correlation
  20      =2   * between the name and properties of the storage class should be true, regardless of
  21      =2   * the compiler being used.
  22      =2   */
  23      =2  
  24      =2  #ifndef __STDINT_H__
           =2 #define __STDINT_H__
           =2 
           =2 #ifdef __C51__
           =2 
           =2 typedef unsigned char uint8_t;        ///< 8 bit unsigned int
           =2 
           =2 typedef signed char int8_t;          ///< 8 bit signed int
           =2 
           =2 typedef unsigned int uint16_t;        ///< 16 bit unsigned int
           =2 
           =2 typedef signed int int16_t;          ///< 16 bit signed int
           =2 
           =2 typedef unsigned long uint32_t;       ///< 32 bit unsigned int
           =2 
           =2 typedef signed long int32_t;         ///< 32 bit signed int
           =2 
           =2 #endif // __C51__
           =2 
           =2 #ifndef NULL
           =2 #define NULL (void*)0
           =2 #endif
           =2 
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 9   

           =2 #endif // __STDINT_H__
  22      =1  
  23      =1  #include "hal_usb.h"
   1      =2  /* Copyright (c) 2009 Nordic Semiconductor. All Rights Reserved.
   2      =2   *
   3      =2   * The information contained herein is confidential property of Nordic 
   4      =2   * Semiconductor ASA.Terms and conditions of usage are described in detail 
   5      =2   * in NORDIC SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT. 
   6      =2   *
   7      =2   * Licensees are granted free, non-transferable use of the information. NO
   8      =2   * WARRENTY of ANY KIND is provided. This heading must NOT be removed from
   9      =2   * the file.
  10      =2   *              
  11      =2   * $LastChangedRevision: 5717 $
  12      =2   */
  13      =2  
  14      =2  /** @file
  15      =2   * @brief Interface for the USB device controller.
  16      =2   *
  17      =2   * The header file must define the following type defined structs:
  18      =2   *  - hal_usb_conf_desc_templ_t
  19      =2   *  - hal_usb_string_desc_templ_t
  20      =2   *  - hal_usb_dev_desc_templ_t
  21      =2   *  .
  22      =2   * And the following global variables:
  23      =2   *  - g_usb_string_desc
  24      =2   *  - g_usb_conf_desc
  25      =2   *  - g_usb_dev_desc
  26      =2   *
  27      =2   * @defgroup hal_nrf24lu1p_hal_usb Universal Serial Bus (hal_usb)
  28      =2   * @{
  29      =2   * @ingroup hal_nrf24lu1p
  30      =2   *
  31      =2   * <h1>Control Transfer Functionality</h1>
  32      =2   *
  33      =2   * <h2>Descriptor Requests</h2>
  34      =2   * The module handles the following <b>descriptor requests</b>:
  35      =2   * - Device
  36      =2   * - Configuration
  37      =2   * - String
  38      =2   *
  39      =2   * It does <b>not</b> support (replies with STALL to USB host controller):
  40      =2   * - Interface
  41      =2   * - DeviceQual
  42      =2   * - OtherSpeedConf
  43      =2   * - InterfacePower
  44      =2   * 
  45      =2   * All other descriptor requests (HID, ...) are made available to the application code through the hal_usb
             -_cb_device_req_t callback.
  46      =2   *
  47      =2   * The module do <b>not</b> support SetDescriptor requests
  48      =2   *
  49      =2   * <h2>Feature Requests</h2>
  50      =2   *
  51      =2   * The module handles the following feature requests:
  52      =2   * -  DeviceRemoteWakeup
  53      =2   * -  EndpointHalt
  54      =2   * 
  55      =2   * It does <b>not</b> support (replies with STALL to USB host controller) any other feature requests yet
  56      =2   *
  57      =2   * <h2>Configuration Requests</h2>
  58      =2   *
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 10  

  59      =2   * The module do only support setting configuration 0 (sets the adressed state) and 1. Other configuration
             -s replies with STALL. Several configurations for a device is not implemented.
  60      =2   * 
  61      =2   * <h2>Alternative Interface Requests</h2>
  62      =2   *
  63      =2   * Setting and getting alternative interfaces are not supported (replies with STALL to USB host controller
             -)
  64      =2   * 
  65      =2   * <h2>Sync Frame Requests</h2>
  66      =2   * Not supported
  67      =2   * 
  68      =2   * <h2>Class Specific Requests</h2>
  69      =2   * All class specific requests are made available to the application code through the hal_usb_cb_device_re
             -q_t callback. 
  70      =2   *
  71      =2   * <h1>Endpoint Functionality</h1>
  72      =2   * All available IN and OUT endpoints are avialable to the application through the hal_usb_send_packet, ha
             -l_usb_receive_packet functions and the callbacks registered for the endpoint. The callback functions are called when the
             - host replies with an ACK for having received a packet or when the host has sent an OUT packet. 
  73      =2   * 
  74      =2   * Isochronos endpoints are not supported in this version of USB HAL.
  75      =2   */
  76      =2  
  77      =2  #ifndef HAL_USB_H__
  78      =2  #define HAL_USB_H__
  79      =2  
  80      =2  #include <stdint.h>
   1      =3  /* Copyright (c) 2007 Nordic Semiconductor. All Rights Reserved.
   2      =3   *
   3      =3   * The information contained herein is property of Nordic Semiconductor ASA.
   4      =3   * Terms and conditions of usage are described in detail in NORDIC
   5      =3   * SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT. 
   6      =3   *
   7      =3   * Licensees are granted free, non-transferable use of the information. NO
   8      =3   * WARRENTY of ANY KIND is provided. This heading must NOT be removed from
   9      =3   * the file.
  10      =3   *
  11      =3   * $LastChangedRevision: 4726 $
  12      =3   */
  13      =3  
  14      =3  /** @file
  15      =3   * Type definitions for firmware projects developed at Nordic semiconductor.
  16      =3   *
  17      =3   * Standard storage classes in C, such as @c char, @c int, and @c long, ar not always
  18      =3   * interpreted in the same way by the compiler. The types here are defined by their
  19      =3   * bit length and signed/unsigned property, as their name indicate. The correlation
  20      =3   * between the name and properties of the storage class should be true, regardless of
  21      =3   * the compiler being used.
  22      =3   */
  23      =3  
  24      =3  #ifndef __STDINT_H__
           =3 #define __STDINT_H__
           =3 
           =3 #ifdef __C51__
           =3 
           =3 typedef unsigned char uint8_t;        ///< 8 bit unsigned int
           =3 
           =3 typedef signed char int8_t;          ///< 8 bit signed int
           =3 
           =3 typedef unsigned int uint16_t;        ///< 16 bit unsigned int
           =3 
           =3 typedef signed int int16_t;          ///< 16 bit signed int
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 11  

           =3 
           =3 typedef unsigned long uint32_t;       ///< 32 bit unsigned int
           =3 
           =3 typedef signed long int32_t;         ///< 32 bit signed int
           =3 
           =3 #endif // __C51__
           =3 
           =3 #ifndef NULL
           =3 #define NULL (void*)0
           =3 #endif
           =3 
           =3 #endif // __STDINT_H__
  81      =2  #include <stdbool.h>
   1      =3  /* Copyright (c) 2007 Nordic Semiconductor. All Rights Reserved.
   2      =3   *
   3      =3   * The information contained herein is property of Nordic Semiconductor ASA.
   4      =3   * Terms and conditions of usage are described in detail in NORDIC
   5      =3   * SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT. 
   6      =3   *
   7      =3   * Licensees are granted free, non-transferable use of the information. NO
   8      =3   * WARRENTY of ANY KIND is provided. This heading must NOT be removed from
   9      =3   * the file.
  10      =3   *
  11      =3   * $LastChangedRevision: 4726 $
  12      =3   */
  13      =3  
  14      =3  /** @file
  15      =3   * Type definitions for firmware projects developed at Nordic semiconductor.
  16      =3   *
  17      =3   * Standard storage classes in C, such as @c char, @c int, and @c long, ar not always
  18      =3   * interpreted in the same way by the compiler. The types here are defined by their
  19      =3   * bit length and signed/unsigned property, as their name indicate. The correlation
  20      =3   * between the name and properties of the storage class should be true, regardless of
  21      =3   * the compiler being used.
  22      =3   */
  23      =3  
  24      =3  #ifndef __STDBOOL_H__
  25      =3  #define __STDBOOL_H__
  26      =3  
  27      =3  //lint -strong(B,_Bool)
  28      =3  typedef unsigned char _Bool; ///< Boolean type
  29      =3  
  30      =3  #define bool _Bool
  31      =3  #define true 1
  32      =3  #define false 0
  33      =3  #define __bool_true_false_are_defined 1
  34      =3  
  35      =3  #endif // __STDBOOL_H__
  82      =2  
  83      =2  #include "config.h" 
   1      =3  /* Copyright (c) 2009 Nordic Semiconductor. All Rights Reserved.
   2      =3   *
   3      =3   * The information contained herein is confidential property of Nordic 
   4      =3   * Semiconductor ASA.Terms and conditions of usage are described in detail 
   5      =3   * in NORDIC SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT. 
   6      =3   *
   7      =3   * Licensees are granted free, non-transferable use of the information. NO
   8      =3   * WARRENTY of ANY KIND is provided. This heading must NOT be removed from
   9      =3   * the file.
  10      =3   *              
  11      =3   * $LastChangedRevision: 5718 $
  12      =3   */
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 12  

  13      =3  
  14      =3  /** @file
  15      =3   * Configuration file for bootloader
  16      =3   *
  17      =3   */
  18      =3  #ifndef CONFIG_H__
  19      =3  #define CONFIG_H__
  20      =3  
  21      =3  #define FLASH_PAGE_SIZE     512U
  22      =3  #define MAX_PACKET_SIZE_EP0 32
  23      =3  #define USB_EP1_SIZE        64
  24      =3  #define FLASH_SIZE          (32U*1024U)
  25      =3  #define NUM_FLASH_PAGES     FLASH_SIZE/FLASH_PAGE_SIZE
  26      =3  
  27      =3  #endif // CONFIG_H__
  84      =2  #include "usb_desc_bulk.h"
   1      =3  /* Copyright (c) 2009 Nordic Semiconductor. All Rights Reserved.
   2      =3   *
   3      =3   * The information contained herein is confidential property of Nordic 
   4      =3   * Semiconductor ASA.Terms and conditions of usage are described in detail 
   5      =3   * in NORDIC SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT. 
   6      =3   *
   7      =3   * Licensees are granted free, non-transferable use of the information. NO
   8      =3   * WARRENTY of ANY KIND is provided. This heading must NOT be removed from
   9      =3   * the file.
  10      =3   *              
  11      =3   * $LastChangedRevision: 5718 $
  12      =3   */
  13      =3  
  14      =3  /** @file
  15      =3   * Header file for the Bootloader USB descriptor
  16      =3   *
  17      =3   */
  18      =3  #ifndef USB_DESC_BULK_H__
  19      =3  #define USB_DESC_BULK_H__
  20      =3  
  21      =3  #include "hal_usb_desc.h"
   1      =4  /* Copyright (c) 2009 Nordic Semiconductor. All Rights Reserved.
   2      =4   *
   3      =4   * The information contained herein is confidential property of Nordic 
   4      =4   * Semiconductor ASA.Terms and conditions of usage are described in detail 
   5      =4   * in NORDIC SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT. 
   6      =4   *
   7      =4   * Licensees are granted free, non-transferable use of the information. NO
   8      =4   * WARRENTY of ANY KIND is provided. This heading must NOT be removed from
   9      =4   * the file.
  10      =4   *              
  11      =4   * $LastChangedRevision: 5717 $
  12      =4   */
  13      =4  
  14      =4  /** @file
  15      =4  * @brief This file contain structures and constants defined in Chapter 9 of the USB 2.0 standard
  16      =4   */
  17      =4  
  18      =4  #ifndef HAL_USB_DESC_H__
  19      =4  #define HAL_USB_DESC_H__
  20      =4  
  21      =4  #include <stdint.h>
   1      =5  /* Copyright (c) 2007 Nordic Semiconductor. All Rights Reserved.
   2      =5   *
   3      =5   * The information contained herein is property of Nordic Semiconductor ASA.
   4      =5   * Terms and conditions of usage are described in detail in NORDIC
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 13  

   5      =5   * SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT. 
   6      =5   *
   7      =5   * Licensees are granted free, non-transferable use of the information. NO
   8      =5   * WARRENTY of ANY KIND is provided. This heading must NOT be removed from
   9      =5   * the file.
  10      =5   *
  11      =5   * $LastChangedRevision: 4726 $
  12      =5   */
  13      =5  
  14      =5  /** @file
  15      =5   * Type definitions for firmware projects developed at Nordic semiconductor.
  16      =5   *
  17      =5   * Standard storage classes in C, such as @c char, @c int, and @c long, ar not always
  18      =5   * interpreted in the same way by the compiler. The types here are defined by their
  19      =5   * bit length and signed/unsigned property, as their name indicate. The correlation
  20      =5   * between the name and properties of the storage class should be true, regardless of
  21      =5   * the compiler being used.
  22      =5   */
  23      =5  
  24      =5  #ifndef __STDINT_H__
           =5 #define __STDINT_H__
           =5 
           =5 #ifdef __C51__
           =5 
           =5 typedef unsigned char uint8_t;        ///< 8 bit unsigned int
           =5 
           =5 typedef signed char int8_t;          ///< 8 bit signed int
           =5 
           =5 typedef unsigned int uint16_t;        ///< 16 bit unsigned int
           =5 
           =5 typedef signed int int16_t;          ///< 16 bit signed int
           =5 
           =5 typedef unsigned long uint32_t;       ///< 32 bit unsigned int
           =5 
           =5 typedef signed long int32_t;         ///< 32 bit signed int
           =5 
           =5 #endif // __C51__
           =5 
           =5 #ifndef NULL
           =5 #define NULL (void*)0
           =5 #endif
           =5 
           =5 #endif // __STDINT_H__
  22      =4  
  23      =4  // Standard request codes
  24      =4  #define USB_REQ_GET_STATUS         0x00
  25      =4  #define USB_REQ_CLEAR_FEATURE      0x01
  26      =4  #define USB_REQ_RESERVED_1         0x02
  27      =4  #define USB_REQ_SET_FEATURE        0x03
  28      =4  #define USB_REQ_RESERVED_2         0x04
  29      =4  #define USB_REQ_SET_ADDRESS        0x05
  30      =4  #define USB_REQ_GET_DESCRIPTOR     0x06
  31      =4  #define USB_REQ_SET_DESCRIPTOR     0x07
  32      =4  #define USB_REQ_GET_CONFIGURATION  0x08
  33      =4  #define USB_REQ_SET_CONFIGURATION  0x09
  34      =4  #define USB_REQ_GET_INTERFACE      0x0a
  35      =4  #define USB_REQ_SET_INTERFACE      0x0b
  36      =4  #define USB_REQ_SYNCH_FRAME        0x0c
  37      =4  
  38      =4  // Descriptor types
  39      =4  #define USB_DESC_DEVICE           0x01
  40      =4  #define USB_DESC_CONFIGURATION    0x02
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 14  

  41      =4  #define USB_DESC_STRING           0x03
  42      =4  #define USB_DESC_INTERFACE        0x04
  43      =4  #define USB_DESC_ENDPOINT         0x05
  44      =4  #define USB_DESC_DEVICE_QUAL      0x06
  45      =4  #define USB_DESC_OTHER_SPEED_CONF 0x07
  46      =4  #define USB_DESC_INTERFACE_POWER  0x08
  47      =4  #define USB_DESC_OTG              0x09
  48      =4  #define USB_DESC_DEBUG            0x0A
  49      =4  #define USB_DESC_INTERFACE_ASSOC  0x0B
  50      =4  
  51      =4  #define USB_ENDPOINT_TYPE_CONTROL           0x00
  52      =4  #define USB_ENDPOINT_TYPE_ISOCHRONOUS       0x01
  53      =4  #define USB_ENDPOINT_TYPE_BULK              0x02
  54      =4  #define USB_ENDPOINT_TYPE_INTERRUPT         0x03
  55      =4  
  56      =4  // USB device classes
  57      =4  #define USB_DEVICE_CLASS_RESERVED               0x00
  58      =4  #define USB_DEVICE_CLASS_AUDIO                  0x01
  59      =4  #define USB_DEVICE_CLASS_COMMUNICATIONS         0x02
  60      =4  #define USB_DEVICE_CLASS_HUMAN_INTERFACE        0x03
  61      =4  #define USB_DEVICE_CLASS_MONITOR                0x04
  62      =4  #define USB_DEVICE_CLASS_PHYSICAL_INTERFACE     0x05
  63      =4  #define USB_DEVICE_CLASS_POWER                  0x06
  64      =4  #define USB_DEVICE_CLASS_PRINTER                0x07
  65      =4  #define USB_DEVICE_CLASS_STORAGE                0x08
  66      =4  #define USB_DEVICE_CLASS_HUB                    0x09
  67      =4  #define USB_DEVICE_CLASS_APPLICATION_SPECIFIC   0xFE
  68      =4  #define USB_DEVICE_CLASS_VENDOR_SPECIFIC        0xFF
  69      =4  
  70      =4  
  71      =4  #define USB_CLASS_DESCRIPTOR_HID    0x21
  72      =4  #define USB_CLASS_DESCRIPTOR_REPORT 0x22
  73      =4  #define USB_CLASS_DESCRIPTOR_PHYSICAL_DESCRIPTOR 0x23
  74      =4  
  75      =4  #define USB_DEVICE_REMOTE_WAKEUP    0x01
  76      =4  #define USB_ENDPOINT_HALT           0x00
  77      =4  #define USB_TEST_MODE               0x02
  78      =4  
  79      =4  typedef struct {
  80      =4       volatile uint8_t bLength;
  81      =4       volatile uint8_t bDescriptorType;
  82      =4       volatile uint16_t bcdUSB;
  83      =4       volatile uint8_t bDeviceClass;
  84      =4       volatile uint8_t bDeviceSubClass;
  85      =4       volatile uint8_t bDeviceProtocol;
  86      =4       volatile uint8_t bMaxPacketSize0;
  87      =4       volatile uint16_t idVendor;
  88      =4       volatile uint16_t idProduct;
  89      =4       volatile uint16_t bcdDevice;
  90      =4       volatile uint8_t iManufacturer;
  91      =4       volatile uint8_t iProduct;
  92      =4       volatile uint8_t iSerialNumber;
  93      =4       volatile uint8_t bNumConfigurations;
  94      =4  } hal_usb_dev_desc_t;
  95      =4  
  96      =4  typedef struct {
  97      =4       volatile uint8_t bLength;
  98      =4       volatile uint8_t bDescriptorType;
  99      =4       volatile uint16_t wTotalLength;
 100      =4       volatile uint8_t bNumInterfaces;
 101      =4       volatile uint8_t bConfigurationValue;
 102      =4       volatile uint8_t iConfiguration;
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 15  

 103      =4       volatile uint8_t bmAttributes;
 104      =4       volatile uint8_t bMaxPower;
 105      =4  } hal_usb_conf_desc_t;
 106      =4  
 107      =4  typedef struct {
 108      =4       volatile uint8_t bLength;
 109      =4       volatile uint8_t bDescriptorType;
 110      =4       volatile uint8_t bInterfaceNumber;
 111      =4       volatile uint8_t bAlternateSetting;
 112      =4       volatile uint8_t bNumEndpoints;
 113      =4       volatile uint8_t bInterfaceClass;
 114      =4       volatile uint8_t bInterfaceSubClass;
 115      =4       volatile uint8_t bInterfaceProtocol;
 116      =4       volatile uint8_t iInterface;
 117      =4  } hal_usb_if_desc_t;
 118      =4  
 119      =4  typedef struct {
 120      =4       volatile uint8_t bLength;
 121      =4       volatile uint8_t bDescriptorType;
 122      =4       volatile uint8_t bEndpointAddress;
 123      =4       volatile uint8_t bmAttributes;
 124      =4       volatile uint16_t wMaxPacketSize;
 125      =4       volatile uint8_t bInterval;
 126      =4  } hal_usb_ep_desc_t;
 127      =4  
 128      =4  /*
 129      =4  typedef struct {
 130      =4      volatile uint8_t bLength;
 131      =4      volatile uint8_t bDescriptorType;
 132      =4      volatile uint16_t bcdHID;
 133      =4      volatile uint8_t bCountryCode;
 134      =4      volatile uint8_t bNumDescriptors;
 135      =4      volatile uint8_t bDescriptorType2;
 136      =4      volatile uint16_t wDescriptorLength;
 137      =4  } hal_usb_hid_desc_t;
 138      =4  
 139      =4  
 140      =4  typedef struct {
 141      =4       volatile uint8_t* desc;
 142      =4  } hal_usb_string_desc_t;
 143      =4  
 144      =4  typedef struct {
 145      =4       volatile uint8_t bLength;
 146      =4       volatile uint8_t bDescriptorType;
 147      =4  } hal_usb_common_desc_t;
 148      =4    */
 149      =4  
 150      =4  #endif // HAL_USB_DESC_H__
  22      =3  
  23      =3  #define USB_DESC_TEMPLATE 
  24      =3  
  25      =3  //------------------------------------------ 
  26      =3  // Vendor ID and Product ID definitions 
  27      =3  //------------------------------------------ 
  28      =3  #define VID   0x1915 
  29      =3  #define PID   0x0909 
  30      =3  
  31      =3  #define USB_STRING_DESC_COUNT 2
  32      =3  
  33      =3  typedef struct
  34      =3  {
  35      =3      hal_usb_conf_desc_t conf;
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 16  

  36      =3      hal_usb_if_desc_t if0;
  37      =3      hal_usb_ep_desc_t ep1in;
  38      =3      hal_usb_ep_desc_t ep1out;
  39      =3  } usb_conf_desc_templ_t;
  40      =3  
  41      =3  typedef struct { 
  42      =3       volatile uint8_t* idx[USB_STRING_DESC_COUNT]; 
  43      =3  } usb_string_desc_templ_t; 
  44      =3  
  45      =3  extern code usb_string_desc_templ_t g_usb_string_desc; 
  46      =3  extern code usb_conf_desc_templ_t g_usb_conf_desc;
  47      =3  extern code hal_usb_dev_desc_t g_usb_dev_desc;
  48      =3  
  49      =3  typedef struct { 
  50      =3       hal_usb_dev_desc_t* dev; 
  51      =3       usb_conf_desc_templ_t* conf; 
  52      =3       usb_string_desc_templ_t* string; 
  53      =3       uint8_t string_zero[4]; 
  54      =3  } usb_descs_templ_t;
  55      =3  
  56      =3  extern code uint8_t g_usb_string_desc_1[];
  57      =3  extern code uint8_t g_usb_string_desc_2[];
  58      =3  extern code uint8_t string_zero[4];
  59      =3  
  60      =3  #endif  // USB_DESC_TEMPL_H__
  85      =2  
  86      =2  #ifndef USB_DESC_TEMPLATE
           =2 #error "USB_DESC_TEMPLATE not defined. Please include a file with g_usb_string_desc, g_usb_conf_desc and g
             -_usb_dev_desc defined" 
           =2 #endif
  89      =2  
  90      =2  #define USB_BM_STATE_CONFIGURED 0x01
  91      =2  #define USB_BM_STATE_ALLOW_REMOTE_WAKEUP 0x02
  92      =2  #define USB_BM_STATE_HOST_WU     0x04
  93      =2  
  94      =2  // Calculate buffer location in USB-controller
  95      =2  #define CALCULATE_BUF_IN_PTR(ep) (uint8_t xdata *)(in0buf - (( ep & 0x7f) * 128))
  96      =2  #define CALCULATE_BUF_OUT_PTR(ep) (uint8_t xdata *)(out0buf - (ep * 128 ))
  97      =2  
  98      =2  /** An enum describing the USB state
  99      =2   * 
 100      =2   *  The states described in this enum are found in Chapter 9 of the USB 2.0 specification
 101      =2   */
 102      =2  
 103      =2  typedef enum  { 
 104      =2      ATTACHED,   /**< Device is attached to the USB, but is not powered */
 105      =2      POWERED,    /**< Device is attached to the USB and powered */
 106      =2      DEFAULT,    /**< Device is attached to the USB and powered and has been reset, but has not been assign
             -ed a unique address */
 107      =2      ADDRESSED,  /**< Device is attached to the USB, powered, has been reset, and a unique device address h
             -as been assigned. Device is not configured */
 108      =2      CONFIGURED, /**< Device is attached to the USB, powered, has been reset, has a unique address, is conf
             -igured and is not suspended */
 109      =2      SUSPENDED   /**< Device is, at a minimum, attached to the USB and is powered and has not seen bus acti
             -vity for 3ms. It may also have a unique address and be configured for use. However, because the device is susended, the 
             -host may not use the device configuration */
 110      =2  } hal_usb_state_t;
 111      =2  
 112      =2  /** Structure containing the USB standard request
 113      =2   *  See Chapter 9 USB Device Framework in the USB 2.0 specification.
 114      =2   */
 115      =2  
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 17  

 116      =2  typedef struct {
 117      =2      uint8_t  bmRequestType; /**< Bitmapped field identifying the characteristics of the request.
 118      =2                          - D7: Data transfer direction 
 119      =2                          - 0 = Host-to-device
 120      =2                          - 1 = Device-to-host
 121      =2  
 122      =2                          - D6..5: Type
 123      =2                          - 0 = Standard
 124      =2                          - 1 = Class
 125      =2                          - 2 = Vendor
 126      =2                          - 3 = Reserved
 127      =2  
 128      =2                          - D4..0: Recipient
 129      =2                          - 0 = Device
 130      =2                          - 1 = Interface
 131      =2                          - 2 = Endpoint
 132      =2                          - 3 = Other
 133      =2                          - 4..31 = Reserved
 134      =2                            */
 135      =2      uint8_t  bRequest;       /**< Field specifying request. bmRequestType(Type) modify the meaning of this
             - field. */
 136      =2  
 137      =2      uint8_t wValueMsb;      /**< Field used to pass a parameter to the device, specific to the request. MS
             -B*/
 138      =2      uint8_t wValueLsb;      /**< Field used to pass a parameter to the device, specific to the request. LS
             -B*/
 139      =2      uint8_t wIndex;         /**< Field used to pass a paramters to the device, specific to the request. */
 140      =2      uint8_t wLength;        /**< Field used to specify length of the data transferred during the second ph
             -ase of the control transfer. Direction of data transfer given by bmRequestType(Direction). If field is zero there is no 
             -data transfer phase. */
 141      =2  //    void* misc_data;
 142      =2  } hal_usb_device_req;
 143      =2  
 144      =2  /** An enum describing what reply to send to the control request
 145      =2   */
 146      =2  
 147      =2  typedef enum {
 148      =2      STALL,         /**< Respond with STALL */
 149      =2      NAK,           /**< Respond with NAK   */
 150      =2      ACK,           /**< Respond with ACK (if this is an OUT request) */
 151      =2      NO_RESPONSE,   /**< Do not respond */
 152      =2      DATA,          /**< Data is available */
 153      =2      EMPTY_RESPONSE /**< Send an empty response */
 154      =2  } hal_usb_dev_req_resp_t;
 155      =2  
 156      =2  uint8_t ep_1_out_cb(uint8_t xdata *, uint8_t xdata *) reentrant;
 157      =2  /** Callback function that is called when a class request is received.
 158      =2   *  The type of class request is determined by the interface the request is for. If interface 1 is a HID i
             -nterface the request is a HID class request.
 159      =2   *  @param std_req The complete request. 
 160      =2   *  @param data_ptr Pointer to pointer to data(descriptor struct) the function wants to send back to USB-h
             -ost
 161      =2   *  @param size Size of data the function wants to send back to USB-host
 162      =2   */
 163      =2  
 164      =2  
 165      =2  typedef hal_usb_dev_req_resp_t (*hal_usb_cb_device_req_t)(hal_usb_device_req* device_req, uint8_t ** data_
             -ptr, uint8_t* size) reentrant;
 166      =2  
 167      =2  /** Callback function that is called when an endpoint interrupt occur 
 168      =2   *  @param adr_ptr IN endpoint: Pointer to address containing data to send. OUT endpoint: Pointer to addre
             -ss containg data received.
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 18  

 169      =2   *  @param size IN endpoint: Number of bytes to send. OUT endpoint: number of bytes received.
 170      =2   *  @retval Bit 7 Set: STALL request
 171      =2   *  @retval Bit 6 Set: NACK request
 172      =2   *  @retval Bit 5..0 : Bytes to send
 173      =2   */
 174      =2  typedef uint8_t (*hal_usb_cb_endpoint_t)(uint8_t xdata *adr_ptr, uint8_t xdata *size) reentrant;
 175      =2  
 176      =2  /** Callback function that is called when a resume is signalled on the bus.
 177      =2   *  A resume is signalled by the Data K state. For full speed devices this is Differential "0". Differenti
             -al "0": D-> Voh(main) and D+ < Vol(max).
 178      =2   */
 179      =2  
 180      =2  typedef void (*hal_usb_cb_resume_t)();
 181      =2  
 182      =2  /** Callback function that is called when a suspend condition occur.
 183      =2   *  @param can_resume Set to 1 if the device is allowed to wake up the host controller
 184      =2   *  @see hal_usb_state_t
 185      =2   */
 186      =2  
 187      =2  typedef void (*hal_usb_cb_suspend_t)(uint8_t allow_remote_wu) reentrant;
 188      =2  
 189      =2  /** Callback function that is called when a reset condition occur.
 190      =2   *  
 191      =2   */
 192      =2  typedef void (*hal_usb_cb_reset_t)();
 193      =2  
 194      =2  /** A struct containing variables related to the USB HAL layer 
 195      =2   *  
 196      =2   */
 197      =2  
 198      =2  typedef struct {
 199      =2      usb_descs_templ_t descs;     /**< Structure containing device, string and configuration descriptors fo
             -r a specific application */
 200      =2      uint8_t  bm_state;             /**< Bitmask containing USB state information: bitmask: 0 - is_hw_reset
             -, 1 - can signal remote wakeup, 2 - usb awake */
 201      =2      uint8_t current_config;        /**< Currently set configuration. If current_config is zero the device 
             -is not configured */
 202      =2      uint8_t current_alt_interface; /**< Currently alternative configuration. If a alternative configuratio
             -n is chosen the index of the alternative configuration is stored here. */
 203      =2      hal_usb_state_t state;       /**< Enum containing USB state information as described in Chapter 9 of t
             -he USB 2.0 specification.  */
 204      =2  
 205      =2      hal_usb_cb_device_req_t device_req;
 206      =2      hal_usb_cb_reset_t      reset;
 207      =2      hal_usb_cb_resume_t     resume;
 208      =2      hal_usb_cb_suspend_t    suspend;
 209      =2  } hal_usb_t;
 210      =2  
 211      =2  /** Function for setting up the USB controller and registering the callbacks 
 212      =2   *  @param usb_disconnect Set to true to perform physical disconnect and reconnect. Make sure to enable in
             -terruts as soon as possible after
 213      =2   *                        the call to this function.
 214      =2   *  @param device_req Pointer to function to call when a class specific request occur
 215      =2   *  @param reset Pointer to function to call when USB controller detect a reset
 216      =2   *  @param resume Pointer to function to call when USB controller detect a resume
 217      =2   *  @param suspend Pointer to function to call when USB controller detect a suspend
 218      =2   */
 219      =2  void hal_usb_init(
 220      =2      bool usb_disconnect,
 221      =2      hal_usb_cb_device_req_t device_req,
 222      =2      hal_usb_cb_reset_t      reset,
 223      =2      hal_usb_cb_resume_t     resume,
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 19  

 224      =2      hal_usb_cb_suspend_t    suspend);
 225      =2  
 226      =2  /** Function to send a packet to host (IN endpoint)
 227      =2   *  @param ep_in_num IN endpointer number
 228      =2   *  @param buffer Pointer to buffer containing data to send
 229      =2   *  @param bytes_to_send Number of bytes to send.
 230      =2   */
 231      =2  void hal_usb_send_data(uint8_t data ep_in_num, uint8_t* data buffer, uint8_t data bytes_to_send);
 232      =2  
 233      =2  /** Function to register callbacks for given endpoints 
 234      =2   *  To register a callback one have to have a function with an argument list equal to usb_endpoint_cb_t.
 235      =2   *  @param ep_num Endpoint number. If MSB is set it indicates this is an IN endpoint.
 236      =2   *  @param ep_size The maximum size of one packet for this endpoint
 237      =2   *  @param endpoint_isr Pointer to function that is called when host issues a request on the given endpoin
             -t. Set to 0 to unregister function.
 238      =2   */
 239      =2  void hal_usb_endpoint_config(uint8_t ep_num, uint8_t ep_size, hal_usb_cb_endpoint_t endpoint_isr);
 240      =2  
 241      =2  /** Function to stall or unstall an endpoint
 242      =2   *  @param ep_num Endpoint number. If MSB is set it indicates this is an IN endpoint.
 243      =2   *  @param stall 1 - stall the endpoint. 0 - unstall the endpoint.
 244      =2   */
 245      =2  void hal_usb_endpoint_stall(uint8_t ep_num, bool stall);
 246      =2  
 247      =2  /** Function returning the current state of the USB controller
 248      =2   *  @see usb_stat_t
 249      =2   */
 250      =2  hal_usb_state_t hal_usb_get_state();
 251      =2  
 252      =2  /** Function returning the assigned address for the device */
 253      =2  uint8_t hal_usb_get_address();
 254      =2  
 255      =2  /** Function to initiate a remote wakeup of the USB host */
 256      =2  void hal_usb_wakeup();
 257      =2  
 258      =2  /** Function to initiate a <b>hardware reset</b> of the USB-controller */
 259      =2  void hal_usb_reset();
 260      =2  
 261      =2  /** Function disconnecting the USB-controller from the USB bus  */
 262      =2  void hal_usb_bus_disconnect();
 263      =2  
 264      =2  /** Function connecting the USB-controller to the USB bus */
 265      =2  void hal_usb_bus_connect();
 266      =2  
 267      =2  /** Function stopping the clock to the usb controller or by other means powers it down */
 268      =2  void hal_usb_sleep();
 269      =2  
 270      =2  extern hal_usb_t g_hal_usb;
 271      =2  
 272      =2  #endif //  HAL_USB_H__
 273      =2  /** @} */
  24      =1  
  25      =1  #define USB_ENDPOINT_IN_COUNT 5
  26      =1  #define USB_ENDPOINT_OUT_COUNT 5
  27      =1  
  28      =1  #define USB_EP0_HSNAK() do { ep0cs = 0x02; } while(0)
  29      =1  #define USB_EP0_STALL() do { ep0cs = 0x11; } while(0) // Set both DSTALL and STALL when we want to stall a
             - request during a SETUP transaction
  30      =1  #define USB_EP0_DSTALL() do { ep0cs |= 0x10; } while(0)
  31      =1  
  32      =1  #define INT_SUDAV    0x00
  33      =1  #define INT_SOF      0x04
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 20  

  34      =1  #define INT_SUTOK    0x08
  35      =1  #define INT_SUSPEND  0x0C
  36      =1  #define INT_USBRESET 0x10
  37      =1  #define INT_EP0IN    0x18
  38      =1  #define INT_EP0OUT   0x1C
  39      =1  #define INT_EP1IN    0x20
  40      =1  #define INT_EP1OUT   0x24
  41      =1  #define INT_EP2IN    0x28
  42      =1  #define INT_EP2OUT   0x2C
  43      =1  #define INT_EP3IN    0x30
  44      =1  #define INT_EP3OUT   0x34
  45      =1  #define INT_EP4IN    0x38
  46      =1  #define INT_EP4OUT   0x3C
  47      =1  #define INT_EP5IN    0x40
  48      =1  #define INT_EP5OUT   0x44
  49      =1  
  50      =1  #define BM_REQUEST_TYPE  0
  51      =1  #define B_REQUEST        1
  52      =1  #define W_VALUE          2
  53      =1  #define W_INDEX          4
  54      =1  #define W_LENGTH         6
  55      =1  
  56      =1  typedef struct
  57      =1  {
  58      =1      uint8_t *data_ptr;
  59      =1      uint8_t data_size;
  60      =1      uint8_t pkt_size;
  61      =1  } packetizer_t;
  62      =1  
  63      =1  #endif
  23          
  24          #define ALLOCATE_USB_MAP
  25          #include "usb_map.h"
   1      =1  /* Copyright (c) 2009 Nordic Semiconductor. All Rights Reserved.
   2      =1   *
   3      =1   * The information contained herein is confidential property of Nordic 
   4      =1   * Semiconductor ASA.Terms and conditions of usage are described in detail 
   5      =1   * in NORDIC SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT. 
   6      =1   *
   7      =1   * Licensees are granted free, non-transferable use of the information. NO
   8      =1   * WARRENTY of ANY KIND is provided. This heading must NOT be removed from
   9      =1   * the file.
  10      =1   *              
  11      =1   * $LastChangedRevision: 5717 $
  12      =1   */
  13      =1  
  14      =1  /** @file
  15      =1   * @brief USB register layout and interrupts
  16      =1   *
  17      =1   * This file contain:
  18      =1   * - the USB-controller register layout
  19      =1   * - the USB-controller interrupts towards the MCU
  20      =1   *
  21      =1   * The usb_map_t structure is set to point at xdata address 0x0000
  22      =1   */
  23      =1  #ifndef USB_MAP_H__
  24      =1  #define USB_MAP_H__
  25      =1  
  26      =1  #ifdef ALLOCATE_USB_MAP
  27      =1  #define EXTERN
  28      =1  #define _AT_ _at_
  29      =1  #else
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 21  

           =1 #define EXTERN extern
           =1 #define _AT_ ;/ ## /
           =1 #endif
  33      =1  
  34      =1  #define USB_EP_DEFAULT_BUF_SIZE 0x20 // (32)
  35      =1  
  36      =1  EXTERN xdata volatile uint8_t out5buf[USB_EP_DEFAULT_BUF_SIZE] _AT_ 0xC440;
  37      =1  EXTERN xdata volatile uint8_t in5buf[USB_EP_DEFAULT_BUF_SIZE]  _AT_ 0xC480;
  38      =1  EXTERN xdata volatile uint8_t out4buf[USB_EP_DEFAULT_BUF_SIZE] _AT_ 0xC4C0;
  39      =1  EXTERN xdata volatile uint8_t in4buf[USB_EP_DEFAULT_BUF_SIZE]  _AT_ 0xC500;
  40      =1  EXTERN xdata volatile uint8_t out3buf[USB_EP_DEFAULT_BUF_SIZE] _AT_ 0xC540;
  41      =1  EXTERN xdata volatile uint8_t in3buf[USB_EP_DEFAULT_BUF_SIZE]  _AT_ 0xC580;
  42      =1  EXTERN xdata volatile uint8_t out2buf[USB_EP_DEFAULT_BUF_SIZE] _AT_ 0xC5C0;
  43      =1  EXTERN xdata volatile uint8_t in2buf[USB_EP_DEFAULT_BUF_SIZE]  _AT_ 0xC600;
  44      =1  EXTERN xdata volatile uint8_t out1buf[USB_EP_DEFAULT_BUF_SIZE] _AT_ 0xC640;
  45      =1  EXTERN xdata volatile uint8_t in1buf[USB_EP_DEFAULT_BUF_SIZE]  _AT_ 0xC680;
  46      =1  EXTERN xdata volatile uint8_t out0buf[USB_EP_DEFAULT_BUF_SIZE] _AT_ 0xC6C0;
  47      =1  EXTERN xdata volatile uint8_t in0buf[USB_EP_DEFAULT_BUF_SIZE]  _AT_ 0xC700;
  48      =1  EXTERN xdata volatile uint8_t out8data                         _AT_ 0xC760;
  49      =1  EXTERN xdata volatile uint8_t in8data                          _AT_ 0xC768;
  50      =1  EXTERN xdata volatile uint8_t out8bch                          _AT_ 0xC770;
  51      =1  EXTERN xdata volatile uint8_t out8bcl                          _AT_ 0xC771;
  52      =1  EXTERN xdata volatile uint8_t bout1addr                        _AT_ 0xC781;
  53      =1  EXTERN xdata volatile uint8_t bout2addr                        _AT_ 0xC782;
  54      =1  EXTERN xdata volatile uint8_t bout3addr                        _AT_ 0xC783;
  55      =1  EXTERN xdata volatile uint8_t bout4addr                        _AT_ 0xC784;
  56      =1  EXTERN xdata volatile uint8_t bout5addr                        _AT_ 0xC785;
  57      =1  EXTERN xdata volatile uint8_t binstaddr                        _AT_ 0xC788;
  58      =1  EXTERN xdata volatile uint8_t bin1addr                         _AT_ 0xC789;
  59      =1  EXTERN xdata volatile uint8_t bin2addr                         _AT_ 0xC78A;
  60      =1  EXTERN xdata volatile uint8_t bin3addr                         _AT_ 0xC78B;
  61      =1  EXTERN xdata volatile uint8_t bin4addr                         _AT_ 0xC78C;
  62      =1  EXTERN xdata volatile uint8_t bin5addr                         _AT_ 0xC78D;
  63      =1  EXTERN xdata volatile uint8_t isoerr                           _AT_ 0xC7A0;
  64      =1  EXTERN xdata volatile uint8_t zbcout                           _AT_ 0xC7A2;
  65      =1  EXTERN xdata volatile uint8_t ivec                             _AT_ 0xC7A8;
  66      =1  EXTERN xdata volatile uint8_t in_irq                           _AT_ 0xC7A9;
  67      =1  EXTERN xdata volatile uint8_t out_irq                          _AT_ 0xC7AA;
  68      =1  EXTERN xdata volatile uint8_t usbirq                           _AT_ 0xC7AB;
  69      =1  EXTERN xdata volatile uint8_t in_ien                           _AT_ 0xC7AC;
  70      =1  EXTERN xdata volatile uint8_t out_ien                          _AT_ 0xC7AD;
  71      =1  EXTERN xdata volatile uint8_t usbien                           _AT_ 0xC7AE;
  72      =1  EXTERN xdata volatile uint8_t usbbav                           _AT_ 0xC7AF;
  73      =1  EXTERN xdata volatile uint8_t ep0cs                            _AT_ 0xC7B4;
  74      =1  EXTERN xdata volatile uint8_t in0bc                            _AT_ 0xC7B5;
  75      =1  EXTERN xdata volatile uint8_t in1cs                            _AT_ 0xC7B6;
  76      =1  EXTERN xdata volatile uint8_t in1bc                            _AT_ 0xC7B7;
  77      =1  EXTERN xdata volatile uint8_t in2cs                            _AT_ 0xC7B8;
  78      =1  EXTERN xdata volatile uint8_t in2bc                            _AT_ 0xC7B9;
  79      =1  EXTERN xdata volatile uint8_t in3cs                            _AT_ 0xC7BA;
  80      =1  EXTERN xdata volatile uint8_t in3bc                            _AT_ 0xC7BB;
  81      =1  EXTERN xdata volatile uint8_t in4cs                            _AT_ 0xC7BC;
  82      =1  EXTERN xdata volatile uint8_t in4bc                            _AT_ 0xC7BD;
  83      =1  EXTERN xdata volatile uint8_t in5cs                            _AT_ 0xC7BE;
  84      =1  EXTERN xdata volatile uint8_t in5bc                            _AT_ 0xC7BF;
  85      =1  EXTERN xdata volatile uint8_t out0bc                           _AT_ 0xC7C5;
  86      =1  EXTERN xdata volatile uint8_t out1cs                           _AT_ 0xC7C6;
  87      =1  EXTERN xdata volatile uint8_t out1bc                           _AT_ 0xC7C7;
  88      =1  EXTERN xdata volatile uint8_t out2cs                           _AT_ 0xC7C8;
  89      =1  EXTERN xdata volatile uint8_t out2bc                           _AT_ 0xC7C9;
  90      =1  EXTERN xdata volatile uint8_t out3cs                           _AT_ 0xC7CA;
  91      =1  EXTERN xdata volatile uint8_t out3bc                           _AT_ 0xC7CB;
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 22  

  92      =1  EXTERN xdata volatile uint8_t out4cs                           _AT_ 0xC7CC;
  93      =1  EXTERN xdata volatile uint8_t out4bc                           _AT_ 0xC7CD;
  94      =1  EXTERN xdata volatile uint8_t out5cs                           _AT_ 0xC7CE;
  95      =1  EXTERN xdata volatile uint8_t out5bc                           _AT_ 0xC7CF;
  96      =1  EXTERN xdata volatile uint8_t usbcs                            _AT_ 0xC7D6;
  97      =1  EXTERN xdata volatile uint8_t togctl                           _AT_ 0xC7D7;
  98      =1  EXTERN xdata volatile uint8_t usbfrml                          _AT_ 0xC7D8;
  99      =1  EXTERN xdata volatile uint8_t usbfrmh                          _AT_ 0xC7D9;
 100      =1  EXTERN xdata volatile uint8_t fnaddr                           _AT_ 0xC7DB;
 101      =1  EXTERN xdata volatile uint8_t usbpair                          _AT_ 0xC7DD;
 102      =1  EXTERN xdata volatile uint8_t inbulkval                        _AT_ 0xC7DE;
 103      =1  EXTERN xdata volatile uint8_t outbulkval                       _AT_ 0xC7DF;
 104      =1  EXTERN xdata volatile uint8_t inisoval                         _AT_ 0xC7E0;
 105      =1  EXTERN xdata volatile uint8_t outisoval                        _AT_ 0xC7E1;
 106      =1  EXTERN xdata volatile uint8_t isostaddr                        _AT_ 0xC7E2;
 107      =1  EXTERN xdata volatile uint8_t isosize                          _AT_ 0xC7E3;
 108      =1  EXTERN xdata volatile uint8_t setupbuf[8]                      _AT_ 0xC7E8;
 109      =1  EXTERN xdata volatile uint8_t out8addr                         _AT_ 0xC7F0;
 110      =1  EXTERN xdata volatile uint8_t in8addr                          _AT_ 0xC7F8;
 111      =1  
 112      =1  #endif
  26          
  27          #define USB_WU  11 // Keil sees interrupt 11 at address 0x005b
  28          #define USB_IRQ 12 // Keil sees interrupt 12 at address 0x0063
  29          
  30          // Define formulas for jumping in the usb registry map based upon the endpoint number
  31          
  32          // Calculate control and status register location in USB-controller
  33          #define CALCULATE_CS_IN_PTR(ep) (uint8_t xdata*)(&in1cs + 2 * ((ep & 0x7f) - 1 ))
  34          #define CALCULATE_CS_OUT_PTR(ep) (uint8_t xdata*)(&out1cs + 2 * ( (ep & 0x7f) - 1 ))
  35          
  36          // Calculate byte count register location in USB-controller
  37          #define CALCULATE_BC_OUT_PTR(ep) (uint8_t xdata *)(&out0bc + (ep * 2 ))
  38          #define CALCULATE_BC_IN_PTR(ep) (uint8_t xdata *)(&in0bc + ((ep & 0x7f ) * 2))
  39          
  40          // Calculate buffer location in USB-controller
  41          #define CALCULATE_BUF_IN_PTR(ep) (uint8_t xdata *)(in0buf - (( ep & 0x7f) * 128))
  42          #define CALCULATE_BUF_OUT_PTR(ep) (uint8_t xdata *)(out0buf - (ep * 128 ))
  43          
  44          static packetizer_t i_packetizer;
  45          static hal_usb_cb_endpoint_t i_endpoint_in_isr[USB_ENDPOINT_IN_COUNT];
  46          hal_usb_cb_endpoint_t i_endpoint_out_isr[USB_ENDPOINT_OUT_COUNT];
  47          
  48          static hal_usb_device_req req;
  49          hal_usb_t g_hal_usb;
  50          static uint8_t stall_data_size0;
  51          
  52          static void delay_ms(uint8_t ms);
  53          
  54          sbit P0_5 = P0^5;
  55          
  56          void hal_usb_init(bool usb_disconnect, hal_usb_cb_device_req_t device_req, hal_usb_cb_reset_t reset, hal_u
             -sb_cb_resume_t resume, hal_usb_cb_suspend_t suspend)
  57          {
  58   1          // Setup descriptors
  59   1          g_hal_usb.descs.dev = &g_usb_dev_desc;
  60   1          g_hal_usb.descs.dev = &g_usb_dev_desc;
  61   1          g_hal_usb.descs.conf = &g_usb_conf_desc;
  62   1          g_hal_usb.descs.string = &g_usb_string_desc;
  63   1      
  64   1          // This is for setting language American English (String descriptor 0 is an array of supported languag
             -es)
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 23  

  65   1          g_hal_usb.descs.string_zero[0] = 0x04;
  66   1          g_hal_usb.descs.string_zero[1] = 0x03;
  67   1          g_hal_usb.descs.string_zero[2] = 0x09;
  68   1          g_hal_usb.descs.string_zero[3] = 0x04;
  69   1      
  70   1          // Setup state information
  71   1          g_hal_usb.state = DEFAULT;
  72   1          g_hal_usb.bm_state = 0;
  73   1          stall_data_size0 = 0;
  74   1      
  75   1          // Setconfig configuration information
  76   1          g_hal_usb.current_config = 0;
  77   1          g_hal_usb.current_alt_interface = 0;
  78   1      
  79   1          // Setup callbacks
  80   1          g_hal_usb.device_req = device_req;
  81   1          g_hal_usb.reset = reset;
  82   1          g_hal_usb.resume = resume;
  83   1          g_hal_usb.suspend = suspend;
  84   1      
  85   1          // Disconnect from USB-bus if we are in this routine from a power on and not a soft reset
  86   1          if(usb_disconnect)
  87   1          {
  88   2              usbcs |= 0x08; // disconnect
  89   2              delay_ms(50);
  90   2              usbcs &= ~(0x08); // connect
  91   2          }
  92   1      
  93   1          // Setup interrupts
  94   1          USBWU = 1; // USBWU is mapped to IEN1.3
  95   1          USB = 1; // USBIRQ is mapped to IEN1.4
  96   1      
  97   1          usbien = 0x1d; // ibnie -5 4 - uresir 3 - suspir, 0 - sudavir
  98   1      
  99   1          in_ien = 0x01;
 100   1          in_irq = 0x1f;
 101   1          out_ien = 0x01;
 102   1          out_irq = 0x1f;
 103   1      
 104   1          // Setup the USB RAM with some OK default values. Note that isochronos is not set up yet.
 105   1          bout1addr = 16;
 106   1          bout2addr = 32;
 107   1          bout3addr = 48;
 108   1          bout4addr = 64;
 109   1          bout5addr = 80;
 110   1      
 111   1          binstaddr = 0xc0;
 112   1          bin1addr = 16;
 113   1          bin2addr = 32;
 114   1          bin3addr = 48;
 115   1          bin4addr = 64;
 116   1          bin5addr = 80;
 117   1      
 118   1          // Set all endpoints to not valid (except EP0IN and EP0OUT)
 119   1          inbulkval = 0x01;
 120   1          outbulkval = 0x01;
 121   1          inisoval = 0x00;
 122   1          outisoval = 0x00;
 123   1      
 124   1      
 125   1      }
 126          
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 24  

 127          void hal_usb_endpoint_stall(uint8_t ep_num, bool stall)
 128          {
 129   1          uint8_t temp;
 130   1          uint8_t xdata *cs_ptr;
 131   1      
 132   1          temp = 2 * ((ep_num & 0x7f) - 1);
 133   1      
 134   1          // Calculate register address
 135   1          if((ep_num & 0x80 ) == 0x80) // IN endpoints
 136   1          {
 137   2              // Calculate control and status register for IN endpoint
 138   2              cs_ptr = (uint8_t xdata*)(&in1cs + temp);
 139   2          }
 140   1          else // OUT endpoints
 141   1          {
 142   2              // Calculate control and status register for OUT endpoint
 143   2              cs_ptr = (uint8_t xdata*)(&out1cs + temp);
 144   2          }
 145   1      
 146   1          if(stall == true)
 147   1          {
 148   2              // Set the stall bit
 149   2              *cs_ptr = 0x01;
 150   2          }
 151   1          else
 152   1          {
 153   2              // Clear the stall bit
 154   2              *cs_ptr = 0x00;
 155   2          }
 156   1      }
 157          
 158          uint8_t hal_usb_get_address()
 159          {
 160   1          return fnaddr;
 161   1      }
 162          
 163          void hal_usb_endpoint_config(uint8_t ep_num, uint8_t ep_size, hal_usb_cb_endpoint_t endpoint_isr)
 164          {
 165   1          /// @todo Create a function that setup the usbram correctly
 166   1          uint8_t xdata *bc_ptr;
 167   1          uint8_t temp = (ep_num & 0x7f) - 1;
 168   1          uint8_t stemp = 1 << (ep_num & 0x7f);
 169   1      
 170   1          // Dummy use of variable to get rid of warning
 171   1          ep_size = 0;
 172   1      
 173   1          if((ep_num & 0x80 ) == 0x80) // MSB set indicates IN endpoint
 174   1          {
 175   2              i_endpoint_in_isr[temp] = endpoint_isr;
 176   2              if(endpoint_isr != NULL)
 177   2              {
 178   3                  // Add the callback, enable the interrupt and validate the endpoint
 179   3                  in_ien |= stemp; 
 180   3                  inbulkval |= stemp;
 181   3              }
 182   2              else
 183   2              {
 184   3                  // Remove the callback, disable the interrupt and invalidate the endpoint
 185   3                  in_ien &= ~stemp;
 186   3                  inbulkval &= ~stemp;
 187   3              }
 188   2          }
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 25  

 189   1          else // OUT endpoint
 190   1          {
 191   2              i_endpoint_out_isr[temp] = endpoint_isr;
 192   2              if(endpoint_isr != NULL)
 193   2              {
 194   3                  // Add the callback, enable the interrupt and validate the endpoint
 195   3                  out_ien |= stemp;
 196   3                  outbulkval |= stemp;
 197   3      
 198   3                  // Have to write a dummy value to the OUTxBC register to get interrupts
 199   3                  bc_ptr = CALCULATE_BC_OUT_PTR(ep_num);
 200   3                  *bc_ptr = 0xff;
 201   3              }
 202   2              else
 203   2              {
 204   3                  // Remove the callback, disable the interrupt and invalidate the endpoint
 205   3                  out_ien &= ~stemp;
 206   3                  outbulkval &= ~stemp;
 207   3              }
 208   2          }
 209   1      }
 210          
 211          void hal_usb_wakeup()
 212          {
 213   1          // We can only issue a wakeup if the host has allowed us to do so
 214   1          if((g_hal_usb.bm_state & USB_BM_STATE_ALLOW_REMOTE_WAKEUP) == USB_BM_STATE_ALLOW_REMOTE_WAKEUP)
 215   1          {
 216   2              USBCON = 0x40;  // Wakeup the USB controller via remote pin
 217   2              delay_ms(1);    // Wait until the USB clock starts
 218   2              USBCON = 0x00;
 219   2          }
 220   1      }
 221          
 222          void hal_usb_reset()
 223          {
 224   1          SWRST = 1;  // Perform a hardware reset of the USB controller
 225   1      }
 226          
 227          hal_usb_state_t hal_usb_get_state()
 228          {
 229   1          return g_hal_usb.state;
 230   1      }
 231          
 232          void hal_usb_send_data(uint8_t data ep_num, uint8_t* data array, uint8_t data count)
 233          {
 234   1          uint8_t data i;
 235   1      
 236   1          uint8_t xdata *buf_ptr;
 237   1          uint8_t xdata *bc_ptr;
 238   1      
 239   1          // Calculate the buffer pointer and byte count pointer
 240   1          buf_ptr = CALCULATE_BUF_IN_PTR(ep_num);
 241   1          bc_ptr = CALCULATE_BC_IN_PTR(ep_num);
 242   1      
 243   1          // Copy the data into the USB controller
 244   1          for( i = 0; i < count; i++ )
 245   1          {
 246   2              buf_ptr[i] = array[i];
 247   2          }
 248   1          
 249   1          // Set the number of bytes we want to send to USB-host. This also trigger sending of data to USB-host.
 250   1          *bc_ptr = count;
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 26  

 251   1      }
 252          
 253          void hal_usb_bus_disconnect()
 254          {
 255   1          usbcs |= 0x08; // disconnect
 256   1      }
 257          
 258          void hal_usb_bus_connect()
 259          {
 260   1          usbcs &= ~(0x08); // connect
 261   1      }
 262          
 263          void hal_usb_sleep()
 264          {
 265   1          USBSLP = 1;
 266   1      }
 267           
 268          static void packetize(uint8_t *data_ptr, uint8_t data_size)
 269          {
 270   1           i_packetizer.data_ptr = data_ptr;
 271   1           i_packetizer.data_size = data_size;
 272   1           i_packetizer.pkt_size = g_hal_usb.descs.dev->bMaxPacketSize0;
 273   1      }
 274          
 275          // This routine is called by functions that shall send their first packet and when the EP0IN interrupt is 
             -set
 276          static void packetizer_isr_ep0_in(void) 
 277          {
 278   1          uint8_t size, i;
 279   1      
 280   1          // We are getting a ep0in interupt when the host send ACK and do not have any more data to send
 281   1          if(i_packetizer.data_size == 0)
 282   1          {        
 283   2              if (stall_data_size0 == 1)
 284   2              {
 285   3                  USB_EP0_DSTALL();
 286   3              }
 287   2              else
 288   2              {
 289   3                  stall_data_size0 = 1;
 290   3                  in0bc = 0;
 291   3                  USB_EP0_HSNAK();
 292   3              }       
 293   2              return;
 294   2          }
 295   1      
 296   1          size = MIN(i_packetizer.data_size, i_packetizer.pkt_size);
 297   1      
 298   1          // Copy data to the USB-controller buffer
 299   1          for(i = 0; i < size; i++)
 300   1          {
 301   2              in0buf[i] = i_packetizer.data_ptr[i];
 302   2          }
 303   1      
 304   1          if (size < i_packetizer.pkt_size)
 305   1              stall_data_size0 = 1;
 306   1          // Tell the USB-controller how many bytes to send
 307   1          // If a IN is received from host after this the USB-controller will send the data
 308   1          in0bc = size;
 309   1      
 310   1          // Update the packetizer data
 311   1          i_packetizer.data_ptr += size;
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 27  

 312   1          i_packetizer.data_size -= size;
 313   1      
 314   1          return;
 315   1      }
 316          
 317          /** This function processes the response from the callback */
 318          static void usb_process_dev_req_cb_response(void)
 319          {
 320   1          uint8_t *data_ptr;
 321   1          uint8_t data_size;
 322   1          hal_usb_dev_req_resp_t ret = g_hal_usb.device_req(&req, &data_ptr, &data_size);
 323   1      
 324   1          switch(ret)
 325   1          {
 326   2              case DATA:
 327   2                  packetize((uint8_t *)data_ptr, MIN(req.wLength, data_size));
 328   2                  packetizer_isr_ep0_in();
 329   2                  break;
 330   2              case NO_RESPONSE:
 331   2                  break;
 332   2              case EMPTY_RESPONSE:
 333   2              case NAK:
 334   2                  USB_EP0_HSNAK();
 335   2                  break;
 336   2              case ACK:
 337   2                  out0bc = 0xff;
 338   2                  break;
 339   2              case STALL:
 340   2              default:
 341   2                  USB_EP0_STALL();
 342   2                  break;
 343   2          }
 344   1      }
 345          
 346          static void usb_process_get_status(void)
 347          {
 348   1          uint8_t xdata *ptr;
 349   1      
 350   1          if(g_hal_usb.state == ADDRESSED)
 351   1          {
 352   2              if(req.wIndex != 0x00)
 353   2              {
 354   3                  USB_EP0_STALL();
 355   3              }
 356   2              else
 357   2              {
 358   3                  in0buf[0] = in0buf[1] = 
 359   3                      ((g_hal_usb.descs.conf->conf.bmAttributes & 0x40 ) >> 6); // D0 - 0: bus powered, 1: self 
             -powered
 360   3                  in0bc = 0x02;
 361   3              }
 362   2          }
 363   1          else if(g_hal_usb.state == CONFIGURED)
 364   1          {
 365   2              in0buf[1] = 0x00;
 366   2              switch(req.bmRequestType)
 367   2              {
 368   3                  case 0x80: // Device
 369   3                      if((g_hal_usb.bm_state & USB_BM_STATE_ALLOW_REMOTE_WAKEUP ) == USB_BM_STATE_ALLOW_REMOTE_W
             -AKEUP)
 370   3                      {
 371   4                          in0buf[0] = 0x02;
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 28  

 372   4                      }
 373   3                      else
 374   3                      {
 375   4                          in0buf[0] = 0x00;
 376   4                      }
 377   3      
 378   3                      in0buf[0] |= ((g_hal_usb.descs.conf->conf.bmAttributes & 0x40 ) >> 6); // D0 - 0: bus powe
             -red, 1: self powered
 379   3                      in0bc = 0x02;
 380   3                      break;
 381   3                  case 0x81: // Interface
 382   3                      in0buf[0] = 0x00;
 383   3                      in0bc = 0x02;
 384   3                      break;
 385   3                  case 0x82: // Endpoint
 386   3                      if((req.wIndex & 0x80) == 0x80) // IN endpoints
 387   3                      {
 388   4                          ptr = CALCULATE_CS_IN_PTR(req.wIndex);
 389   4                      }
 390   3                      else
 391   3                      {
 392   4                          ptr = CALCULATE_CS_OUT_PTR(req.wIndex);
 393   4                      }
 394   3      
 395   3                      in0buf[0] = *ptr & 0x01;
 396   3                      in0bc = 0x02;
 397   3                      break;
 398   3                  default:
 399   3                      USB_EP0_STALL();
 400   3                      break;
 401   3              } // switch(req.bmRequestType) --end--
 402   2          }
 403   1          else
 404   1          {
 405   2              // We should not be in this state
 406   2              USB_EP0_STALL();
 407   2          }
 408   1      }
 409          
 410          static void usb_process_get_descriptor(void)
 411          {
 412   1          // Switch on descriptor type
 413   1          switch(req.wValueMsb)
 414   1          {
 415   2              case USB_DESC_DEVICE:
 416   2                  packetize((uint8_t *)g_hal_usb.descs.dev,
 417   2                  MIN(req.wLength, sizeof(hal_usb_dev_desc_t)));
 418   2                  packetizer_isr_ep0_in();
 419   2                  break;
 420   2              case USB_DESC_CONFIGURATION:
 421   2                  // For now we just support one configuration. The asked configuration is stored in LSB(wValue)
             -.
 422   2                  packetize((uint8_t *)g_hal_usb.descs.conf,
 423   2                      MIN(req.wLength, sizeof(usb_conf_desc_templ_t)));
 424   2                      packetizer_isr_ep0_in();
 425   2                  break;
 426   2              case USB_DESC_STRING:
 427   2                  // For now we just support english as string descriptor language.
 428   2                  if(req.wValueLsb == 0x00)
 429   2                  {
 430   3                      packetize(g_hal_usb.descs.string_zero, MIN(req.wLength, sizeof(g_hal_usb.descs.string_zero
             -)));
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 29  

 431   3                      packetizer_isr_ep0_in();
 432   3                  }
 433   2                  else
 434   2                  {
 435   3                      if((req.wValueLsb - 1 ) < USB_STRING_DESC_COUNT)
 436   3                      {
 437   4                          packetize((uint8_t *)(g_hal_usb.descs.string->idx[req.wValueLsb-1]),
 438   4                              MIN(req.wLength, g_hal_usb.descs.string->idx[req.wValueLsb-1][0]));
 439   4                          packetizer_isr_ep0_in();
 440   4                      }
 441   3                      else
 442   3                      {
 443   4                          USB_EP0_STALL();
 444   4                      }
 445   3                  }
 446   2                  break;
 447   2              case USB_DESC_INTERFACE:
 448   2              case USB_DESC_ENDPOINT:
 449   2              case USB_DESC_DEVICE_QUAL:
 450   2              case USB_DESC_OTHER_SPEED_CONF:
 451   2              case USB_DESC_INTERFACE_POWER:
 452   2                  USB_EP0_STALL();
 453   2                  break;
 454   2              default:
 455   2                  usb_process_dev_req_cb_response();
 456   2                  break;
 457   2          }
 458   1      }
 459          
 460          static void isr_sudav(void)
 461          {
 462   1          // Parsing the request into request structure
 463   1          req.bmRequestType = setupbuf[0];
 464   1          req.bRequest = setupbuf[1];
 465   1          req.wValueLsb = setupbuf[2];
 466   1          req.wValueMsb = setupbuf[3];
 467   1          req.wIndex = setupbuf[4];
 468   1          req.wLength = setupbuf[6];
 469   1          if (setupbuf[7] > 0)
 470   1          {
 471   2              req.wLength = 0xff; // We truncate packets requests longer then 255 bytes
 472   2          }
 473   1      
 474   1           // bmRequestType = 0 00 xxxxx : Data transfer direction: Host-to-device Type: Standard
 475   1          if((req.bmRequestType & 0x60) == 0x00)
 476   1          {
 477   2              switch(req.bRequest)
 478   2              {
 479   3                  case USB_REQ_GET_DESCRIPTOR:
 480   3                      usb_process_get_descriptor();
 481   3                      break;
 482   3                  case USB_REQ_GET_STATUS:
 483   3                      usb_process_get_status();
 484   3                      break;           
 485   3                  case USB_REQ_CLEAR_FEATURE:
 486   3                  case USB_REQ_SET_FEATURE: 
 487   3                      switch(req.bmRequestType)
 488   3                      {
 489   4                          case 0x00: // Device
 490   4                              if(req.wValueLsb == USB_DEVICE_REMOTE_WAKEUP)
 491   4                              {
 492   5                                  if (req.bRequest == USB_REQ_CLEAR_FEATURE) 
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 30  

 493   5                                      g_hal_usb.bm_state &= ~(USB_BM_STATE_ALLOW_REMOTE_WAKEUP);
 494   5                                  else
 495   5                                      g_hal_usb.bm_state |= USB_BM_STATE_ALLOW_REMOTE_WAKEUP;
 496   5                                  USB_EP0_HSNAK();
 497   5                              }
 498   4                              else
 499   4                              {
 500   5                                  USB_EP0_STALL();
 501   5                              }
 502   4                              break;
 503   4      
 504   4                          case 0x02: // Endpoint
 505   4                              if(req.wValueLsb == USB_ENDPOINT_HALT)
 506   4                              {
 507   5                                  if (req.bRequest == USB_REQ_CLEAR_FEATURE) 
 508   5                                      hal_usb_endpoint_stall(req.wIndex, false);
 509   5                                  else
 510   5                                      hal_usb_endpoint_stall(req.wIndex, true);
 511   5                                  USB_EP0_HSNAK();
 512   5                              }
 513   4                              else 
 514   4                              {
 515   5                                  USB_EP0_STALL();
 516   5                              }
 517   4                              break;
 518   4                          case 0x01: // Interface
 519   4                          default:
 520   4                              USB_EP0_STALL();
 521   4                              break;
 522   4                      }
 523   3                      break;
 524   3      
 525   3              case USB_REQ_SET_ADDRESS:
 526   3                 g_hal_usb.state = ADDRESSED;
 527   3                 g_hal_usb.current_config = 0x00;
 528   3                 break;
 529   3              case USB_REQ_GET_CONFIGURATION:
 530   3                 switch(g_hal_usb.state)
 531   3                 {
 532   4                     case ADDRESSED:
 533   4                         in0buf[0] = 0x00;
 534   4                         in0bc = 0x01;
 535   4                         break;
 536   4                     case CONFIGURED:
 537   4                         in0buf[0] = g_hal_usb.current_config;
 538   4                         in0bc = 0x01;
 539   4                         break;
 540   4                     default:
 541   4                         USB_EP0_STALL();
 542   4                         break;
 543   4                 }
 544   3                 break;
 545   3              case USB_REQ_SET_CONFIGURATION:
 546   3                 switch(req.wValueLsb)
 547   3                 {
 548   4                     case 0x00:
 549   4                         g_hal_usb.state = ADDRESSED;
 550   4                         g_hal_usb.current_config = 0x00;
 551   4                         USB_EP0_HSNAK();
 552   4                         break;
 553   4                     case 0x01:
 554   4                         g_hal_usb.state = CONFIGURED;
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 31  

 555   4                         g_hal_usb.bm_state |= USB_BM_STATE_CONFIGURED;
 556   4                         g_hal_usb.current_config = 0x01;
 557   4                         USB_EP0_HSNAK();
 558   4                         break;
 559   4                     default:
 560   4                         USB_EP0_STALL();
 561   4                         break;
 562   4                 }
 563   3                 break;
 564   3              case USB_REQ_GET_INTERFACE: // GET_INTERFACE
 565   3                  in0buf[0] = g_hal_usb.current_alt_interface;
 566   3                  in0bc = 0x01;
 567   3                  break;
 568   3              case USB_REQ_SET_DESCRIPTOR:
 569   3              case USB_REQ_SET_INTERFACE: // SET_INTERFACE (We do not support this)
 570   3              case USB_REQ_SYNCH_FRAME:   // SYNCH_FRAME (We do not support this)
 571   3              default:
 572   3                 USB_EP0_STALL();
 573   3                 break;
 574   3              };
 575   2          } 
 576   1          // bmRequestType = 0 01 xxxxx : Data transfer direction: Host-to-device, Type: Class
 577   1          else if((req.bmRequestType & 0x60 ) == 0x20)  // Class request
 578   1          {
 579   2              if(req.wLength != 0 && ((req.bmRequestType & 0x80) == 0x00))
 580   2              {
 581   3                  // If there is a OUT-transaction associated with the Control-Transfer-Write we call the callba
             -ck
 582   3                  // when the OUT-transaction is finished. Note that this function do not handle several out tra
             -nsactions.
 583   3                  out0bc = 0xff;
 584   3              }
 585   2              else
 586   2              {
 587   3                  usb_process_dev_req_cb_response();
 588   3              }
 589   2              // Call the callback function. Data to be sent back to the host is store by the callback in data_p
             -tr and the size in data_size.
 590   2          } 
 591   1          else  // Unknown request type
 592   1          {
 593   2              USB_EP0_STALL();
 594   2          }
 595   1      }
 596          
 597          static void isr_suspend(void)
 598          {
 599   1          uint8_t allow_remote_wu = 0;
 600   1      
 601   1          g_hal_usb.bm_state &= ~(USB_BM_STATE_HOST_WU); // We clear the flag that indicates that the host awoke
             - the MCU via USB here
 602   1       
 603   1          if( g_hal_usb.state == CONFIGURED )
 604   1          {
 605   2              if( ( g_hal_usb.bm_state & USB_BM_STATE_ALLOW_REMOTE_WAKEUP ) == USB_BM_STATE_ALLOW_REMOTE_WAKEUP 
             -)
 606   2              {
 607   3                  allow_remote_wu = 1;
 608   3              }
 609   2          }
 610   1      
 611   1          g_hal_usb.state = SUSPENDED;
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 32  

 612   1      
 613   1          if( g_hal_usb.suspend != NULL )
 614   1          {
 615   2              g_hal_usb.suspend(allow_remote_wu);
 616   2          }
 617   1      }
 618          
 619          static void isr_usbreset(void)
 620          {
 621   1          g_hal_usb.state = DEFAULT;
 622   1          g_hal_usb.current_config = 0;
 623   1          g_hal_usb.current_alt_interface = 0;
 624   1          g_hal_usb.bm_state = 0;
 625   1          if( g_hal_usb.reset != NULL ) g_hal_usb.reset();
 626   1      }
 627          
 628          
 629          //lint --e{528} suppress "usb_wu() not referenced"
 630          void usb_wu(void) interrupt USB_WU // address: 0x005b
 631          {
 632   1      #define ICH4
 633   1      #ifdef ICH4
 634   1          uint8_t t;
 635   1      #endif
 636   1      
 637   1          // Check if the wakeup source is the pin to the USB controller
 638   1          // If it is by the pin to the USB controller we want to start
 639   1          // a remote wakeup
 640   1          if( ( usbcs & 0x80 ) == 0x80 )
 641   1          {
 642   2              // Reset the wakesrc indicator
 643   2              usbcs = 0x80;
 644   2      
 645   2              // If we are allowed to perform a remote wakeup do that
 646   2              if( ( g_hal_usb.bm_state & USB_BM_STATE_ALLOW_REMOTE_WAKEUP ) == USB_BM_STATE_ALLOW_REMOTE_WAKEUP 
             -)
 647   2              {
 648   3      #ifdef ICH4
 649   3                  // Force the J state on the USB lines
 650   3                  usbcs |= 0x02;
 651   3      
 652   3                  // Typical 5.4us delay
 653   3                  _nop_();
 654   3                  _nop_();
 655   3      
 656   3                  t = usbcs;
 657   3      
 658   3                  // Stop J state on the USB lines
 659   3                  t &= ~0x02;
 660   3      
 661   3                  // Signal remote resume
 662   3                  t |= 0x01;
 663   3      
 664   3                  // We have to set this register in one operation to avoid
 665   3                  // idle state is restored between the forced J and resume state
 666   3                  usbcs = t;
 667   3      #else
                          usbcs |= 0x01;  // Turn on the resume signal on the USB bus
              #endif
 670   3                  delay_ms(7); //.1.7.7 Resume: The remote wakeup device must hold the resume signaling for at 
 671   3                                // least 1 ms but for no more than 15ms
 672   3      
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 33  

 673   3                  usbcs &= ~0x01; // Turn off the resume signal on the USB bus
 674   3              }
 675   2          }
 676   1          else 
 677   1          {
 678   2              // We are awoken by the bus
 679   2              g_hal_usb.bm_state |= USB_BM_STATE_HOST_WU;
 680   2          }
 681   1      
 682   1          if((g_hal_usb.bm_state & USB_BM_STATE_CONFIGURED ) == USB_BM_STATE_CONFIGURED)
 683   1          {
 684   2              g_hal_usb.state = CONFIGURED;
 685   2          }
 686   1          else
 687   1          {
 688   2              g_hal_usb.state = DEFAULT;
 689   2          }
 690   1      
 691   1          // Call resume callback
 692   1          g_hal_usb.resume();
 693   1      }
 694          
 695          // This function processes the response from the EP callback
 696          static void usb_process_ep_response(uint8_t ret, uint8_t xdata* cs_ptr, uint8_t xdata* bc_ptr)
 697          {
 698   1          if( ret == 0xff ) // Clear the OUTx busy flag enabling reception of the next OUT from USB-host
 699   1          {
 700   2              *bc_ptr = 0xff;
 701   2          }
 702   1          else if( ( ret & 0x80 ) == 0x80 )  // STALL
 703   1          {
 704   2              *cs_ptr = 0x01;
 705   2          }
 706   1          else if( ( ret & 0x60 ) == 0x60 ) // NAK
 707   1          {
 708   2              *cs_ptr = 0x02;
 709   2          }
 710   1          else if( ret == 0 ) // Zero length data
 711   1          {
 712   2              *bc_ptr = 0;
 713   2          }
 714   1          else
 715   1          {
 716   2              *bc_ptr = ret;
 717   2          }
 718   1      }
 719          
 720          void usb_irq(void) interrupt USB_IRQ // address: 0x0063
 721          {
 722   1          uint8_t ep;
 723   1          uint8_t ret;
 724   1          uint8_t xdata *cs_ptr;
 725   1          uint8_t xdata *buf_ptr;
 726   1          uint8_t xdata *bc_ptr;
 727   1      
 728   1          P0_5 = 1;
 729   1      
 730   1          switch(ivec)
 731   1          {
 732   2              case INT_SUDAV:
 733   2                  usbirq = 0x01;
 734   2                  isr_sudav();
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 34  

 735   2                  break;
 736   2              case INT_SOF:
 737   2                  usbirq = 0x02;
 738   2                  break;
 739   2              case INT_SUTOK:
 740   2                  usbirq = 0x04;
 741   2                  i_packetizer.data_ptr = NULL;
 742   2                  i_packetizer.data_size = 0;
 743   2                  i_packetizer.pkt_size = 0;
 744   2                  stall_data_size0 = 0;
 745   2                  break;
 746   2              case INT_SUSPEND:
 747   2                  usbirq = 0x08;
 748   2                  isr_suspend();
 749   2                  break;
 750   2              case INT_USBRESET:
 751   2                  usbirq = 0x10;
 752   2                  isr_usbreset();
 753   2                  break;
 754   2              case INT_EP0IN:
 755   2                  in_irq = 0x01;
 756   2                  packetizer_isr_ep0_in();
 757   2                  break;
 758   2              case INT_EP0OUT:
 759   2                  out_irq = 0x01;
 760   2                  i_packetizer.data_size = 0;
 761   2                  usb_process_dev_req_cb_response();
 762   2                  break;
 763   2              case INT_EP1IN:
 764   2              case INT_EP2IN:
 765   2              case INT_EP3IN:
 766   2              case INT_EP4IN:
 767   2              case INT_EP5IN:
 768   2                  // Calculate IN endpoint number
 769   2                  ep = (ivec - INT_EP0IN ) >> 3;// INT_EP2IN - INT_EP1IN == 8 ;   
 770   2                  // Clear interrupt 
 771   2                  in_irq = ( 1 << ep );
 772   2          
 773   2                  cs_ptr = CALCULATE_CS_IN_PTR(ep);
 774   2                  buf_ptr = CALCULATE_BUF_IN_PTR(ep);
 775   2                  bc_ptr = CALCULATE_BC_IN_PTR(ep);
 776   2              
 777   2                  // Call registered callback
 778   2                  //ret = i_endpoint_in_isr[ep - 1](buf_ptr, bc_ptr);
 779   2               //   ep1_sent = true;   
 780   2                              //return 0x60; // NAK 
 781   2                              usb_process_ep_response(0x60, cs_ptr, bc_ptr);
 782   2                  break;
 783   2              case INT_EP1OUT:
 784   2              case INT_EP2OUT:
 785   2              case INT_EP3OUT:
 786   2              case INT_EP4OUT:
 787   2              case INT_EP5OUT:
 788   2                  // Calculate OUT endpoint number
 789   2                  ep = (ivec - INT_EP0OUT) >> 3;          // INT_EP2OUT - INT_EP1OUT == 8
 790   2         
 791   2                  // Clear interrupt
 792   2                  out_irq = ( 1 << ep );
 793   2                  
 794   2                  cs_ptr = CALCULATE_CS_OUT_PTR(ep);
 795   2                  buf_ptr = CALCULATE_BUF_OUT_PTR(ep);
 796   2                  bc_ptr = CALCULATE_BC_OUT_PTR(ep);
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 35  

 797   2          
 798   2                  // Call registered callback
 799   2                  //ret = (i_endpoint_out_isr[ep - 1])(buf_ptr, bc_ptr);
 800   2                  ret = ep_1_out_cb(buf_ptr,bc_ptr);  
 801   2                              usb_process_ep_response(ret, cs_ptr, bc_ptr);
 802   2                  break;
 803   2              default:
 804   2                  break;
 805   2           };
 806   1      
 807   1               P0_5 = 0;
 808   1      }
 809          
 810          static void delay_ms(uint8_t ms)
 811          {
 812   1          uint8_t i, j, k;
 813   1          
 814   1          for(i = 0; i < ms; i++ )
 815   1          {
 816   2              for(j = 0; j < 98; j++)
 817   2              {
 818   3                  for (k = 0; k < 22; k++)
 819   3                  {
 820   4                      _nop_();
 821   4                  }
 822   3              }
 823   2          }
 824   1      }
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 36  

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION _hal_usb_init (BEGIN)
                                           ; SOURCE LINE # 56
0000 900000      R     MOV     DPTR,#device_req
0003 EB                MOV     A,R3
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 EA                MOV     A,R2
0007 F0                MOVX    @DPTR,A
0008 A3                INC     DPTR
0009 E9                MOV     A,R1
000A F0                MOVX    @DPTR,A
;---- Variable 'usb_disconnect' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 57
                                           ; SOURCE LINE # 59
000B 900000      R     MOV     DPTR,#g_hal_usb
000E 74FF              MOV     A,#0FFH
0010 F0                MOVX    @DPTR,A
0011 A3                INC     DPTR
0012 7400        E     MOV     A,#HIGH g_usb_dev_desc
0014 F0                MOVX    @DPTR,A
0015 A3                INC     DPTR
0016 7400        E     MOV     A,#LOW g_usb_dev_desc
0018 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 60
0019 F9                MOV     R1,A
001A 900000      R     MOV     DPTR,#g_hal_usb
001D 74FF              MOV     A,#0FFH
001F F0                MOVX    @DPTR,A
0020 A3                INC     DPTR
0021 7400        E     MOV     A,#HIGH g_usb_dev_desc
0023 F0                MOVX    @DPTR,A
0024 A3                INC     DPTR
0025 E9                MOV     A,R1
0026 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 61
0027 A3                INC     DPTR
0028 74FF              MOV     A,#0FFH
002A F0                MOVX    @DPTR,A
002B A3                INC     DPTR
002C 7400        E     MOV     A,#HIGH g_usb_conf_desc
002E F0                MOVX    @DPTR,A
002F A3                INC     DPTR
0030 7400        E     MOV     A,#LOW g_usb_conf_desc
0032 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 62
0033 A3                INC     DPTR
0034 74FF              MOV     A,#0FFH
0036 F0                MOVX    @DPTR,A
0037 A3                INC     DPTR
0038 7400        E     MOV     A,#HIGH g_usb_string_desc
003A F0                MOVX    @DPTR,A
003B A3                INC     DPTR
003C 7400        E     MOV     A,#LOW g_usb_string_desc
003E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 65
003F A3                INC     DPTR
0040 7404              MOV     A,#04H
0042 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 66
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 37  

0043 A3                INC     DPTR
0044 14                DEC     A
0045 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 67
0046 A3                INC     DPTR
0047 7409              MOV     A,#09H
0049 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 68
004A A3                INC     DPTR
004B 7404              MOV     A,#04H
004D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 71
004E 900000      R     MOV     DPTR,#g_hal_usb+010H
0051 7402              MOV     A,#02H
0053 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 72
0054 E4                CLR     A
0055 900000      R     MOV     DPTR,#g_hal_usb+0DH
0058 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 73
0059 900000      R     MOV     DPTR,#stall_data_size0
005C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 76
005D 900000      R     MOV     DPTR,#g_hal_usb+0EH
0060 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 77
0061 A3                INC     DPTR
0062 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 80
0063 900000      R     MOV     DPTR,#device_req
0066 E0                MOVX    A,@DPTR
0067 F9                MOV     R1,A
0068 A3                INC     DPTR
0069 E0                MOVX    A,@DPTR
006A FA                MOV     R2,A
006B A3                INC     DPTR
006C E0                MOVX    A,@DPTR
006D 900000      R     MOV     DPTR,#g_hal_usb+011H
0070 C9                XCH     A,R1
0071 F0                MOVX    @DPTR,A
0072 A3                INC     DPTR
0073 EA                MOV     A,R2
0074 F0                MOVX    @DPTR,A
0075 A3                INC     DPTR
0076 E9                MOV     A,R1
0077 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 81
0078 900000      R     MOV     DPTR,#reset
007B E0                MOVX    A,@DPTR
007C F9                MOV     R1,A
007D A3                INC     DPTR
007E E0                MOVX    A,@DPTR
007F FA                MOV     R2,A
0080 A3                INC     DPTR
0081 E0                MOVX    A,@DPTR
0082 900000      R     MOV     DPTR,#g_hal_usb+014H
0085 C9                XCH     A,R1
0086 F0                MOVX    @DPTR,A
0087 A3                INC     DPTR
0088 EA                MOV     A,R2
0089 F0                MOVX    @DPTR,A
008A A3                INC     DPTR
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 38  

008B E9                MOV     A,R1
008C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 82
008D 900000      R     MOV     DPTR,#resume
0090 E0                MOVX    A,@DPTR
0091 F9                MOV     R1,A
0092 A3                INC     DPTR
0093 E0                MOVX    A,@DPTR
0094 FA                MOV     R2,A
0095 A3                INC     DPTR
0096 E0                MOVX    A,@DPTR
0097 900000      R     MOV     DPTR,#g_hal_usb+017H
009A C9                XCH     A,R1
009B F0                MOVX    @DPTR,A
009C A3                INC     DPTR
009D EA                MOV     A,R2
009E F0                MOVX    @DPTR,A
009F A3                INC     DPTR
00A0 E9                MOV     A,R1
00A1 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 83
00A2 900000      R     MOV     DPTR,#suspend
00A5 E0                MOVX    A,@DPTR
00A6 F9                MOV     R1,A
00A7 A3                INC     DPTR
00A8 E0                MOVX    A,@DPTR
00A9 FA                MOV     R2,A
00AA A3                INC     DPTR
00AB E0                MOVX    A,@DPTR
00AC 900000      R     MOV     DPTR,#g_hal_usb+01AH
00AF C9                XCH     A,R1
00B0 F0                MOVX    @DPTR,A
00B1 A3                INC     DPTR
00B2 EA                MOV     A,R2
00B3 F0                MOVX    @DPTR,A
00B4 A3                INC     DPTR
00B5 E9                MOV     A,R1
00B6 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 86
00B7 EF                MOV     A,R7
00B8 6013              JZ      ?C0001
                                           ; SOURCE LINE # 87
                                           ; SOURCE LINE # 88
00BA 90C7D6            MOV     DPTR,#usbcs
00BD E0                MOVX    A,@DPTR
00BE 4408              ORL     A,#08H
00C0 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 89
00C1 7F32              MOV     R7,#032H
00C3 120000      R     LCALL   _delay_ms
                                           ; SOURCE LINE # 90
00C6 90C7D6            MOV     DPTR,#usbcs
00C9 E0                MOVX    A,@DPTR
00CA 54F7              ANL     A,#0F7H
00CC F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 91
00CD         ?C0001:
                                           ; SOURCE LINE # 94
00CD D2BB              SETB    USBWU
                                           ; SOURCE LINE # 95
00CF D2BC              SETB    USB
                                           ; SOURCE LINE # 97
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 39  

00D1 90C7AE            MOV     DPTR,#usbien
00D4 741D              MOV     A,#01DH
00D6 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 99
00D7 90C7AC            MOV     DPTR,#in_ien
00DA 7401              MOV     A,#01H
00DC F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 100
00DD 90C7A9            MOV     DPTR,#in_irq
00E0 741F              MOV     A,#01FH
00E2 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 101
00E3 90C7AD            MOV     DPTR,#out_ien
00E6 7401              MOV     A,#01H
00E8 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 102
00E9 90C7AA            MOV     DPTR,#out_irq
00EC 741F              MOV     A,#01FH
00EE F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 105
00EF 90C781            MOV     DPTR,#bout1addr
00F2 7410              MOV     A,#010H
00F4 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 106
00F5 A3                INC     DPTR
00F6 7420              MOV     A,#020H
00F8 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 107
00F9 A3                INC     DPTR
00FA 7430              MOV     A,#030H
00FC F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 108
00FD A3                INC     DPTR
00FE 7440              MOV     A,#040H
0100 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 109
0101 A3                INC     DPTR
0102 7450              MOV     A,#050H
0104 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 111
0105 90C788            MOV     DPTR,#binstaddr
0108 74C0              MOV     A,#0C0H
010A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 112
010B A3                INC     DPTR
010C 7410              MOV     A,#010H
010E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 113
010F A3                INC     DPTR
0110 7420              MOV     A,#020H
0112 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 114
0113 A3                INC     DPTR
0114 7430              MOV     A,#030H
0116 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 115
0117 A3                INC     DPTR
0118 7440              MOV     A,#040H
011A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 116
011B A3                INC     DPTR
011C 7450              MOV     A,#050H
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 40  

011E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 119
011F 90C7DE            MOV     DPTR,#inbulkval
0122 7401              MOV     A,#01H
0124 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 120
0125 A3                INC     DPTR
0126 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 121
0127 E4                CLR     A
0128 A3                INC     DPTR
0129 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 122
012A A3                INC     DPTR
012B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 125
012C 22                RET     
             ; FUNCTION _hal_usb_init (END)

             ; FUNCTION _hal_usb_endpoint_stall (BEGIN)
                                           ; SOURCE LINE # 127
;---- Variable 'ep_num' assigned to Register 'R7' ----
;---- Variable 'stall' assigned to Register 'R5' ----
                                           ; SOURCE LINE # 128
                                           ; SOURCE LINE # 132
0000 EF                MOV     A,R7
0001 547F              ANL     A,#07FH
0003 14                DEC     A
0004 25E0              ADD     A,ACC
0006 FE                MOV     R6,A
;---- Variable 'temp' assigned to Register 'R6' ----
                                           ; SOURCE LINE # 135
0007 EF                MOV     A,R7
0008 30E70B            JNB     ACC.7,?C0003
                                           ; SOURCE LINE # 136
                                           ; SOURCE LINE # 138
000B EE                MOV     A,R6
000C 7E00              MOV     R6,#00H
000E 24B6              ADD     A,#LOW in1cs
0010 F9                MOV     R1,A
0011 EE                MOV     A,R6
0012 34C7              ADDC    A,#HIGH in1cs
                                           ; SOURCE LINE # 139
0014 800B              SJMP    ?C0253
0016         ?C0003:
                                           ; SOURCE LINE # 141
                                           ; SOURCE LINE # 143
0016 AF06              MOV     R7,AR6
0018 7E00              MOV     R6,#00H
001A 74C6              MOV     A,#LOW out1cs
001C 2F                ADD     A,R7
001D F9                MOV     R1,A
001E EE                MOV     A,R6
001F 34C7              ADDC    A,#HIGH out1cs
0021         ?C0253:
0021 AF01              MOV     R7,AR1
0023 900000      R     MOV     DPTR,#cs_ptr
0026 F0                MOVX    @DPTR,A
0027 A3                INC     DPTR
0028 EF                MOV     A,R7
0029 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 144
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 41  

002A         ?C0004:
                                           ; SOURCE LINE # 146
002A ED                MOV     A,R5
002B 900000      R     MOV     DPTR,#cs_ptr
002E B4010C            CJNE    A,#01H,?C0005
                                           ; SOURCE LINE # 147
                                           ; SOURCE LINE # 149
0031 E0                MOVX    A,@DPTR
0032 FE                MOV     R6,A
0033 A3                INC     DPTR
0034 E0                MOVX    A,@DPTR
0035 F582              MOV     DPL,A
0037 8E83              MOV     DPH,R6
0039 7401              MOV     A,#01H
003B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 150
003C 22                RET     
003D         ?C0005:
                                           ; SOURCE LINE # 152
                                           ; SOURCE LINE # 154
003D E0                MOVX    A,@DPTR
003E FE                MOV     R6,A
003F A3                INC     DPTR
0040 E0                MOVX    A,@DPTR
0041 F582              MOV     DPL,A
0043 8E83              MOV     DPH,R6
0045 E4                CLR     A
0046 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 155
                                           ; SOURCE LINE # 156
0047         ?C0007:
0047 22                RET     
             ; FUNCTION _hal_usb_endpoint_stall (END)

             ; FUNCTION hal_usb_get_address (BEGIN)
                                           ; SOURCE LINE # 158
                                           ; SOURCE LINE # 159
                                           ; SOURCE LINE # 160
0000 90C7DB            MOV     DPTR,#fnaddr
0003 E0                MOVX    A,@DPTR
0004 FF                MOV     R7,A
                                           ; SOURCE LINE # 161
0005         ?C0008:
0005 22                RET     
             ; FUNCTION hal_usb_get_address (END)

             ; FUNCTION _hal_usb_endpoint_config (BEGIN)
                                           ; SOURCE LINE # 163
0000 900000      R     MOV     DPTR,#endpoint_isr
0003 EB                MOV     A,R3
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 EA                MOV     A,R2
0007 F0                MOVX    @DPTR,A
0008 A3                INC     DPTR
0009 E9                MOV     A,R1
000A F0                MOVX    @DPTR,A
;---- Variable 'ep_num' assigned to Register 'R4' ----
000B AC07              MOV     R4,AR7
;---- Variable 'ep_size' assigned to Register 'R5' ----
                                           ; SOURCE LINE # 164
                                           ; SOURCE LINE # 167
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 42  

000D EC                MOV     A,R4
000E 547F              ANL     A,#07FH
0010 FF                MOV     R7,A
0011 14                DEC     A
0012 FE                MOV     R6,A
;---- Variable 'temp' assigned to Register 'R6' ----
                                           ; SOURCE LINE # 168
0013 7401              MOV     A,#01H
0015 A807              MOV     R0,AR7
0017 08                INC     R0
0018 8002              SJMP    ?C0242
001A         ?C0241:
001A C3                CLR     C
001B 33                RLC     A
001C         ?C0242:
001C D8FC              DJNZ    R0,?C0241
001E 900000      R     MOV     DPTR,#stemp
0021 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 171
                                           ; SOURCE LINE # 173
0022 EC                MOV     A,R4
0023 30E759            JNB     ACC.7,?C0009
                                           ; SOURCE LINE # 174
                                           ; SOURCE LINE # 175
0026 900000      R     MOV     DPTR,#endpoint_isr
0029 E0                MOVX    A,@DPTR
002A FB                MOV     R3,A
002B A3                INC     DPTR
002C E0                MOVX    A,@DPTR
002D FA                MOV     R2,A
002E A3                INC     DPTR
002F E0                MOVX    A,@DPTR
0030 F9                MOV     R1,A
0031 EE                MOV     A,R6
0032 75F003            MOV     B,#03H
0035 A4                MUL     AB
0036 2400        R     ADD     A,#LOW i_endpoint_in_isr
0038 F582              MOV     DPL,A
003A E4                CLR     A
003B 3400        R     ADDC    A,#HIGH i_endpoint_in_isr
003D F583              MOV     DPH,A
003F EB                MOV     A,R3
0040 F0                MOVX    @DPTR,A
0041 A3                INC     DPTR
0042 EA                MOV     A,R2
0043 F0                MOVX    @DPTR,A
0044 A3                INC     DPTR
0045 E9                MOV     A,R1
0046 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 176
0047 900000      R     MOV     DPTR,#endpoint_isr
004A E0                MOVX    A,@DPTR
004B FB                MOV     R3,A
004C A3                INC     DPTR
004D E0                MOVX    A,@DPTR
004E FA                MOV     R2,A
004F A3                INC     DPTR
0050 E0                MOVX    A,@DPTR
0051 4A                ORL     A,R2
0052 4B                ORL     A,R3
0053 90C7AC            MOV     DPTR,#in_ien
0056 6014              JZ      ?C0010
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 43  

                                           ; SOURCE LINE # 177
                                           ; SOURCE LINE # 179
0058 E0                MOVX    A,@DPTR
0059 FF                MOV     R7,A
005A 900000      R     MOV     DPTR,#stemp
005D E0                MOVX    A,@DPTR
005E FE                MOV     R6,A
005F EF                MOV     A,R7
0060 4E                ORL     A,R6
0061 90C7AC            MOV     DPTR,#in_ien
0064 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 180
0065 90C7DE            MOV     DPTR,#inbulkval
0068 E0                MOVX    A,@DPTR
0069 4E                ORL     A,R6
006A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 181
006B 22                RET     
006C         ?C0010:
                                           ; SOURCE LINE # 183
                                           ; SOURCE LINE # 185
006C E0                MOVX    A,@DPTR
006D FF                MOV     R7,A
006E 900000      R     MOV     DPTR,#stemp
0071 E0                MOVX    A,@DPTR
0072 F4                CPL     A
0073 FE                MOV     R6,A
0074 EF                MOV     A,R7
0075 5E                ANL     A,R6
0076 90C7AC            MOV     DPTR,#in_ien
0079 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 186
007A 90C7DE            MOV     DPTR,#inbulkval
                                           ; SOURCE LINE # 187
                                           ; SOURCE LINE # 188
007D 806A              SJMP    ?C0254
007F         ?C0009:
                                           ; SOURCE LINE # 190
                                           ; SOURCE LINE # 191
007F 900000      R     MOV     DPTR,#endpoint_isr
0082 E0                MOVX    A,@DPTR
0083 FB                MOV     R3,A
0084 A3                INC     DPTR
0085 E0                MOVX    A,@DPTR
0086 FA                MOV     R2,A
0087 A3                INC     DPTR
0088 E0                MOVX    A,@DPTR
0089 F9                MOV     R1,A
008A EE                MOV     A,R6
008B 75F003            MOV     B,#03H
008E A4                MUL     AB
008F 2400        R     ADD     A,#LOW i_endpoint_out_isr
0091 F582              MOV     DPL,A
0093 E4                CLR     A
0094 3400        R     ADDC    A,#HIGH i_endpoint_out_isr
0096 F583              MOV     DPH,A
0098 EB                MOV     A,R3
0099 F0                MOVX    @DPTR,A
009A A3                INC     DPTR
009B EA                MOV     A,R2
009C F0                MOVX    @DPTR,A
009D A3                INC     DPTR
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 44  

009E E9                MOV     A,R1
009F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 192
00A0 900000      R     MOV     DPTR,#endpoint_isr
00A3 E0                MOVX    A,@DPTR
00A4 FB                MOV     R3,A
00A5 A3                INC     DPTR
00A6 E0                MOVX    A,@DPTR
00A7 FA                MOV     R2,A
00A8 A3                INC     DPTR
00A9 E0                MOVX    A,@DPTR
00AA 4A                ORL     A,R2
00AB 4B                ORL     A,R3
00AC 90C7AD            MOV     DPTR,#out_ien
00AF 6027              JZ      ?C0013
                                           ; SOURCE LINE # 193
                                           ; SOURCE LINE # 195
00B1 E0                MOVX    A,@DPTR
00B2 FF                MOV     R7,A
00B3 900000      R     MOV     DPTR,#stemp
00B6 E0                MOVX    A,@DPTR
00B7 FE                MOV     R6,A
00B8 EF                MOV     A,R7
00B9 4E                ORL     A,R6
00BA 90C7AD            MOV     DPTR,#out_ien
00BD F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 196
00BE 90C7DF            MOV     DPTR,#outbulkval
00C1 E0                MOVX    A,@DPTR
00C2 4E                ORL     A,R6
00C3 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 199
00C4 EC                MOV     A,R4
00C5 75F002            MOV     B,#02H
00C8 A4                MUL     AB
00C9 24C5              ADD     A,#LOW out0bc
00CB F9                MOV     R1,A
00CC 74C7              MOV     A,#HIGH out0bc
00CE 35F0              ADDC    A,B
;---- Variable 'bc_ptr' assigned to Register 'DPTR' ----
00D0 8982              MOV     DPL,R1
00D2 F583              MOV     DPH,A
                                           ; SOURCE LINE # 200
00D4 74FF              MOV     A,#0FFH
00D6 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 201
00D7 22                RET     
00D8         ?C0013:
                                           ; SOURCE LINE # 203
                                           ; SOURCE LINE # 205
00D8 E0                MOVX    A,@DPTR
00D9 FF                MOV     R7,A
00DA 900000      R     MOV     DPTR,#stemp
00DD E0                MOVX    A,@DPTR
00DE F4                CPL     A
00DF FE                MOV     R6,A
00E0 EF                MOV     A,R7
00E1 5E                ANL     A,R6
00E2 90C7AD            MOV     DPTR,#out_ien
00E5 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 206
00E6 90C7DF            MOV     DPTR,#outbulkval
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 45  

00E9         ?C0254:
00E9 E0                MOVX    A,@DPTR
00EA 5E                ANL     A,R6
00EB F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 207
                                           ; SOURCE LINE # 208
                                           ; SOURCE LINE # 209
00EC         ?C0015:
00EC 22                RET     
             ; FUNCTION _hal_usb_endpoint_config (END)

             ; FUNCTION hal_usb_wakeup (BEGIN)
                                           ; SOURCE LINE # 211
                                           ; SOURCE LINE # 212
                                           ; SOURCE LINE # 214
0000 900000      R     MOV     DPTR,#g_hal_usb+0DH
0003 E0                MOVX    A,@DPTR
0004 30E10B            JNB     ACC.1,?C0017
                                           ; SOURCE LINE # 215
                                           ; SOURCE LINE # 216
0007 75A040            MOV     USBCON,#040H
                                           ; SOURCE LINE # 217
000A 7F01              MOV     R7,#01H
000C 120000      R     LCALL   _delay_ms
                                           ; SOURCE LINE # 218
000F E4                CLR     A
0010 F5A0              MOV     USBCON,A
                                           ; SOURCE LINE # 219
                                           ; SOURCE LINE # 220
0012         ?C0017:
0012 22                RET     
             ; FUNCTION hal_usb_wakeup (END)

             ; FUNCTION hal_usb_reset (BEGIN)
                                           ; SOURCE LINE # 222
                                           ; SOURCE LINE # 223
                                           ; SOURCE LINE # 224
0000 D2A7              SETB    SWRST
                                           ; SOURCE LINE # 225
0002 22                RET     
             ; FUNCTION hal_usb_reset (END)

             ; FUNCTION hal_usb_get_state (BEGIN)
                                           ; SOURCE LINE # 227
                                           ; SOURCE LINE # 228
                                           ; SOURCE LINE # 229
0000 900000      R     MOV     DPTR,#g_hal_usb+010H
0003 E0                MOVX    A,@DPTR
0004 FF                MOV     R7,A
                                           ; SOURCE LINE # 230
0005         ?C0019:
0005 22                RET     
             ; FUNCTION hal_usb_get_state (END)

             ; FUNCTION _hal_usb_send_data (BEGIN)
                                           ; SOURCE LINE # 232
0000 900000      R     MOV     DPTR,#array
0003 EB                MOV     A,R3
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 EA                MOV     A,R2
0007 F0                MOVX    @DPTR,A
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 46  

0008 A3                INC     DPTR
0009 E9                MOV     A,R1
000A F0                MOVX    @DPTR,A
000B 900000      R     MOV     DPTR,#ep_num
000E EF                MOV     A,R7
000F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 233
                                           ; SOURCE LINE # 240
0010 547F              ANL     A,#07FH
0012 75F080            MOV     B,#080H
0015 A4                MUL     AB
0016 FF                MOV     R7,A
0017 C3                CLR     C
0018 7400              MOV     A,#LOW in0buf
001A 9F                SUBB    A,R7
001B F9                MOV     R1,A
001C 74C7              MOV     A,#HIGH in0buf
001E 95F0              SUBB    A,B
0020 AF01              MOV     R7,AR1
0022 900000      R     MOV     DPTR,#buf_ptr
0025 F0                MOVX    @DPTR,A
0026 A3                INC     DPTR
0027 EF                MOV     A,R7
0028 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 241
0029 900000      R     MOV     DPTR,#ep_num
002C E0                MOVX    A,@DPTR
002D 547F              ANL     A,#07FH
002F 75F002            MOV     B,#02H
0032 A4                MUL     AB
0033 24B5              ADD     A,#LOW in0bc
0035 F9                MOV     R1,A
0036 74C7              MOV     A,#HIGH in0bc
0038 35F0              ADDC    A,B
003A AF01              MOV     R7,AR1
003C 900000      R     MOV     DPTR,#bc_ptr
003F F0                MOVX    @DPTR,A
0040 A3                INC     DPTR
0041 EF                MOV     A,R7
0042 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 244
0043 E4                CLR     A
0044 F500        R     MOV     i,A
0046         ?C0020:
0046 900000      R     MOV     DPTR,#count
0049 E0                MOVX    A,@DPTR
004A FF                MOV     R7,A
004B E500        R     MOV     A,i
004D C3                CLR     C
004E 9F                SUBB    A,R7
004F 502A              JNC     ?C0021
                                           ; SOURCE LINE # 245
                                           ; SOURCE LINE # 246
0051 900000      R     MOV     DPTR,#array
0054 E0                MOVX    A,@DPTR
0055 FB                MOV     R3,A
0056 A3                INC     DPTR
0057 E0                MOVX    A,@DPTR
0058 FA                MOV     R2,A
0059 A3                INC     DPTR
005A E0                MOVX    A,@DPTR
005B F9                MOV     R1,A
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 47  

005C 850082      R     MOV     DPL,i
005F 758300            MOV     DPH,#00H
0062 120000      E     LCALL   ?C?CLDOPTR
0065 FF                MOV     R7,A
0066 900000      R     MOV     DPTR,#buf_ptr
0069 E0                MOVX    A,@DPTR
006A FC                MOV     R4,A
006B A3                INC     DPTR
006C E0                MOVX    A,@DPTR
006D 2500        R     ADD     A,i
006F F582              MOV     DPL,A
0071 E4                CLR     A
0072 3C                ADDC    A,R4
0073 F583              MOV     DPH,A
0075 EF                MOV     A,R7
0076 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 247
0077 0500        R     INC     i
0079 80CB              SJMP    ?C0020
007B         ?C0021:
                                           ; SOURCE LINE # 250
007B 900000      R     MOV     DPTR,#count
007E E0                MOVX    A,@DPTR
007F FF                MOV     R7,A
0080 900000      R     MOV     DPTR,#bc_ptr
0083 E0                MOVX    A,@DPTR
0084 FC                MOV     R4,A
0085 A3                INC     DPTR
0086 E0                MOVX    A,@DPTR
0087 F582              MOV     DPL,A
0089 8C83              MOV     DPH,R4
008B EF                MOV     A,R7
008C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 251
008D 22                RET     
             ; FUNCTION _hal_usb_send_data (END)

             ; FUNCTION hal_usb_bus_disconnect (BEGIN)
                                           ; SOURCE LINE # 253
                                           ; SOURCE LINE # 254
                                           ; SOURCE LINE # 255
0000 90C7D6            MOV     DPTR,#usbcs
0003 E0                MOVX    A,@DPTR
0004 4408              ORL     A,#08H
0006 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 256
0007 22                RET     
             ; FUNCTION hal_usb_bus_disconnect (END)

             ; FUNCTION hal_usb_bus_connect (BEGIN)
                                           ; SOURCE LINE # 258
                                           ; SOURCE LINE # 259
                                           ; SOURCE LINE # 260
0000 90C7D6            MOV     DPTR,#usbcs
0003 E0                MOVX    A,@DPTR
0004 54F7              ANL     A,#0F7H
0006 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 261
0007 22                RET     
             ; FUNCTION hal_usb_bus_connect (END)

             ; FUNCTION hal_usb_sleep (BEGIN)
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 48  

                                           ; SOURCE LINE # 263
                                           ; SOURCE LINE # 264
                                           ; SOURCE LINE # 265
0000 75D901            MOV     USBSLP,#01H
                                           ; SOURCE LINE # 266
0003 22                RET     
             ; FUNCTION hal_usb_sleep (END)

             ; FUNCTION _packetize (BEGIN)
                                           ; SOURCE LINE # 268
;---- Variable 'data_size' assigned to Register 'R5' ----
;---- Variable 'data_ptr' assigned to Register 'R1/R2/R3' ----
                                           ; SOURCE LINE # 269
                                           ; SOURCE LINE # 270
0000 900000      R     MOV     DPTR,#i_packetizer
0003 EB                MOV     A,R3
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 EA                MOV     A,R2
0007 F0                MOVX    @DPTR,A
0008 A3                INC     DPTR
0009 E9                MOV     A,R1
000A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 271
000B A3                INC     DPTR
000C ED                MOV     A,R5
000D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 272
000E 900000      R     MOV     DPTR,#g_hal_usb
0011 E0                MOVX    A,@DPTR
0012 FB                MOV     R3,A
0013 A3                INC     DPTR
0014 E0                MOVX    A,@DPTR
0015 FA                MOV     R2,A
0016 A3                INC     DPTR
0017 E0                MOVX    A,@DPTR
0018 F9                MOV     R1,A
0019 900007            MOV     DPTR,#07H
001C 120000      E     LCALL   ?C?CLDOPTR
001F 900000      R     MOV     DPTR,#i_packetizer+04H
0022 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 273
0023 22                RET     
             ; FUNCTION _packetize (END)

             ; FUNCTION packetizer_isr_ep0_in (BEGIN)
                                           ; SOURCE LINE # 276
                                           ; SOURCE LINE # 277
                                           ; SOURCE LINE # 281
0000 900000      R     MOV     DPTR,#i_packetizer+03H
0003 E0                MOVX    A,@DPTR
0004 FD                MOV     R5,A
0005 7021              JNZ     ?C0028
                                           ; SOURCE LINE # 282
                                           ; SOURCE LINE # 283
0007 900000      R     MOV     DPTR,#stall_data_size0
000A E0                MOVX    A,@DPTR
000B B40108            CJNE    A,#01H,?C0029
                                           ; SOURCE LINE # 284
                                           ; SOURCE LINE # 285
000E 90C7B4            MOV     DPTR,#ep0cs
0011 E0                MOVX    A,@DPTR
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 49  

0012 4410              ORL     A,#010H
0014 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 286
0015 22                RET     
0016         ?C0029:
                                           ; SOURCE LINE # 288
                                           ; SOURCE LINE # 289
0016 900000      R     MOV     DPTR,#stall_data_size0
0019 7401              MOV     A,#01H
001B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 290
001C E4                CLR     A
001D 90C7B5            MOV     DPTR,#in0bc
0020 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 291
0021 90C7B4            MOV     DPTR,#ep0cs
0024 7402              MOV     A,#02H
0026 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 292
0027 22                RET     
                                           ; SOURCE LINE # 294
0028         ?C0028:
                                           ; SOURCE LINE # 296
0028 900000      R     MOV     DPTR,#i_packetizer+04H
002B E0                MOVX    A,@DPTR
002C FF                MOV     R7,A
002D ED                MOV     A,R5
002E C3                CLR     C
002F 9F                SUBB    A,R7
0030 5007              JNC     ?C0038
0032 900000      R     MOV     DPTR,#i_packetizer+03H
0035 E0                MOVX    A,@DPTR
0036 FF                MOV     R7,A
0037 8000              SJMP    ?C0039
0039         ?C0038:
0039         ?C0039:
;---- Variable 'size' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 299
;---- Variable 'i' assigned to Register 'R6' ----
0039 E4                CLR     A
003A FE                MOV     R6,A
003B         ?C0040:
003B EE                MOV     A,R6
003C C3                CLR     C
003D 9F                SUBB    A,R7
003E 5023              JNC     ?C0041
                                           ; SOURCE LINE # 300
                                           ; SOURCE LINE # 301
0040 900000      R     MOV     DPTR,#i_packetizer
0043 E0                MOVX    A,@DPTR
0044 FB                MOV     R3,A
0045 A3                INC     DPTR
0046 E0                MOVX    A,@DPTR
0047 FA                MOV     R2,A
0048 A3                INC     DPTR
0049 E0                MOVX    A,@DPTR
004A F9                MOV     R1,A
004B 8E82              MOV     DPL,R6
004D 758300            MOV     DPH,#00H
0050 120000      E     LCALL   ?C?CLDOPTR
0053 FD                MOV     R5,A
0054 7400              MOV     A,#LOW in0buf
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 50  

0056 2E                ADD     A,R6
0057 F582              MOV     DPL,A
0059 E4                CLR     A
005A 34C7              ADDC    A,#HIGH in0buf
005C F583              MOV     DPH,A
005E ED                MOV     A,R5
005F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 302
0060 0E                INC     R6
0061 80D8              SJMP    ?C0040
0063         ?C0041:
                                           ; SOURCE LINE # 304
0063 900000      R     MOV     DPTR,#i_packetizer+04H
0066 E0                MOVX    A,@DPTR
0067 FE                MOV     R6,A
0068 EF                MOV     A,R7
0069 C3                CLR     C
006A 9E                SUBB    A,R6
006B 5006              JNC     ?C0043
                                           ; SOURCE LINE # 305
006D 900000      R     MOV     DPTR,#stall_data_size0
0070 7401              MOV     A,#01H
0072 F0                MOVX    @DPTR,A
0073         ?C0043:
                                           ; SOURCE LINE # 308
0073 90C7B5            MOV     DPTR,#in0bc
0076 EF                MOV     A,R7
0077 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 311
0078 FD                MOV     R5,A
0079 900000      R     MOV     DPTR,#i_packetizer+01H
007C E4                CLR     A
007D 8DF0              MOV     B,R5
007F 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 312
0082 900000      R     MOV     DPTR,#i_packetizer+03H
0085 E0                MOVX    A,@DPTR
0086 C3                CLR     C
0087 9F                SUBB    A,R7
0088 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 315
0089         ?C0037:
0089 22                RET     
             ; FUNCTION packetizer_isr_ep0_in (END)

             ; FUNCTION usb_process_dev_req_cb_response (BEGIN)
                                           ; SOURCE LINE # 318
                                           ; SOURCE LINE # 319
                                           ; SOURCE LINE # 322
0000 7B01              MOV     R3,#01H
0002 7A00        R     MOV     R2,#HIGH data_size
0004 7900        R     MOV     R1,#LOW data_size
0006 90FFFD            MOV     DPTR,#0FFFDH
0009 120000      E     LCALL   ?C?ADDXBP
000C EB                MOV     A,R3
000D F0                MOVX    @DPTR,A
000E A3                INC     DPTR
000F EA                MOV     A,R2
0010 F0                MOVX    @DPTR,A
0011 A3                INC     DPTR
0012 E9                MOV     A,R1
0013 F0                MOVX    @DPTR,A
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 51  

0014 7B01              MOV     R3,#01H
0016 7A00        R     MOV     R2,#HIGH data_ptr
0018 7900        R     MOV     R1,#LOW data_ptr
001A 90FFFD            MOV     DPTR,#0FFFDH
001D 120000      E     LCALL   ?C?ADDXBP
0020 EB                MOV     A,R3
0021 F0                MOVX    @DPTR,A
0022 A3                INC     DPTR
0023 EA                MOV     A,R2
0024 F0                MOVX    @DPTR,A
0025 A3                INC     DPTR
0026 E9                MOV     A,R1
0027 F0                MOVX    @DPTR,A
0028 7B01              MOV     R3,#01H
002A 7A00        R     MOV     R2,#HIGH req
002C 7900        R     MOV     R1,#LOW req
002E C002              PUSH    AR2
0030 900000      R     MOV     DPTR,#g_hal_usb+011H
0033 A3                INC     DPTR
0034 E0                MOVX    A,@DPTR
0035 FA                MOV     R2,A
0036 A3                INC     DPTR
0037 E0                MOVX    A,@DPTR
0038 F582              MOV     DPL,A
003A 8A83              MOV     DPH,R2
003C D002              POP     AR2
003E 120000      E     LCALL   ?C?ICALL2
;---- Variable 'ret' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 324
0041 EF                MOV     A,R7
0042 14                DEC     A
0043 6030              JZ      ?C0053
0045 14                DEC     A
0046 6034              JZ      ?C0054
0048 14                DEC     A
0049 603E              JZ      ?C0060
004B 24FE              ADD     A,#0FEH
004D 6026              JZ      ?C0053
004F 04                INC     A
0050 7031              JNZ     ?C0059
                                           ; SOURCE LINE # 325
                                           ; SOURCE LINE # 326
0052         ?C0045:
                                           ; SOURCE LINE # 327
0052 900000      R     MOV     DPTR,#data_ptr
0055 E0                MOVX    A,@DPTR
0056 FB                MOV     R3,A
0057 A3                INC     DPTR
0058 E0                MOVX    A,@DPTR
0059 FA                MOV     R2,A
005A A3                INC     DPTR
005B E0                MOVX    A,@DPTR
005C F9                MOV     R1,A
005D A3                INC     DPTR
005E E0                MOVX    A,@DPTR
005F FF                MOV     R7,A
0060 900000      R     MOV     DPTR,#req+05H
0063 E0                MOVX    A,@DPTR
0064 FE                MOV     R6,A
0065 C3                CLR     C
0066 9F                SUBB    A,R7
0067 5004              JNC     ?C0046
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 52  

0069 AD06              MOV     R5,AR6
006B 8002              SJMP    ?C0047
006D         ?C0046:
006D AD07              MOV     R5,AR7
006F         ?C0047:
006F 120000      R     LCALL   _packetize
                                           ; SOURCE LINE # 328
0072 020000      R     LJMP    packetizer_isr_ep0_in
                                           ; SOURCE LINE # 329
                                           ; SOURCE LINE # 330
                                           ; SOURCE LINE # 331
                                           ; SOURCE LINE # 332
                                           ; SOURCE LINE # 333
0075         ?C0053:
                                           ; SOURCE LINE # 334
0075 90C7B4            MOV     DPTR,#ep0cs
0078 7402              MOV     A,#02H
007A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 335
007B 22                RET     
                                           ; SOURCE LINE # 336
007C         ?C0054:
                                           ; SOURCE LINE # 337
007C 90C7C5            MOV     DPTR,#out0bc
007F 74FF              MOV     A,#0FFH
0081 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 338
0082 22                RET     
                                           ; SOURCE LINE # 339
                                           ; SOURCE LINE # 340
0083         ?C0059:
                                           ; SOURCE LINE # 341
0083 90C7B4            MOV     DPTR,#ep0cs
0086 7411              MOV     A,#011H
0088 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 342
                                           ; SOURCE LINE # 343
                                           ; SOURCE LINE # 344
0089         ?C0060:
0089 22                RET     
             ; FUNCTION usb_process_dev_req_cb_response (END)

             ; FUNCTION usb_process_get_status (BEGIN)
                                           ; SOURCE LINE # 346
                                           ; SOURCE LINE # 347
                                           ; SOURCE LINE # 350
0000 900000      R     MOV     DPTR,#g_hal_usb+010H
0003 E0                MOVX    A,@DPTR
0004 FF                MOV     R7,A
0005 6403              XRL     A,#03H
0007 7028              JNZ     ?C0061
                                           ; SOURCE LINE # 351
                                           ; SOURCE LINE # 352
0009 900000      R     MOV     DPTR,#req+04H
000C E0                MOVX    A,@DPTR
000D 6003              JZ      ?C0062
                                           ; SOURCE LINE # 353
                                           ; SOURCE LINE # 354
                                           ; SOURCE LINE # 355
000F 020000      R     LJMP    ?C0260
0012         ?C0062:
                                           ; SOURCE LINE # 357
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 53  

                                           ; SOURCE LINE # 358
0012 900000      R     MOV     DPTR,#g_hal_usb+03H
0015 E0                MOVX    A,@DPTR
0016 FB                MOV     R3,A
0017 A3                INC     DPTR
0018 E0                MOVX    A,@DPTR
0019 FA                MOV     R2,A
001A A3                INC     DPTR
001B E0                MOVX    A,@DPTR
001C F9                MOV     R1,A
001D 900007            MOV     DPTR,#07H
0020 120000      E     LCALL   ?C?CLDOPTR
0023 5440              ANL     A,#040H
0025 C4                SWAP    A
0026 13                RRC     A
0027 13                RRC     A
0028 5403              ANL     A,#03H
002A 90C701            MOV     DPTR,#in0buf+01H
002D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 360
                                           ; SOURCE LINE # 361
                                           ; SOURCE LINE # 362
002E 020000      R     LJMP    ?C0259
0031         ?C0061:
                                           ; SOURCE LINE # 363
0031 EF                MOV     A,R7
0032 6404              XRL     A,#04H
0034 6003              JZ      $ + 5H
0036 020000      R     LJMP    ?C0084
                                           ; SOURCE LINE # 364
                                           ; SOURCE LINE # 365
0039 90C701            MOV     DPTR,#in0buf+01H
003C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 366
003D 900000      R     MOV     DPTR,#req
0040 E0                MOVX    A,@DPTR
0041 247F              ADD     A,#07FH
0043 6040              JZ      ?C0073
0045 14                DEC     A
0046 6040              JZ      ?C0074
0048 2402              ADD     A,#02H
004A 6003              JZ      $ + 5H
004C 020000      R     LJMP    ?C0080
                                           ; SOURCE LINE # 367
                                           ; SOURCE LINE # 368
004F         ?C0070:
                                           ; SOURCE LINE # 369
004F 900000      R     MOV     DPTR,#g_hal_usb+0DH
0052 E0                MOVX    A,@DPTR
0053 30E108            JNB     ACC.1,?C0071
                                           ; SOURCE LINE # 370
                                           ; SOURCE LINE # 371
0056 90C700            MOV     DPTR,#in0buf
0059 7402              MOV     A,#02H
005B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 372
005C 8005              SJMP    ?C0072
005E         ?C0071:
                                           ; SOURCE LINE # 374
                                           ; SOURCE LINE # 375
005E E4                CLR     A
005F 90C700            MOV     DPTR,#in0buf
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 54  

0062 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 376
0063         ?C0072:
                                           ; SOURCE LINE # 378
0063 90C700            MOV     DPTR,#in0buf
0066 E0                MOVX    A,@DPTR
0067 FF                MOV     R7,A
0068 900000      R     MOV     DPTR,#g_hal_usb+03H
006B E0                MOVX    A,@DPTR
006C FB                MOV     R3,A
006D A3                INC     DPTR
006E E0                MOVX    A,@DPTR
006F FA                MOV     R2,A
0070 A3                INC     DPTR
0071 E0                MOVX    A,@DPTR
0072 F9                MOV     R1,A
0073 900007            MOV     DPTR,#07H
0076 120000      E     LCALL   ?C?CLDOPTR
0079 5440              ANL     A,#040H
007B C4                SWAP    A
007C 13                RRC     A
007D 13                RRC     A
007E 5403              ANL     A,#03H
0080 FE                MOV     R6,A
0081 EF                MOV     A,R7
0082 4E                ORL     A,R6
0083         ?C0257:
                                           ; SOURCE LINE # 379
                                           ; SOURCE LINE # 380
0083 803F              SJMP    ?C0259
                                           ; SOURCE LINE # 381
0085         ?C0073:
                                           ; SOURCE LINE # 382
0085 E4                CLR     A
0086         ?C0258:
                                           ; SOURCE LINE # 383
                                           ; SOURCE LINE # 384
0086 803C              SJMP    ?C0259
                                           ; SOURCE LINE # 385
0088         ?C0074:
                                           ; SOURCE LINE # 386
0088 900000      R     MOV     DPTR,#req+04H
008B E0                MOVX    A,@DPTR
008C 30E70D            JNB     ACC.7,?C0075
                                           ; SOURCE LINE # 387
                                           ; SOURCE LINE # 388
008F 547F              ANL     A,#07FH
0091 75F002            MOV     B,#02H
0094 A4                MUL     AB
0095 24B4              ADD     A,#LOW in1cs+0FFFEH
0097 F9                MOV     R1,A
0098 74C7              MOV     A,#HIGH in1cs+0FFFEH
                                           ; SOURCE LINE # 389
009A 800F              SJMP    ?C0255
009C         ?C0075:
                                           ; SOURCE LINE # 391
                                           ; SOURCE LINE # 392
009C 900000      R     MOV     DPTR,#req+04H
009F E0                MOVX    A,@DPTR
00A0 547F              ANL     A,#07FH
00A2 75F002            MOV     B,#02H
00A5 A4                MUL     AB
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 55  

00A6 24C4              ADD     A,#LOW out1cs+0FFFEH
00A8 F9                MOV     R1,A
00A9 74C7              MOV     A,#HIGH out1cs+0FFFEH
00AB         ?C0255:
00AB 35F0              ADDC    A,B
00AD AF01              MOV     R7,AR1
00AF 900000      R     MOV     DPTR,#ptr
00B2 F0                MOVX    @DPTR,A
00B3 A3                INC     DPTR
00B4 EF                MOV     A,R7
00B5 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 393
00B6         ?C0076:
                                           ; SOURCE LINE # 395
00B6 900000      R     MOV     DPTR,#ptr
00B9 E0                MOVX    A,@DPTR
00BA FE                MOV     R6,A
00BB A3                INC     DPTR
00BC E0                MOVX    A,@DPTR
00BD F582              MOV     DPL,A
00BF 8E83              MOV     DPH,R6
00C1 E0                MOVX    A,@DPTR
00C2 5401              ANL     A,#01H
00C4         ?C0259:
00C4 90C700            MOV     DPTR,#in0buf
00C7 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 396
00C8 90C7B5            MOV     DPTR,#in0bc
00CB 7402              MOV     A,#02H
00CD F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 397
00CE 22                RET     
                                           ; SOURCE LINE # 398
00CF         ?C0080:
                                           ; SOURCE LINE # 399
00CF         ?C0256:
                                           ; SOURCE LINE # 400
00CF 8000              SJMP    ?C0260
                                           ; SOURCE LINE # 401
                                           ; SOURCE LINE # 402
                                           ; SOURCE LINE # 404
00D1         ?C0084:
                                           ; SOURCE LINE # 406
00D1         ?C0260:
00D1 90C7B4            MOV     DPTR,#ep0cs
00D4 7411              MOV     A,#011H
00D6 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 407
                                           ; SOURCE LINE # 408
00D7         ?C0085:
00D7 22                RET     
             ; FUNCTION usb_process_get_status (END)

             ; FUNCTION usb_process_get_descriptor (BEGIN)
                                           ; SOURCE LINE # 410
                                           ; SOURCE LINE # 411
                                           ; SOURCE LINE # 413
0000 900000      R     MOV     DPTR,#req+02H
0003 E0                MOVX    A,@DPTR
0004 24FE              ADD     A,#0FEH
0006 6030              JZ      ?C0090
0008 14                DEC     A
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 56  

0009 604B              JZ      ?C0093
000B 24FA              ADD     A,#0FAH
000D 4003              JC      $ + 5H
000F 020000      R     LJMP    ?C0112
0012 2408              ADD     A,#08H
0014 6003              JZ      $ + 5H
0016 020000      R     LJMP    ?C0113
                                           ; SOURCE LINE # 414
                                           ; SOURCE LINE # 415
0019         ?C0087:
                                           ; SOURCE LINE # 416
0019 900000      R     MOV     DPTR,#g_hal_usb
001C E0                MOVX    A,@DPTR
001D FB                MOV     R3,A
001E A3                INC     DPTR
001F E0                MOVX    A,@DPTR
0020 FA                MOV     R2,A
0021 A3                INC     DPTR
0022 E0                MOVX    A,@DPTR
0023 F9                MOV     R1,A
0024 900000      R     MOV     DPTR,#req+05H
0027 E0                MOVX    A,@DPTR
0028 FF                MOV     R7,A
0029 C3                CLR     C
002A 9412              SUBB    A,#012H
002C 5005              JNC     ?C0088
002E AD07              MOV     R5,AR7
0030 020000      R     LJMP    ?C0263
0033         ?C0088:
0033 7D12              MOV     R5,#012H
0035         ?C0089:
                                           ; SOURCE LINE # 418
                                           ; SOURCE LINE # 419
0035 020000      R     LJMP    ?C0263
                                           ; SOURCE LINE # 420
0038         ?C0090:
                                           ; SOURCE LINE # 422
0038 900000      R     MOV     DPTR,#g_hal_usb+03H
003B E0                MOVX    A,@DPTR
003C FB                MOV     R3,A
003D A3                INC     DPTR
003E E0                MOVX    A,@DPTR
003F FA                MOV     R2,A
0040 A3                INC     DPTR
0041 E0                MOVX    A,@DPTR
0042 F9                MOV     R1,A
0043 900000      R     MOV     DPTR,#req+05H
0046 E0                MOVX    A,@DPTR
0047 FF                MOV     R7,A
0048 C3                CLR     C
0049 9420              SUBB    A,#020H
004B 5004              JNC     ?C0091
004D AD07              MOV     R5,AR7
004F 8002              SJMP    ?C0092
0051         ?C0091:
0051 7D20              MOV     R5,#020H
0053         ?C0092:
0053         ?C0261:
                                           ; SOURCE LINE # 424
                                           ; SOURCE LINE # 425
0053 020000      R     LJMP    ?C0263
                                           ; SOURCE LINE # 426
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 57  

0056         ?C0093:
                                           ; SOURCE LINE # 428
0056 900000      R     MOV     DPTR,#req+03H
0059 E0                MOVX    A,@DPTR
005A FC                MOV     R4,A
005B 7018              JNZ     ?C0094
                                           ; SOURCE LINE # 429
                                           ; SOURCE LINE # 430
005D 7B01              MOV     R3,#01H
005F 7A00        R     MOV     R2,#HIGH g_hal_usb+09H
0061 7900        R     MOV     R1,#LOW g_hal_usb+09H
0063 900000      R     MOV     DPTR,#req+05H
0066 E0                MOVX    A,@DPTR
0067 FF                MOV     R7,A
0068 C3                CLR     C
0069 9404              SUBB    A,#04H
006B 5004              JNC     ?C0095
006D AD07              MOV     R5,AR7
006F 8002              SJMP    ?C0096
0071         ?C0095:
0071 7D04              MOV     R5,#04H
0073         ?C0096:
0073         ?C0262:
                                           ; SOURCE LINE # 431
                                           ; SOURCE LINE # 432
0073 8063              SJMP    ?C0263
0075         ?C0094:
                                           ; SOURCE LINE # 434
                                           ; SOURCE LINE # 435
0075 EC                MOV     A,R4
0076 14                DEC     A
0077 C3                CLR     C
0078 9402              SUBB    A,#02H
007A 5062              JNC     ?C0264
                                           ; SOURCE LINE # 436
                                           ; SOURCE LINE # 437
007C 900000      R     MOV     DPTR,#g_hal_usb+06H
007F E0                MOVX    A,@DPTR
0080 FB                MOV     R3,A
0081 A3                INC     DPTR
0082 E0                MOVX    A,@DPTR
0083 FA                MOV     R2,A
0084 A3                INC     DPTR
0085 E0                MOVX    A,@DPTR
0086 F9                MOV     R1,A
0087 900000      R     MOV     DPTR,#req+03H
008A E0                MOVX    A,@DPTR
008B FF                MOV     R7,A
008C 75F003            MOV     B,#03H
008F A4                MUL     AB
0090 24FD              ADD     A,#0FDH
0092 F582              MOV     DPL,A
0094 E5F0              MOV     A,B
0096 34FF              ADDC    A,#0FFH
0098 F583              MOV     DPH,A
009A 120000      E     LCALL   ?C?PLDOPTR
009D C003              PUSH    AR3
009F C002              PUSH    AR2
00A1 C001              PUSH    AR1
00A3 900000      R     MOV     DPTR,#g_hal_usb+06H
00A6 E0                MOVX    A,@DPTR
00A7 FB                MOV     R3,A
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 58  

00A8 A3                INC     DPTR
00A9 E0                MOVX    A,@DPTR
00AA FA                MOV     R2,A
00AB A3                INC     DPTR
00AC E0                MOVX    A,@DPTR
00AD F9                MOV     R1,A
00AE EF                MOV     A,R7
00AF 14                DEC     A
00B0 75F003            MOV     B,#03H
00B3 A4                MUL     AB
00B4 F582              MOV     DPL,A
00B6 85F083            MOV     DPH,B
00B9 120000      E     LCALL   ?C?PLDOPTR
00BC 120000      E     LCALL   ?C?CLDPTR
00BF FF                MOV     R7,A
00C0 900000      R     MOV     DPTR,#req+05H
00C3 E0                MOVX    A,@DPTR
00C4 FE                MOV     R6,A
00C5 C3                CLR     C
00C6 9F                SUBB    A,R7
00C7 5004              JNC     ?C0099
00C9 AD06              MOV     R5,AR6
00CB 8005              SJMP    ?C0100
00CD         ?C0099:
00CD 120000      E     LCALL   ?C?CLDPTR
00D0 FF                MOV     R7,A
00D1 FD                MOV     R5,A
00D2         ?C0100:
00D2 D001              POP     AR1
00D4 D002              POP     AR2
00D6 D003              POP     AR3
00D8         ?C0263:
00D8 120000      R     LCALL   _packetize
                                           ; SOURCE LINE # 439
00DB 020000      R     LJMP    packetizer_isr_ep0_in
                                           ; SOURCE LINE # 440
                                           ; SOURCE LINE # 442
                                           ; SOURCE LINE # 447
                                           ; SOURCE LINE # 448
                                           ; SOURCE LINE # 449
                                           ; SOURCE LINE # 450
                                           ; SOURCE LINE # 451
00DE         ?C0112:
                                           ; SOURCE LINE # 452
00DE         ?C0264:
00DE 90C7B4            MOV     DPTR,#ep0cs
00E1 7411              MOV     A,#011H
00E3 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 453
00E4 22                RET     
                                           ; SOURCE LINE # 454
00E5         ?C0113:
                                           ; SOURCE LINE # 455
00E5 120000      R     LCALL   usb_process_dev_req_cb_response
                                           ; SOURCE LINE # 456
                                           ; SOURCE LINE # 457
                                           ; SOURCE LINE # 458
00E8         ?C0114:
00E8 22                RET     
             ; FUNCTION usb_process_get_descriptor (END)

             ; FUNCTION isr_sudav (BEGIN)
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 59  

                                           ; SOURCE LINE # 460
                                           ; SOURCE LINE # 461
                                           ; SOURCE LINE # 463
0000 90C7E8            MOV     DPTR,#setupbuf
0003 E0                MOVX    A,@DPTR
0004 900000      R     MOV     DPTR,#req
0007 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 464
0008 90C7E9            MOV     DPTR,#setupbuf+01H
000B E0                MOVX    A,@DPTR
000C 900000      R     MOV     DPTR,#req+01H
000F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 465
0010 90C7EA            MOV     DPTR,#setupbuf+02H
0013 E0                MOVX    A,@DPTR
0014 900000      R     MOV     DPTR,#req+03H
0017 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 466
0018 90C7EB            MOV     DPTR,#setupbuf+03H
001B E0                MOVX    A,@DPTR
001C 900000      R     MOV     DPTR,#req+02H
001F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 467
0020 90C7EC            MOV     DPTR,#setupbuf+04H
0023 E0                MOVX    A,@DPTR
0024 900000      R     MOV     DPTR,#req+04H
0027 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 468
0028 90C7EE            MOV     DPTR,#setupbuf+06H
002B E0                MOVX    A,@DPTR
002C 900000      R     MOV     DPTR,#req+05H
002F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 469
0030 90C7EF            MOV     DPTR,#setupbuf+07H
0033 E0                MOVX    A,@DPTR
0034 D3                SETB    C
0035 9400              SUBB    A,#00H
0037 4006              JC      ?C0115
                                           ; SOURCE LINE # 470
                                           ; SOURCE LINE # 471
0039 900000      R     MOV     DPTR,#req+05H
003C 74FF              MOV     A,#0FFH
003E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 472
003F         ?C0115:
                                           ; SOURCE LINE # 475
003F 900000      R     MOV     DPTR,#req
0042 E0                MOVX    A,@DPTR
0043 5460              ANL     A,#060H
0045 6003              JZ      $ + 5H
0047 020000      R     LJMP    ?C0116
                                           ; SOURCE LINE # 476
                                           ; SOURCE LINE # 477
004A A3                INC     DPTR
004B E0                MOVX    A,@DPTR
004C B40B00            CJNE    A,#0BH,?C0245
004F         ?C0245:
004F 4003              JC      $ + 5H
0051 020000      R     LJMP    ?C0180
0054 900000      R     MOV     DPTR,#?C0246
0057 F8                MOV     R0,A
0058 28                ADD     A,R0
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 60  

0059 28                ADD     A,R0
005A 73                JMP     @A+DPTR
005B         ?C0246:
005B 020000      R     LJMP    ?C0119
005E 020000      R     LJMP    ?C0121
0061 020000      R     LJMP    ?C0180
0064 020000      R     LJMP    ?C0121
0067 020000      R     LJMP    ?C0180
006A 020000      R     LJMP    ?C0150
006D 020000      R     LJMP    ?C0118
0070 020000      R     LJMP    ?C0180
0073 020000      R     LJMP    ?C0151
0076 020000      R     LJMP    ?C0159
0079 020000      R     LJMP    ?C0173
                                           ; SOURCE LINE # 478
                                           ; SOURCE LINE # 479
007C         ?C0118:
                                           ; SOURCE LINE # 480
007C 020000      R     LJMP    usb_process_get_descriptor
                                           ; SOURCE LINE # 481
                                           ; SOURCE LINE # 482
007F         ?C0119:
                                           ; SOURCE LINE # 483
007F 020000      R     LJMP    usb_process_get_status
                                           ; SOURCE LINE # 484
                                           ; SOURCE LINE # 485
                                           ; SOURCE LINE # 486
0082         ?C0121:
                                           ; SOURCE LINE # 487
0082 900000      R     MOV     DPTR,#req
0085 E0                MOVX    A,@DPTR
0086 24FE              ADD     A,#0FEH
0088 6024              JZ      ?C0134
008A 2402              ADD     A,#02H
008C 7042              JNZ     ?C0149
                                           ; SOURCE LINE # 488
                                           ; SOURCE LINE # 489
008E         ?C0123:
                                           ; SOURCE LINE # 490
008E 900000      R     MOV     DPTR,#req+03H
0091 E0                MOVX    A,@DPTR
0092 B40116            CJNE    A,#01H,?C0133
                                           ; SOURCE LINE # 491
                                           ; SOURCE LINE # 492
0095 900000      R     MOV     DPTR,#req+01H
0098 E0                MOVX    A,@DPTR
0099 900000      R     MOV     DPTR,#g_hal_usb+0DH
009C B40106            CJNE    A,#01H,?C0125
                                           ; SOURCE LINE # 493
009F E0                MOVX    A,@DPTR
00A0 54FD              ANL     A,#0FDH
00A2 F0                MOVX    @DPTR,A
00A3 806C              SJMP    ?C0268
00A5         ?C0125:
                                           ; SOURCE LINE # 495
00A5 E0                MOVX    A,@DPTR
00A6 4402              ORL     A,#02H
00A8 F0                MOVX    @DPTR,A
00A9         ?C0129:
                                           ; SOURCE LINE # 496
                                           ; SOURCE LINE # 497
00A9 8066              SJMP    ?C0268
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 61  

                                           ; SOURCE LINE # 499
00AB         ?C0133:
                                           ; SOURCE LINE # 500
                                           ; SOURCE LINE # 501
                                           ; SOURCE LINE # 502
00AB 020000      R     LJMP    ?C0274
                                           ; SOURCE LINE # 504
00AE         ?C0134:
                                           ; SOURCE LINE # 505
00AE 900000      R     MOV     DPTR,#req+03H
00B1 E0                MOVX    A,@DPTR
00B2 7019              JNZ     ?C0144
                                           ; SOURCE LINE # 506
                                           ; SOURCE LINE # 507
00B4 900000      R     MOV     DPTR,#req+01H
00B7 E0                MOVX    A,@DPTR
00B8 900000      R     MOV     DPTR,#req+04H
00BB B40106            CJNE    A,#01H,?C0136
                                           ; SOURCE LINE # 508
00BE E0                MOVX    A,@DPTR
00BF FF                MOV     R7,A
00C0 E4                CLR     A
00C1 FD                MOV     R5,A
00C2 8004              SJMP    ?C0267
00C4         ?C0136:
                                           ; SOURCE LINE # 510
00C4 E0                MOVX    A,@DPTR
00C5 FF                MOV     R7,A
00C6 7D01              MOV     R5,#01H
00C8         ?C0267:
00C8 120000      R     LCALL   _hal_usb_endpoint_stall
00CB         ?C0140:
                                           ; SOURCE LINE # 511
00CB         ?C0265:
                                           ; SOURCE LINE # 512
00CB 8044              SJMP    ?C0268
                                           ; SOURCE LINE # 514
00CD         ?C0144:
                                           ; SOURCE LINE # 515
00CD         ?C0266:
                                           ; SOURCE LINE # 516
                                           ; SOURCE LINE # 517
00CD 020000      R     LJMP    ?C0274
                                           ; SOURCE LINE # 518
                                           ; SOURCE LINE # 519
00D0         ?C0149:
                                           ; SOURCE LINE # 520
00D0         ?C0269:
                                           ; SOURCE LINE # 521
00D0 020000      R     LJMP    ?C0274
                                           ; SOURCE LINE # 522
                                           ; SOURCE LINE # 523
                                           ; SOURCE LINE # 525
00D3         ?C0150:
                                           ; SOURCE LINE # 526
00D3 900000      R     MOV     DPTR,#g_hal_usb+010H
00D6 7403              MOV     A,#03H
00D8 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 527
00D9 E4                CLR     A
00DA 900000      R     MOV     DPTR,#g_hal_usb+0EH
00DD F0                MOVX    @DPTR,A
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 62  

                                           ; SOURCE LINE # 528
00DE 22                RET     
                                           ; SOURCE LINE # 529
00DF         ?C0151:
                                           ; SOURCE LINE # 530
00DF 900000      R     MOV     DPTR,#g_hal_usb+010H
00E2 E0                MOVX    A,@DPTR
00E3 24FC              ADD     A,#0FCH
00E5 600E              JZ      ?C0154
00E7 04                INC     A
00E8 7010              JNZ     ?C0158
                                           ; SOURCE LINE # 531
                                           ; SOURCE LINE # 532
00EA         ?C0153:
                                           ; SOURCE LINE # 533
00EA E4                CLR     A
00EB 90C700            MOV     DPTR,#in0buf
00EE F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 534
00EF 90C7B5            MOV     DPTR,#in0bc
00F2 04                INC     A
00F3 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 535
00F4 22                RET     
                                           ; SOURCE LINE # 536
00F5         ?C0154:
                                           ; SOURCE LINE # 537
00F5 900000      R     MOV     DPTR,#g_hal_usb+0EH
                                           ; SOURCE LINE # 538
                                           ; SOURCE LINE # 539
00F8 803A              SJMP    ?C0271
                                           ; SOURCE LINE # 540
00FA         ?C0158:
                                           ; SOURCE LINE # 541
00FA         ?C0270:
                                           ; SOURCE LINE # 542
00FA 8065              SJMP    ?C0274
                                           ; SOURCE LINE # 543
                                           ; SOURCE LINE # 544
                                           ; SOURCE LINE # 545
00FC         ?C0159:
                                           ; SOURCE LINE # 546
00FC 900000      R     MOV     DPTR,#req+03H
00FF E0                MOVX    A,@DPTR
0100 14                DEC     A
0101 6015              JZ      ?C0165
0103 04                INC     A
0104 7029              JNZ     ?C0172
                                           ; SOURCE LINE # 547
                                           ; SOURCE LINE # 548
0106         ?C0161:
                                           ; SOURCE LINE # 549
0106 900000      R     MOV     DPTR,#g_hal_usb+010H
0109 7403              MOV     A,#03H
010B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 550
010C E4                CLR     A
010D 900000      R     MOV     DPTR,#g_hal_usb+0EH
0110 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 551
0111         ?C0268:
0111 90C7B4            MOV     DPTR,#ep0cs
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 63  

0114 7402              MOV     A,#02H
0116 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 552
0117 22                RET     
                                           ; SOURCE LINE # 553
0118         ?C0165:
                                           ; SOURCE LINE # 554
0118 900000      R     MOV     DPTR,#g_hal_usb+010H
011B 7404              MOV     A,#04H
011D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 555
011E 900000      R     MOV     DPTR,#g_hal_usb+0DH
0121 E0                MOVX    A,@DPTR
0122 4401              ORL     A,#01H
0124 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 556
0125 A3                INC     DPTR
0126 7401              MOV     A,#01H
0128 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 557
0129 90C7B4            MOV     DPTR,#ep0cs
012C 04                INC     A
012D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 558
012E 22                RET     
                                           ; SOURCE LINE # 559
012F         ?C0172:
                                           ; SOURCE LINE # 560
012F         ?C0272:
                                           ; SOURCE LINE # 561
012F 8030              SJMP    ?C0274
                                           ; SOURCE LINE # 562
                                           ; SOURCE LINE # 563
                                           ; SOURCE LINE # 564
0131         ?C0173:
                                           ; SOURCE LINE # 565
0131 900000      R     MOV     DPTR,#g_hal_usb+0FH
0134         ?C0271:
0134 E0                MOVX    A,@DPTR
0135 90C700            MOV     DPTR,#in0buf
0138 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 566
0139 90C7B5            MOV     DPTR,#in0bc
013C 7401              MOV     A,#01H
013E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 567
013F 22                RET     
                                           ; SOURCE LINE # 568
                                           ; SOURCE LINE # 569
                                           ; SOURCE LINE # 570
                                           ; SOURCE LINE # 571
0140         ?C0180:
                                           ; SOURCE LINE # 572
0140         ?C0273:
                                           ; SOURCE LINE # 573
0140 801F              SJMP    ?C0274
                                           ; SOURCE LINE # 574
                                           ; SOURCE LINE # 575
0142         ?C0116:
                                           ; SOURCE LINE # 577
0142 900000      R     MOV     DPTR,#req
0145 E0                MOVX    A,@DPTR
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 64  

0146 FF                MOV     R7,A
0147 5460              ANL     A,#060H
0149 FE                MOV     R6,A
014A BE2014            CJNE    R6,#020H,?C0188
                                           ; SOURCE LINE # 578
                                           ; SOURCE LINE # 579
014D 900000      R     MOV     DPTR,#req+05H
0150 E0                MOVX    A,@DPTR
0151 600B              JZ      ?C0183
0153 EF                MOV     A,R7
0154 20E707            JB      ACC.7,?C0183
                                           ; SOURCE LINE # 580
                                           ; SOURCE LINE # 583
0157 90C7C5            MOV     DPTR,#out0bc
015A 74FF              MOV     A,#0FFH
015C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 584
015D 22                RET     
015E         ?C0183:
                                           ; SOURCE LINE # 586
                                           ; SOURCE LINE # 587
015E 020000      R     LJMP    usb_process_dev_req_cb_response
                                           ; SOURCE LINE # 588
                                           ; SOURCE LINE # 590
                                           ; SOURCE LINE # 592
0161         ?C0188:
                                           ; SOURCE LINE # 593
0161         ?C0274:
0161 90C7B4            MOV     DPTR,#ep0cs
0164 7411              MOV     A,#011H
0166 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 594
                                           ; SOURCE LINE # 595
0167         ?C0189:
0167 22                RET     
             ; FUNCTION isr_sudav (END)

             ; FUNCTION isr_suspend (BEGIN)
                                           ; SOURCE LINE # 597
                                           ; SOURCE LINE # 598
                                           ; SOURCE LINE # 599
;---- Variable 'allow_remote_wu' assigned to Register 'R5' ----
0000 E4                CLR     A
0001 FD                MOV     R5,A
                                           ; SOURCE LINE # 601
0002 900000      R     MOV     DPTR,#g_hal_usb+0DH
0005 E0                MOVX    A,@DPTR
0006 54FB              ANL     A,#0FBH
0008 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 603
0009 900000      R     MOV     DPTR,#g_hal_usb+010H
000C E0                MOVX    A,@DPTR
000D B40408            CJNE    A,#04H,?C0190
                                           ; SOURCE LINE # 604
                                           ; SOURCE LINE # 605
0010 900000      R     MOV     DPTR,#g_hal_usb+0DH
0013 E0                MOVX    A,@DPTR
0014 30E101            JNB     ACC.1,?C0190
                                           ; SOURCE LINE # 606
                                           ; SOURCE LINE # 607
0017 0D                INC     R5
                                           ; SOURCE LINE # 608
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 65  

                                           ; SOURCE LINE # 609
0018         ?C0190:
                                           ; SOURCE LINE # 611
0018 900000      R     MOV     DPTR,#g_hal_usb+010H
001B 7405              MOV     A,#05H
001D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 613
001E 900000      R     MOV     DPTR,#g_hal_usb+01AH
0021 E0                MOVX    A,@DPTR
0022 FB                MOV     R3,A
0023 A3                INC     DPTR
0024 E0                MOVX    A,@DPTR
0025 FA                MOV     R2,A
0026 A3                INC     DPTR
0027 E0                MOVX    A,@DPTR
0028 4A                ORL     A,R2
0029 4B                ORL     A,R3
002A 600F              JZ      ?C0193
                                           ; SOURCE LINE # 614
                                           ; SOURCE LINE # 615
002C AF05              MOV     R7,AR5
002E 900000      R     MOV     DPTR,#g_hal_usb+01AH
0031 A3                INC     DPTR
0032 A3                INC     DPTR
0033 E0                MOVX    A,@DPTR
0034 F582              MOV     DPL,A
0036 8A83              MOV     DPH,R2
0038 120000      E     LCALL   ?C?ICALL2
                                           ; SOURCE LINE # 616
                                           ; SOURCE LINE # 617
003B         ?C0193:
003B 22                RET     
             ; FUNCTION isr_suspend (END)

             ; FUNCTION isr_usbreset (BEGIN)
                                           ; SOURCE LINE # 619
                                           ; SOURCE LINE # 620
                                           ; SOURCE LINE # 621
0000 900000      R     MOV     DPTR,#g_hal_usb+010H
0003 7402              MOV     A,#02H
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 622
0006 E4                CLR     A
0007 900000      R     MOV     DPTR,#g_hal_usb+0EH
000A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 623
000B A3                INC     DPTR
000C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 624
000D 900000      R     MOV     DPTR,#g_hal_usb+0DH
0010 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 625
0011 900000      R     MOV     DPTR,#g_hal_usb+014H
0014 E0                MOVX    A,@DPTR
0015 FB                MOV     R3,A
0016 A3                INC     DPTR
0017 E0                MOVX    A,@DPTR
0018 FA                MOV     R2,A
0019 A3                INC     DPTR
001A E0                MOVX    A,@DPTR
001B 4A                ORL     A,R2
001C 4B                ORL     A,R3
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 66  

001D 600A              JZ      ?C0195
001F 900000      R     MOV     DPTR,#g_hal_usb+014H
0022 A3                INC     DPTR
0023 A3                INC     DPTR
0024 E0                MOVX    A,@DPTR
0025 F9                MOV     R1,A
0026 120000      E     LCALL   ?C?ICALL
                                           ; SOURCE LINE # 626
0029         ?C0195:
0029 22                RET     
             ; FUNCTION isr_usbreset (END)

             ; FUNCTION usb_wu (BEGIN)
0000 C0E0              PUSH    ACC
0002 C0F0              PUSH    B
0004 C083              PUSH    DPH
0006 C082              PUSH    DPL
0008 C0D0              PUSH    PSW
000A 75D000            MOV     PSW,#00H
000D C000              PUSH    AR0
000F C001              PUSH    AR1
0011 C002              PUSH    AR2
0013 C003              PUSH    AR3
0015 C004              PUSH    AR4
0017 C005              PUSH    AR5
0019 C006              PUSH    AR6
001B C007              PUSH    AR7
                                           ; SOURCE LINE # 630
                                           ; SOURCE LINE # 640
001D 90C7D6            MOV     DPTR,#usbcs
0020 E0                MOVX    A,@DPTR
0021 30E727            JNB     ACC.7,?C0196
                                           ; SOURCE LINE # 641
                                           ; SOURCE LINE # 643
0024 7480              MOV     A,#080H
0026 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 646
0027 900000      R     MOV     DPTR,#g_hal_usb+0DH
002A E0                MOVX    A,@DPTR
002B 30E124            JNB     ACC.1,?C0198
                                           ; SOURCE LINE # 647
                                           ; SOURCE LINE # 650
002E 90C7D6            MOV     DPTR,#usbcs
0031 E0                MOVX    A,@DPTR
0032 4402              ORL     A,#02H
0034 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 653
0035 00                NOP     
                                           ; SOURCE LINE # 654
0036 00                NOP     
                                           ; SOURCE LINE # 656
0037 E0                MOVX    A,@DPTR
;---- Variable 't' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 659
0038 54FD              ANL     A,#0FDH
                                           ; SOURCE LINE # 662
003A 4401              ORL     A,#01H
                                           ; SOURCE LINE # 666
003C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 670
003D 7F07              MOV     R7,#07H
003F 120000      R     LCALL   _delay_ms
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 67  

                                           ; SOURCE LINE # 673
0042 90C7D6            MOV     DPTR,#usbcs
0045 E0                MOVX    A,@DPTR
0046 54FE              ANL     A,#0FEH
0048 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 674
                                           ; SOURCE LINE # 675
0049 8007              SJMP    ?C0198
004B         ?C0196:
                                           ; SOURCE LINE # 677
                                           ; SOURCE LINE # 679
004B 900000      R     MOV     DPTR,#g_hal_usb+0DH
004E E0                MOVX    A,@DPTR
004F 4404              ORL     A,#04H
0051 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 680
0052         ?C0198:
                                           ; SOURCE LINE # 682
0052 900000      R     MOV     DPTR,#g_hal_usb+0DH
0055 E0                MOVX    A,@DPTR
0056 900000      R     MOV     DPTR,#g_hal_usb+010H
0059 30E005            JNB     ACC.0,?C0199
                                           ; SOURCE LINE # 683
                                           ; SOURCE LINE # 684
005C 7404              MOV     A,#04H
005E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 685
005F 8003              SJMP    ?C0200
0061         ?C0199:
                                           ; SOURCE LINE # 687
                                           ; SOURCE LINE # 688
0061 7402              MOV     A,#02H
0063 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 689
0064         ?C0200:
                                           ; SOURCE LINE # 692
0064 900000      R     MOV     DPTR,#g_hal_usb+017H
0067 A3                INC     DPTR
0068 E0                MOVX    A,@DPTR
0069 FA                MOV     R2,A
006A A3                INC     DPTR
006B E0                MOVX    A,@DPTR
006C F9                MOV     R1,A
006D 120000      E     LCALL   ?C?ICALL
                                           ; SOURCE LINE # 693
0070 D007              POP     AR7
0072 D006              POP     AR6
0074 D005              POP     AR5
0076 D004              POP     AR4
0078 D003              POP     AR3
007A D002              POP     AR2
007C D001              POP     AR1
007E D000              POP     AR0
0080 D0D0              POP     PSW
0082 D082              POP     DPL
0084 D083              POP     DPH
0086 D0F0              POP     B
0088 D0E0              POP     ACC
008A 32                RETI    
             ; FUNCTION usb_wu (END)

             ; FUNCTION _usb_process_ep_response (BEGIN)
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 68  

                                           ; SOURCE LINE # 696
;---- Variable 'ret' assigned to Register 'R1' ----
0000 A907              MOV     R1,AR7
;---- Variable 'bc_ptr' assigned to Register 'DPTR' ----
0002 8B82              MOV     DPL,R3
0004 8A83              MOV     DPH,R2
;---- Variable 'cs_ptr' assigned to Register 'R4/R5' ----
                                           ; SOURCE LINE # 697
                                           ; SOURCE LINE # 698
0006 E9                MOV     A,R1
0007 B4FF04            CJNE    A,#0FFH,?C0202
                                           ; SOURCE LINE # 699
                                           ; SOURCE LINE # 700
000A 74FF              MOV     A,#0FFH
000C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 701
000D 22                RET     
000E         ?C0202:
                                           ; SOURCE LINE # 702
000E E9                MOV     A,R1
000F 30E708            JNB     ACC.7,?C0204
                                           ; SOURCE LINE # 703
                                           ; SOURCE LINE # 704
0012 8D82              MOV     DPL,R5
0014 8C83              MOV     DPH,R4
0016 7401              MOV     A,#01H
0018 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 705
0019 22                RET     
001A         ?C0204:
                                           ; SOURCE LINE # 706
001A E9                MOV     A,R1
001B 5460              ANL     A,#060H
001D FF                MOV     R7,A
001E BF6008            CJNE    R7,#060H,?C0206
                                           ; SOURCE LINE # 707
                                           ; SOURCE LINE # 708
0021 8D82              MOV     DPL,R5
0023 8C83              MOV     DPH,R4
0025 7402              MOV     A,#02H
0027 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 709
0028 22                RET     
0029         ?C0206:
                                           ; SOURCE LINE # 710
0029 E9                MOV     A,R1
002A 7002              JNZ     ?C0208
                                           ; SOURCE LINE # 711
                                           ; SOURCE LINE # 712
002C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 713
002D 22                RET     
002E         ?C0208:
                                           ; SOURCE LINE # 715
                                           ; SOURCE LINE # 716
002E E9                MOV     A,R1
002F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 717
                                           ; SOURCE LINE # 718
0030         ?C0210:
0030 22                RET     
             ; FUNCTION _usb_process_ep_response (END)
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 69  


             ; FUNCTION usb_irq (BEGIN)
0000 C0E0              PUSH    ACC
0002 C0F0              PUSH    B
0004 C083              PUSH    DPH
0006 C082              PUSH    DPL
0008 C0D0              PUSH    PSW
000A 75D000            MOV     PSW,#00H
000D C000              PUSH    AR0
000F C001              PUSH    AR1
0011 C002              PUSH    AR2
0013 C003              PUSH    AR3
0015 C004              PUSH    AR4
0017 C005              PUSH    AR5
0019 C006              PUSH    AR6
001B C007              PUSH    AR7
                                           ; SOURCE LINE # 720
                                           ; SOURCE LINE # 728
001D D285              SETB    P0_5
                                           ; SOURCE LINE # 730
001F 90C7A8            MOV     DPTR,#ivec
0022 E0                MOVX    A,@DPTR
0023 120000      E     LCALL   ?C?CCASE
0026 0000        R     DW      ?C0212
0028 00                DB      00H
0029 0000        R     DW      ?C0213
002B 04                DB      04H
002C 0000        R     DW      ?C0214
002E 08                DB      08H
002F 0000        R     DW      ?C0215
0031 0C                DB      0CH
0032 0000        R     DW      ?C0216
0034 10                DB      010H
0035 0000        R     DW      ?C0217
0037 18                DB      018H
0038 0000        R     DW      ?C0218
003A 1C                DB      01CH
003B 0000        R     DW      ?C0223
003D 20                DB      020H
003E 0000        R     DW      ?C0228
0040 24                DB      024H
0041 0000        R     DW      ?C0223
0043 28                DB      028H
0044 0000        R     DW      ?C0228
0046 2C                DB      02CH
0047 0000        R     DW      ?C0223
0049 30                DB      030H
004A 0000        R     DW      ?C0228
004C 34                DB      034H
004D 0000        R     DW      ?C0223
004F 38                DB      038H
0050 0000        R     DW      ?C0228
0052 3C                DB      03CH
0053 0000        R     DW      ?C0223
0055 40                DB      040H
0056 0000        R     DW      ?C0228
0058 44                DB      044H
0059 0000              DW      00H
005B 0000        R     DW      ?C0211
                                           ; SOURCE LINE # 731
                                           ; SOURCE LINE # 732
005D         ?C0212:
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 70  

                                           ; SOURCE LINE # 733
005D 90C7AB            MOV     DPTR,#usbirq
0060 7401              MOV     A,#01H
0062 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 734
0063 120000      R     LCALL   isr_sudav
                                           ; SOURCE LINE # 735
0066 020000      R     LJMP    ?C0211
                                           ; SOURCE LINE # 736
0069         ?C0213:
                                           ; SOURCE LINE # 737
0069 90C7AB            MOV     DPTR,#usbirq
006C 7402              MOV     A,#02H
006E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 738
006F 020000      R     LJMP    ?C0211
                                           ; SOURCE LINE # 739
0072         ?C0214:
                                           ; SOURCE LINE # 740
0072 90C7AB            MOV     DPTR,#usbirq
0075 7404              MOV     A,#04H
0077 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 741
0078 900000      R     MOV     DPTR,#i_packetizer
007B E4                CLR     A
007C F0                MOVX    @DPTR,A
007D A3                INC     DPTR
007E F0                MOVX    @DPTR,A
007F A3                INC     DPTR
0080 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 742
0081 A3                INC     DPTR
0082 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 743
0083 A3                INC     DPTR
0084 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 744
0085 900000      R     MOV     DPTR,#stall_data_size0
0088 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 745
0089 020000      R     LJMP    ?C0211
                                           ; SOURCE LINE # 746
008C         ?C0215:
                                           ; SOURCE LINE # 747
008C 90C7AB            MOV     DPTR,#usbirq
008F 7408              MOV     A,#08H
0091 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 748
0092 120000      R     LCALL   isr_suspend
                                           ; SOURCE LINE # 749
0095 020000      R     LJMP    ?C0211
                                           ; SOURCE LINE # 750
0098         ?C0216:
                                           ; SOURCE LINE # 751
0098 90C7AB            MOV     DPTR,#usbirq
009B 7410              MOV     A,#010H
009D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 752
009E 120000      R     LCALL   isr_usbreset
                                           ; SOURCE LINE # 753
00A1 020000      R     LJMP    ?C0211
                                           ; SOURCE LINE # 754
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 71  

00A4         ?C0217:
                                           ; SOURCE LINE # 755
00A4 90C7A9            MOV     DPTR,#in_irq
00A7 7401              MOV     A,#01H
00A9 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 756
00AA 120000      R     LCALL   packetizer_isr_ep0_in
                                           ; SOURCE LINE # 757
00AD 020000      R     LJMP    ?C0211
                                           ; SOURCE LINE # 758
00B0         ?C0218:
                                           ; SOURCE LINE # 759
00B0 90C7AA            MOV     DPTR,#out_irq
00B3 7401              MOV     A,#01H
00B5 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 760
00B6 900000      R     MOV     DPTR,#i_packetizer+03H
00B9 E4                CLR     A
00BA F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 761
00BB 120000      R     LCALL   usb_process_dev_req_cb_response
                                           ; SOURCE LINE # 762
00BE 020000      R     LJMP    ?C0211
                                           ; SOURCE LINE # 763
                                           ; SOURCE LINE # 764
                                           ; SOURCE LINE # 765
                                           ; SOURCE LINE # 766
                                           ; SOURCE LINE # 767
00C1         ?C0223:
                                           ; SOURCE LINE # 769
00C1 90C7A8            MOV     DPTR,#ivec
00C4 E0                MOVX    A,@DPTR
00C5 24E8              ADD     A,#0E8H
00C7 13                RRC     A
00C8 13                RRC     A
00C9 13                RRC     A
00CA 541F              ANL     A,#01FH
00CC 900000      R     MOV     DPTR,#ep
00CF F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 771
00D0 E0                MOVX    A,@DPTR
00D1 FF                MOV     R7,A
00D2 7401              MOV     A,#01H
00D4 A807              MOV     R0,AR7
00D6 08                INC     R0
00D7 8002              SJMP    ?C0250
00D9         ?C0249:
00D9 C3                CLR     C
00DA 33                RLC     A
00DB         ?C0250:
00DB D8FC              DJNZ    R0,?C0249
00DD 90C7A9            MOV     DPTR,#in_irq
00E0 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 773
00E1 EF                MOV     A,R7
00E2 547F              ANL     A,#07FH
00E4 75F002            MOV     B,#02H
00E7 A4                MUL     AB
00E8 24B4              ADD     A,#LOW in1cs+0FFFEH
00EA F9                MOV     R1,A
00EB 74C7              MOV     A,#HIGH in1cs+0FFFEH
00ED 35F0              ADDC    A,B
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 72  

00EF AF01              MOV     R7,AR1
00F1 900000      R     MOV     DPTR,#cs_ptr
00F4 F0                MOVX    @DPTR,A
00F5 A3                INC     DPTR
00F6 EF                MOV     A,R7
00F7 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 774
00F8 900000      R     MOV     DPTR,#ep
00FB E0                MOVX    A,@DPTR
00FC 547F              ANL     A,#07FH
00FE 75F080            MOV     B,#080H
0101 A4                MUL     AB
0102 FF                MOV     R7,A
0103 C3                CLR     C
0104 7400              MOV     A,#LOW in0buf
0106 9F                SUBB    A,R7
0107 F9                MOV     R1,A
0108 74C7              MOV     A,#HIGH in0buf
010A 95F0              SUBB    A,B
010C AF01              MOV     R7,AR1
010E 900000      R     MOV     DPTR,#buf_ptr
0111 F0                MOVX    @DPTR,A
0112 A3                INC     DPTR
0113 EF                MOV     A,R7
0114 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 775
0115 900000      R     MOV     DPTR,#ep
0118 E0                MOVX    A,@DPTR
0119 547F              ANL     A,#07FH
011B 75F002            MOV     B,#02H
011E A4                MUL     AB
011F 24B5              ADD     A,#LOW in0bc
0121 F9                MOV     R1,A
0122 74C7              MOV     A,#HIGH in0bc
0124 35F0              ADDC    A,B
0126 AF01              MOV     R7,AR1
0128 900000      R     MOV     DPTR,#bc_ptr
012B F0                MOVX    @DPTR,A
012C A3                INC     DPTR
012D EF                MOV     A,R7
012E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 781
012F 900000      R     MOV     DPTR,#cs_ptr
0132 E0                MOVX    A,@DPTR
0133 FC                MOV     R4,A
0134 A3                INC     DPTR
0135 E0                MOVX    A,@DPTR
0136 FD                MOV     R5,A
0137 900000      R     MOV     DPTR,#bc_ptr
013A E0                MOVX    A,@DPTR
013B FA                MOV     R2,A
013C A3                INC     DPTR
013D E0                MOVX    A,@DPTR
013E FB                MOV     R3,A
013F 7F60              MOV     R7,#060H
                                           ; SOURCE LINE # 782
0141 020000      R     LJMP    ?C0275
                                           ; SOURCE LINE # 783
                                           ; SOURCE LINE # 784
                                           ; SOURCE LINE # 785
                                           ; SOURCE LINE # 786
                                           ; SOURCE LINE # 787
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 73  

0144         ?C0228:
                                           ; SOURCE LINE # 789
0144 90C7A8            MOV     DPTR,#ivec
0147 E0                MOVX    A,@DPTR
0148 24E4              ADD     A,#0E4H
014A 13                RRC     A
014B 13                RRC     A
014C 13                RRC     A
014D 541F              ANL     A,#01FH
014F 900000      R     MOV     DPTR,#ep
0152 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 792
0153 E0                MOVX    A,@DPTR
0154 FF                MOV     R7,A
0155 7401              MOV     A,#01H
0157 A807              MOV     R0,AR7
0159 08                INC     R0
015A 8002              SJMP    ?C0252
015C         ?C0251:
015C C3                CLR     C
015D 33                RLC     A
015E         ?C0252:
015E D8FC              DJNZ    R0,?C0251
0160 90C7AA            MOV     DPTR,#out_irq
0163 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 794
0164 EF                MOV     A,R7
0165 547F              ANL     A,#07FH
0167 75F002            MOV     B,#02H
016A A4                MUL     AB
016B 24C4              ADD     A,#LOW out1cs+0FFFEH
016D F9                MOV     R1,A
016E 74C7              MOV     A,#HIGH out1cs+0FFFEH
0170 35F0              ADDC    A,B
0172 AF01              MOV     R7,AR1
0174 900000      R     MOV     DPTR,#cs_ptr
0177 F0                MOVX    @DPTR,A
0178 A3                INC     DPTR
0179 EF                MOV     A,R7
017A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 795
017B 900000      R     MOV     DPTR,#ep
017E E0                MOVX    A,@DPTR
017F 75F080            MOV     B,#080H
0182 A4                MUL     AB
0183 FF                MOV     R7,A
0184 C3                CLR     C
0185 74C0              MOV     A,#LOW out0buf
0187 9F                SUBB    A,R7
0188 F9                MOV     R1,A
0189 74C6              MOV     A,#HIGH out0buf
018B 95F0              SUBB    A,B
018D AF01              MOV     R7,AR1
018F 900000      R     MOV     DPTR,#buf_ptr
0192 F0                MOVX    @DPTR,A
0193 A3                INC     DPTR
0194 EF                MOV     A,R7
0195 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 796
0196 900000      R     MOV     DPTR,#ep
0199 E0                MOVX    A,@DPTR
019A 75F002            MOV     B,#02H
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 74  

019D A4                MUL     AB
019E 7AC7              MOV     R2,#HIGH out0bc
01A0 24C5              ADD     A,#LOW out0bc
01A2 F9                MOV     R1,A
01A3 74C7              MOV     A,#HIGH out0bc
01A5 35F0              ADDC    A,B
01A7 AF01              MOV     R7,AR1
01A9 900000      R     MOV     DPTR,#bc_ptr
01AC F0                MOVX    @DPTR,A
01AD A3                INC     DPTR
01AE EF                MOV     A,R7
01AF F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 800
01B0 900000      R     MOV     DPTR,#bc_ptr
01B3 E0                MOVX    A,@DPTR
01B4 FC                MOV     R4,A
01B5 A3                INC     DPTR
01B6 E0                MOVX    A,@DPTR
01B7 FD                MOV     R5,A
01B8 900000      R     MOV     DPTR,#buf_ptr
01BB E0                MOVX    A,@DPTR
01BC FE                MOV     R6,A
01BD A3                INC     DPTR
01BE E0                MOVX    A,@DPTR
01BF FF                MOV     R7,A
01C0 120000      E     LCALL   _?ep_1_out_cb
;---- Variable 'ret' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 801
01C3 900000      R     MOV     DPTR,#cs_ptr
01C6 E0                MOVX    A,@DPTR
01C7 FC                MOV     R4,A
01C8 A3                INC     DPTR
01C9 E0                MOVX    A,@DPTR
01CA FD                MOV     R5,A
01CB 900000      R     MOV     DPTR,#bc_ptr
01CE E0                MOVX    A,@DPTR
01CF FA                MOV     R2,A
01D0 A3                INC     DPTR
01D1 E0                MOVX    A,@DPTR
01D2 FB                MOV     R3,A
01D3         ?C0275:
01D3 120000      R     LCALL   _usb_process_ep_response
                                           ; SOURCE LINE # 802
                                           ; SOURCE LINE # 803
                                           ; SOURCE LINE # 804
                                           ; SOURCE LINE # 805
01D6         ?C0211:
                                           ; SOURCE LINE # 807
01D6 C285              CLR     P0_5
                                           ; SOURCE LINE # 808
01D8 D007              POP     AR7
01DA D006              POP     AR6
01DC D005              POP     AR5
01DE D004              POP     AR4
01E0 D003              POP     AR3
01E2 D002              POP     AR2
01E4 D001              POP     AR1
01E6 D000              POP     AR0
01E8 D0D0              POP     PSW
01EA D082              POP     DPL
01EC D083              POP     DPH
01EE D0F0              POP     B
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 75  

01F0 D0E0              POP     ACC
01F2 32                RETI    
             ; FUNCTION usb_irq (END)

             ; FUNCTION _delay_ms (BEGIN)
                                           ; SOURCE LINE # 810
;---- Variable 'ms' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 811
                                           ; SOURCE LINE # 814
;---- Variable 'i' assigned to Register 'R6' ----
0000 E4                CLR     A
0001 FE                MOV     R6,A
0002         ?C0231:
0002 EE                MOV     A,R6
0003 C3                CLR     C
0004 9F                SUBB    A,R7
0005 5012              JNC     ?C0240
                                           ; SOURCE LINE # 815
                                           ; SOURCE LINE # 816
;---- Variable 'j' assigned to Register 'R5' ----
0007 E4                CLR     A
0008 FD                MOV     R5,A
0009         ?C0234:
                                           ; SOURCE LINE # 817
                                           ; SOURCE LINE # 818
;---- Variable 'k' assigned to Register 'R4' ----
0009 E4                CLR     A
000A FC                MOV     R4,A
000B         ?C0237:
                                           ; SOURCE LINE # 819
                                           ; SOURCE LINE # 820
000B 00                NOP     
                                           ; SOURCE LINE # 821
000C 0C                INC     R4
000D EC                MOV     A,R4
000E B416FA            CJNE    A,#016H,?C0237
                                           ; SOURCE LINE # 822
0011         ?C0236:
0011 0D                INC     R5
0012 ED                MOV     A,R5
0013 B462F3            CJNE    A,#062H,?C0234
                                           ; SOURCE LINE # 823
0016         ?C0233:
0016 0E                INC     R6
0017 80E9              SJMP    ?C0231
                                           ; SOURCE LINE # 824
0019         ?C0240:
0019 22                RET     
             ; FUNCTION _delay_ms (END)

C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 76  

NAME                                    CLASS   MSPACE  TYPE    OFFSET  SIZE
====                                    =====   ======  ====    ======  ====


uint16_t . . . . . . . . . . . . . . .  TYPEDEF  -----  U_INT    -----  2
usbfrml. . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7D8H  1
P0 . . . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   0080H  1
STALL. . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
i_packetizer . . . . . . . . . . . . .  STATIC   XDATA  STRUCT   0000H  5
_hal_usb_endpoint_config . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
  ep_num . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0004H  1
  ep_size. . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0005H  1
  endpoint_isr . . . . . . . . . . . .  AUTO     XDATA  PTR      0000H  3
  bc_ptr . . . . . . . . . . . . . . .  * REG *  DATA   PTR      0082H  2
  temp . . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0006H  1
  stemp. . . . . . . . . . . . . . . .  AUTO     XDATA  U_CHAR   0003H  1
in_irq . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7A9H  1
usbbav . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7AFH  1
int32_t. . . . . . . . . . . . . . . .  TYPEDEF  -----  LONG     -----  4
out_irq. . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7AAH  1
DEFAULT. . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
packetizer_isr_ep0_in. . . . . . . . .  STATIC   CODE   PROC     0000H  -----
  size . . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0007H  1
  i. . . . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0006H  1
int16_t. . . . . . . . . . . . . . . .  TYPEDEF  -----  INT      -----  2
usbien . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7AEH  1
bin1addr . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C789H  1
hal_usb_get_state. . . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
isosize. . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7E3H  1
bin2addr . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C78AH  1
bin3addr . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C78BH  1
bout1addr. . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C781H  1
bin4addr . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C78CH  1
bout2addr. . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C782H  1
IEN0 . . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   00A8H  1
bin5addr . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C78DH  1
bout3addr. . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C783H  1
packetizer_t . . . . . . . . . . . . .  TYPEDEF  -----  STRUCT   -----  5
  data_ptr . . . . . . . . . . . . . .  MEMBER   -----  PTR      0000H  3
  data_size. . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0003H  1
  pkt_size . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0004H  1
IEN1 . . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   00B8H  1
bout4addr. . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C784H  1
bout5addr. . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C785H  1
togctl . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7D7H  1
g_usb_string_desc. . . . . . . . . . .  EXTERN   CODE   STRUCT   -----  6
ADDRESSED. . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
P0_5 . . . . . . . . . . . . . . . . .  ABSBIT   -----  BIT      0085H  1
isoerr . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7A0H  1
USBWU. . . . . . . . . . . . . . . . .  ABSBIT   -----  BIT      00BBH  1
usb_wu . . . . . . . . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
  t. . . . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0007H  1
i_endpoint_in_isr. . . . . . . . . . .  STATIC   XDATA  ARRAY    0005H  15
POWERED. . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
usbirq . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7ABH  1
i_endpoint_out_isr . . . . . . . . . .  PUBLIC   XDATA  ARRAY    0014H  15
zbcout . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7A2H  1
DATA . . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
usb_descs_templ_t. . . . . . . . . . .  TYPEDEF  -----  STRUCT   -----  13
  dev. . . . . . . . . . . . . . . . .  MEMBER   -----  PTR      0000H  3
  conf . . . . . . . . . . . . . . . .  MEMBER   -----  PTR      0003H  3
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 77  

NAME                                    CLASS   MSPACE  TYPE    OFFSET  SIZE
====                                    =====   ======  ====    ======  ====


  string . . . . . . . . . . . . . . .  MEMBER   -----  PTR      0006H  3
  string_zero. . . . . . . . . . . . .  MEMBER   -----  ARRAY    0009H  4
g_usb_conf_desc. . . . . . . . . . . .  EXTERN   CODE   STRUCT   -----  32
hal_usb_dev_req_resp_t . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
hal_usb_bus_disconnect . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
isr_usbreset . . . . . . . . . . . . .  STATIC   CODE   PROC     0000H  -----
usbcs. . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7D6H  1
usb_string_desc_templ_t. . . . . . . .  TYPEDEF  -----  STRUCT   -----  6
  idx. . . . . . . . . . . . . . . . .  MEMBER   -----  ARRAY    0000H  6
hal_usb_cb_endpoint_t. . . . . . . . .  TYPEDEF  -----  PTR      -----  3
SWRST. . . . . . . . . . . . . . . . .  ABSBIT   -----  BIT      00A7H  1
ivec . . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7A8H  1
g_hal_usb. . . . . . . . . . . . . . .  PUBLIC   XDATA  STRUCT   0023H  29
in8data. . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C768H  1
in8addr. . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7F8H  1
_hal_usb_endpoint_stall. . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
  ep_num . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0007H  1
  stall. . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0005H  1
  temp . . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0006H  1
  cs_ptr . . . . . . . . . . . . . . .  AUTO     XDATA  PTR      0000H  2
out8data . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C760H  1
SUSPENDED. . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
out8addr . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7F0H  1
usb_conf_desc_templ_t. . . . . . . . .  TYPEDEF  -----  STRUCT   -----  32
  conf . . . . . . . . . . . . . . . .  MEMBER   -----  STRUCT   0000H  9
  if0. . . . . . . . . . . . . . . . .  MEMBER   -----  STRUCT   0009H  9
  ep1in. . . . . . . . . . . . . . . .  MEMBER   -----  STRUCT   0012H  7
  ep1out . . . . . . . . . . . . . . .  MEMBER   -----  STRUCT   0019H  7
TCON . . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   0088H  1
g_usb_dev_desc . . . . . . . . . . . .  EXTERN   CODE   STRUCT   -----  18
isr_suspend. . . . . . . . . . . . . .  STATIC   CODE   PROC     0000H  -----
  allow_remote_wu. . . . . . . . . . .  * REG *  DATA   U_CHAR   0005H  1
hal_usb_t. . . . . . . . . . . . . . .  TYPEDEF  -----  STRUCT   -----  29
  descs. . . . . . . . . . . . . . . .  MEMBER   -----  STRUCT   0000H  13
  bm_state . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   000DH  1
  current_config . . . . . . . . . . .  MEMBER   -----  U_CHAR   000EH  1
  current_alt_interface. . . . . . . .  MEMBER   -----  U_CHAR   000FH  1
  state. . . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0010H  1
  device_req . . . . . . . . . . . . .  MEMBER   -----  PTR      0011H  3
  reset. . . . . . . . . . . . . . . .  MEMBER   -----  PTR      0014H  3
  resume . . . . . . . . . . . . . . .  MEMBER   -----  PTR      0017H  3
  suspend. . . . . . . . . . . . . . .  MEMBER   -----  PTR      001AH  3
_usb_process_ep_response . . . . . . .  STATIC   CODE   PROC     0000H  -----
  ret. . . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0001H  1
  cs_ptr . . . . . . . . . . . . . . .  * REG *  DATA   PTR      0004H  2
  bc_ptr . . . . . . . . . . . . . . .  * REG *  DATA   PTR      0082H  2
hal_usb_state_t. . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
binstaddr. . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C788H  1
out8bch. . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C770H  1
ATTACHED . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
hal_usb_conf_desc_t. . . . . . . . . .  TYPEDEF  -----  STRUCT   -----  9
  bLength. . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0000H  1
  bDescriptorType. . . . . . . . . . .  MEMBER   -----  U_CHAR   0001H  1
  wTotalLength . . . . . . . . . . . .  MEMBER   -----  U_INT    0002H  2
  bNumInterfaces . . . . . . . . . . .  MEMBER   -----  U_CHAR   0004H  1
  bConfigurationValue. . . . . . . . .  MEMBER   -----  U_CHAR   0005H  1
  iConfiguration . . . . . . . . . . .  MEMBER   -----  U_CHAR   0006H  1
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 78  

NAME                                    CLASS   MSPACE  TYPE    OFFSET  SIZE
====                                    =====   ======  ====    ======  ====


  bmAttributes . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0007H  1
  bMaxPower. . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0008H  1
out8bcl. . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C771H  1
hal_usb_cb_suspend_t . . . . . . . . .  TYPEDEF  -----  PTR      -----  3
_packetize . . . . . . . . . . . . . .  STATIC   CODE   PROC     0000H  -----
  data_ptr . . . . . . . . . . . . . .  * REG *  DATA   PTR      0001H  3
  data_size. . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0005H  1
in0buf . . . . . . . . . . . . . . . .  PUBLIC   XDATA  ARRAY    C700H  32
_?ep_1_out_cb. . . . . . . . . . . . .  EXTERN   CODE   PROC     -----  -----
in1buf . . . . . . . . . . . . . . . .  PUBLIC   XDATA  ARRAY    C680H  32
req. . . . . . . . . . . . . . . . . .  STATIC   XDATA  STRUCT   0040H  6
out0buf. . . . . . . . . . . . . . . .  PUBLIC   XDATA  ARRAY    C6C0H  32
in2buf . . . . . . . . . . . . . . . .  PUBLIC   XDATA  ARRAY    C600H  32
out1buf. . . . . . . . . . . . . . . .  PUBLIC   XDATA  ARRAY    C640H  32
in3buf . . . . . . . . . . . . . . . .  PUBLIC   XDATA  ARRAY    C580H  32
out2buf. . . . . . . . . . . . . . . .  PUBLIC   XDATA  ARRAY    C5C0H  32
in4buf . . . . . . . . . . . . . . . .  PUBLIC   XDATA  ARRAY    C500H  32
out3buf. . . . . . . . . . . . . . . .  PUBLIC   XDATA  ARRAY    C540H  32
in5buf . . . . . . . . . . . . . . . .  PUBLIC   XDATA  ARRAY    C480H  32
USBCON . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   00A0H  1
out4buf. . . . . . . . . . . . . . . .  PUBLIC   XDATA  ARRAY    C4C0H  32
inbulkval. . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7DEH  1
in0bc. . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7B5H  1
out5buf. . . . . . . . . . . . . . . .  PUBLIC   XDATA  ARRAY    C440H  32
in1bc. . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7B7H  1
ACK. . . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
uint8_t. . . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
outbulkval . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7DFH  1
out0bc . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7C5H  1
in2bc. . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7B9H  1
hal_usb_get_address. . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
out1bc . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7C7H  1
in3bc. . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7BBH  1
out2bc . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7C9H  1
in4bc. . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7BDH  1
_delay_ms. . . . . . . . . . . . . . .  STATIC   CODE   PROC     0000H  -----
  ms . . . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0007H  1
  i. . . . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0006H  1
  j. . . . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0005H  1
  k. . . . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0004H  1
isostaddr. . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7E2H  1
out3bc . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7CBH  1
in5bc. . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7BFH  1
hal_usb_cb_resume_t. . . . . . . . . .  TYPEDEF  -----  PTR      -----  3
out4bc . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7CDH  1
hal_usb_wakeup . . . . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
out5bc . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7CFH  1
isr_sudav. . . . . . . . . . . . . . .  STATIC   CODE   PROC     0000H  -----
int8_t . . . . . . . . . . . . . . . .  TYPEDEF  -----  CHAR     -----  1
NAK. . . . . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
hal_usb_dev_desc_t . . . . . . . . . .  TYPEDEF  -----  STRUCT   -----  18
  bLength. . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0000H  1
  bDescriptorType. . . . . . . . . . .  MEMBER   -----  U_CHAR   0001H  1
  bcdUSB . . . . . . . . . . . . . . .  MEMBER   -----  U_INT    0002H  2
  bDeviceClass . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0004H  1
  bDeviceSubClass. . . . . . . . . . .  MEMBER   -----  U_CHAR   0005H  1
  bDeviceProtocol. . . . . . . . . . .  MEMBER   -----  U_CHAR   0006H  1
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 79  

NAME                                    CLASS   MSPACE  TYPE    OFFSET  SIZE
====                                    =====   ======  ====    ======  ====


  bMaxPacketSize0. . . . . . . . . . .  MEMBER   -----  U_CHAR   0007H  1
  idVendor . . . . . . . . . . . . . .  MEMBER   -----  U_INT    0008H  2
  idProduct. . . . . . . . . . . . . .  MEMBER   -----  U_INT    000AH  2
  bcdDevice. . . . . . . . . . . . . .  MEMBER   -----  U_INT    000CH  2
  iManufacturer. . . . . . . . . . . .  MEMBER   -----  U_CHAR   000EH  1
  iProduct . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   000FH  1
  iSerialNumber. . . . . . . . . . . .  MEMBER   -----  U_CHAR   0010H  1
  bNumConfigurations . . . . . . . . .  MEMBER   -----  U_CHAR   0011H  1
usb_process_get_status . . . . . . . .  STATIC   CODE   PROC     0000H  -----
  ptr. . . . . . . . . . . . . . . . .  AUTO     XDATA  PTR      0000H  2
USBSLP . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   00D9H  1
hal_usb_cb_device_req_t. . . . . . . .  TYPEDEF  -----  PTR      -----  3
ep0cs. . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7B4H  1
hal_usb_bus_connect. . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
hal_usb_sleep. . . . . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
in1cs. . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7B6H  1
in2cs. . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7B8H  1
hal_usb_device_req . . . . . . . . . .  TYPEDEF  -----  STRUCT   -----  6
  bmRequestType. . . . . . . . . . . .  MEMBER   -----  U_CHAR   0000H  1
  bRequest . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0001H  1
  wValueMsb. . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0002H  1
  wValueLsb. . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0003H  1
  wIndex . . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0004H  1
  wLength. . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0005H  1
out1cs . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7C6H  1
in3cs. . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7BAH  1
out2cs . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7C8H  1
in4cs. . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7BCH  1
out3cs . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7CAH  1
in5cs. . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7BEH  1
hal_usb_cb_reset_t . . . . . . . . . .  TYPEDEF  -----  PTR      -----  3
EMPTY_RESPONSE . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
S0CON. . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   0098H  1
out4cs . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7CCH  1
out5cs . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7CEH  1
T2CON. . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   00C8H  1
hal_usb_reset. . . . . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
hal_usb_if_desc_t. . . . . . . . . . .  TYPEDEF  -----  STRUCT   -----  9
  bLength. . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0000H  1
  bDescriptorType. . . . . . . . . . .  MEMBER   -----  U_CHAR   0001H  1
  bInterfaceNumber . . . . . . . . . .  MEMBER   -----  U_CHAR   0002H  1
  bAlternateSetting. . . . . . . . . .  MEMBER   -----  U_CHAR   0003H  1
  bNumEndpoints. . . . . . . . . . . .  MEMBER   -----  U_CHAR   0004H  1
  bInterfaceClass. . . . . . . . . . .  MEMBER   -----  U_CHAR   0005H  1
  bInterfaceSubClass . . . . . . . . .  MEMBER   -----  U_CHAR   0006H  1
  bInterfaceProtocol . . . . . . . . .  MEMBER   -----  U_CHAR   0007H  1
  iInterface . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0008H  1
inisoval . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7E0H  1
CONFIGURED . . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
USB. . . . . . . . . . . . . . . . . .  ABSBIT   -----  BIT      00BCH  1
FSR. . . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   00F8H  1
outisoval. . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7E1H  1
_hal_usb_send_data . . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
  ep_num . . . . . . . . . . . . . . .  AUTO     XDATA  U_CHAR   0000H  1
  array. . . . . . . . . . . . . . . .  AUTO     XDATA  PTR      0001H  3
  count. . . . . . . . . . . . . . . .  AUTO     XDATA  U_CHAR   0004H  1
  i. . . . . . . . . . . . . . . . . .  AUTO     DATA   U_CHAR   0000H  1
C51 COMPILER V9.02   HAL_USB                                                               05/15/2011 19:16:12 PAGE 80  

NAME                                    CLASS   MSPACE  TYPE    OFFSET  SIZE
====                                    =====   ======  ====    ======  ====


  buf_ptr. . . . . . . . . . . . . . .  AUTO     XDATA  PTR      0005H  2
  bc_ptr . . . . . . . . . . . . . . .  AUTO     XDATA  PTR      0007H  2
_Bool. . . . . . . . . . . . . . . . .  TYPEDEF  -----  U_CHAR   -----  1
stall_data_size0 . . . . . . . . . . .  STATIC   XDATA  U_CHAR   0046H  1
hal_usb_ep_desc_t. . . . . . . . . . .  TYPEDEF  -----  STRUCT   -----  7
  bLength. . . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0000H  1
  bDescriptorType. . . . . . . . . . .  MEMBER   -----  U_CHAR   0001H  1
  bEndpointAddress . . . . . . . . . .  MEMBER   -----  U_CHAR   0002H  1
  bmAttributes . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0003H  1
  wMaxPacketSize . . . . . . . . . . .  MEMBER   -----  U_INT    0004H  2
  bInterval. . . . . . . . . . . . . .  MEMBER   -----  U_CHAR   0006H  1
NO_RESPONSE. . . . . . . . . . . . . .  E_CONST  -----  U_CHAR   -----  1
AESCS. . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   00E8H  1
fnaddr . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7DBH  1
setupbuf . . . . . . . . . . . . . . .  PUBLIC   XDATA  ARRAY    C7E8H  8
in_ien . . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7ACH  1
usb_process_dev_req_cb_response. . . .  STATIC   CODE   PROC     0000H  -----
  data_ptr . . . . . . . . . . . . . .  AUTO     XDATA  PTR      0000H  3
  data_size. . . . . . . . . . . . . .  AUTO     XDATA  U_CHAR   0003H  1
  ret. . . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0007H  1
out_ien. . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7ADH  1
usb_irq. . . . . . . . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
  ep . . . . . . . . . . . . . . . . .  AUTO     XDATA  U_CHAR   0000H  1
  ret. . . . . . . . . . . . . . . . .  * REG *  DATA   U_CHAR   0007H  1
  cs_ptr . . . . . . . . . . . . . . .  AUTO     XDATA  PTR      0001H  2
  buf_ptr. . . . . . . . . . . . . . .  AUTO     XDATA  PTR      0003H  2
  bc_ptr . . . . . . . . . . . . . . .  AUTO     XDATA  PTR      0005H  2
usb_process_get_descriptor . . . . . .  STATIC   CODE   PROC     0000H  -----
_hal_usb_init. . . . . . . . . . . . .  PUBLIC   CODE   PROC     0000H  -----
  usb_disconnect . . . . . . . . . . .  AUTO     DATA   U_CHAR   0007H  1
  device_req . . . . . . . . . . . . .  AUTO     XDATA  PTR      0001H  3
  reset. . . . . . . . . . . . . . . .  AUTO     XDATA  PTR      0004H  3
  resume . . . . . . . . . . . . . . .  AUTO     XDATA  PTR      0007H  3
  suspend. . . . . . . . . . . . . . .  AUTO     XDATA  PTR      000AH  3
RFCON. . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   0090H  1
usbpair. . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7DDH  1
PSW. . . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   00D0H  1
usbfrmh. . . . . . . . . . . . . . . .  PUBLIC   XDATA  U_CHAR   C7D9H  1
uint32_t . . . . . . . . . . . . . . .  TYPEDEF  -----  U_LONG   -----  4
WDCON. . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   00D8H  1
IRCON. . . . . . . . . . . . . . . . .  SFR      DATA   U_CHAR   00C0H  1


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2742    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     71      41
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
